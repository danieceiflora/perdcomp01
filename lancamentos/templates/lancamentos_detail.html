{% extends 'base.html' %}
{% load static %}
{% load utils_filters %}

{% block title %}Detalhes do Lançamento{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <div class="bg-card border rounded-lg shadow-sm">
        <div class="flex items-start justify-between p-6 border-b">
            <div>
                <h1 class="text-2xl font-semibold text-card-foreground mb-1">Detalhes do Lançamento</h1>
                <p class="text-sm text-muted-foreground">Informações e anexos do lançamento selecionado.</p>
            </div>
            <a href="{% url 'lancamentos:list' %}" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors">
                <i class="bi bi-arrow-left mr-2"></i> Voltar
            </a>
        </div>
        <div class="p-6 space-y-10">
            <section>
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2"><i class="bi bi-info-circle"></i> Informações do Lançamento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="text-xs uppercase tracking-wide text-muted-foreground">Aprovação</div>
                                <div class="font-medium">
                                    {% if lancamento.aprovado %}
                                        <span class="inline-flex items-center text-green-600 dark:text-green-400"><i class="bi bi-check2-circle mr-1"></i> Aprovado</span>
                                        {% if lancamento.data_aprovacao %}<span class="text-muted-foreground text-sm ml-2">em {{ lancamento.data_aprovacao|date:"d/m/Y H:i" }}</span>{% endif %}
                                    {% else %}
                                        <span class="inline-flex items-center text-destructive"><i class="bi bi-x-circle mr-1"></i> Não Aprovado pelo cliente</span>
                                    {% endif %}
                                </div>
                                {% if lancamento.observacao_aprovacao %}
                                <div class="mt-1 text-sm text-muted-foreground max-w-prose">{{ lancamento.observacao_aprovacao|linebreaks }}</div>
                                {% endif %}
                            </div>
                            {% if request.user.is_authenticated %}
                            {% if request.user.is_superuser or request.user.is_staff %}
                            {% if not lancamento.aprovado %}
                            <a href="{% url 'lancamentos:aprovar' lancamento.pk %}" class="inline-flex items-center rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium hover:bg-accent hover:text-accent-foreground">
                                <i class="bi bi-pencil-square mr-1"></i> Atualizar
                            </a>
                            {% endif %}
                            {% endif %}
                            {% endif %}
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-muted-foreground">Empresa Cliente</div>
                            <div class="font-medium">{% if lancamento.id_adesao.cliente.id_company_vinculada %}{{ lancamento.id_adesao.cliente.id_company_vinculada.razao_social }}{% else %}--{% endif %}</div>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-muted-foreground">PER/DCOMP Adesão</div>
                            <div class="font-medium">{{ lancamento.id_adesao.perdcomp|default:'--' }}</div>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-muted-foreground">Declaração PER/DCOMP</div>
                            <div class="font-medium">{{ lancamento.perdcomp_declaracao|default:'--' }}</div>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-muted-foreground">Item da Declaração</div>
                            <div class="font-medium">{{ lancamento.item|default:'--' }}</div>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-muted-foreground">Código da Guia</div>
                            <div class="font-medium">{{ lancamento.codigo_guia|default:'--' }}</div>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-muted-foreground">Data do Lançamento</div>
                            <div class="font-medium">{{ lancamento.data_lancamento|date:"d/m/Y" }}</div>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-muted-foreground">Valor do Lançamento</div>
                            <div class="font-semibold {% if lancamento.sinal == '+' %}text-green-600 dark:text-green-400{% else %}text-destructive{% endif %}">{{ lancamento.sinal }} {{ lancamento.valor|br_currency }}</div>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-muted-foreground">Saldo Restante</div>
                            <div class="font-semibold {% if lancamento.saldo_restante > 0 %}text-green-600 dark:text-green-400{% elif lancamento.saldo_restante < 0 %}text-destructive{% endif %}">
                                {% if lancamento.saldo_restante != None %}{{ lancamento.saldo_restante|br_currency }}{% else %}<span class="text-muted-foreground">Não disponível</span>{% endif %}
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <div class="text-xs uppercase tracking-wide text-muted-foreground mb-1">Observação</div>
                            <div class="rounded-md border bg-muted/30 p-3 text-sm leading-relaxed">{{ lancamento.descricao|linebreaks|default:"Nenhuma observação" }}</div>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-muted-foreground">Adesão Relacionada</div>
                            <div class="font-medium"><a class="text-primary hover:underline" href="{% url 'adesao:detail' lancamento.id_adesao.id %}">{{ lancamento.id_adesao.perdcomp }}</a></div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        {% with metodo_raw=lancamento.metodo|default:'' ml=lancamento.metodo|default:''|lower %}
                            {% if metodo_raw %}
                            <div>
                                <div class="text-xs uppercase tracking-wide text-muted-foreground">Tipo de Crédito</div>
                                <div class="font-medium">{{ metodo_raw }}</div>
                            </div>
                            <div class="space-y-3">
                                {% if 'compensacao' in ml or 'compensação' in ml %}
                                    <div>
                                        <div class="text-xs uppercase tracking-wide text-muted-foreground">Total dos Débitos deste Documento</div>
                                        <div class="font-medium">{% if lancamento.total_debitos_documento != None %}{{ lancamento.total_debitos_documento|br_currency }}{% else %}<span class="text-muted-foreground">--</span>{% endif %}</div>
                                    </div>
                                    {% if lancamento.total_credito_original_utilizado != None %}
                                    <div>
                                        <div class="text-xs uppercase tracking-wide text-muted-foreground">Total Crédito Original Utilizado</div>
                                        <div class="font-medium">{{ lancamento.total_credito_original_utilizado|br_currency }}</div>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="text-xs uppercase tracking-wide text-muted-foreground">Período de Apuração</div>
                                        <div class="font-medium">{{ lancamento.periodo_apuracao|default:'--' }}</div>
                                    </div>
                                    {% if lancamento.descricao_debitos %}
                                    <div class="md:col-span-2">
                                        <div class="text-xs uppercase tracking-wide text-muted-foreground mb-1">Descrição dos Débitos</div>
                                        <div class="rounded-md border bg-muted/30 p-3 text-sm leading-relaxed max-h-60 overflow-y-auto">{{ lancamento.descricao_debitos|linebreaks }}</div>
                                    </div>
                                    {% endif %}
                                {% elif 'credito' in ml and 'conta' in ml %}
                                    <div>
                                        <div class="text-xs uppercase tracking-wide text-muted-foreground">Data do Crédito</div>
                                        <div class="font-medium">{% if lancamento.data_credito %}{{ lancamento.data_credito|date:"d/m/Y" }}{% else %}<span class="text-muted-foreground">--</span>{% endif %}</div>
                                    </div>
                                    <div>
                                        <div class="text-xs uppercase tracking-wide text-muted-foreground">Valor creditado</div>
                                        <div class="font-medium">{% if lancamento.valor_credito_em_conta != None %}{{ lancamento.valor_credito_em_conta|br_currency }}{% else %}<span class="text-muted-foreground">--</span>{% endif %}</div>
                                    </div>
                                {% else %}
                                    <div class="text-muted-foreground text-sm">Nenhum detalhe adicional para este tipo de crédito.</div>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </section>

            <section>
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2"><i class="bi bi-file-earmark-check"></i> Informações de Protocolo</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <div class="text-xs uppercase tracking-wide text-muted-foreground">Status do Lançamento</div>
                        <div class="font-medium mt-1">
                            {% if lancamento.status == 'protocolado' %}
                                <span class="inline-flex items-center rounded-md bg-blue-500/10 px-2.5 py-1 text-sm font-medium text-blue-700 dark:text-blue-300">
                                    <i class="bi bi-check-circle-fill mr-1.5"></i>
                                    Protocolado
                                </span>
                            {% elif lancamento.status == 'solicitado' %}
                                <span class="inline-flex items-center rounded-md bg-gray-500/10 px-2.5 py-1 text-sm font-medium text-gray-700 dark:text-gray-300">
                                    <i class="bi bi-clock-history mr-1.5"></i>
                                    Solicitado
                                </span>
                            {% else %}
                                <span class="text-muted-foreground">{{ lancamento.get_status_display|default:'--' }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div class="text-xs uppercase tracking-wide text-muted-foreground">Número de Controle</div>
                        <div class="font-medium font-mono text-sm mt-1">{{ lancamento.numero_controle|default:'--' }}</div>
                    </div>
                    <div>
                        <div class="text-xs uppercase tracking-wide text-muted-foreground">Chave de Segurança SERPRO</div>
                        <div class="font-medium font-mono text-sm mt-1 break-all">{{ lancamento.chave_seguranca_serpro|default:'--' }}</div>
                    </div>
                </div>
                {% if not lancamento.numero_controle and not lancamento.chave_seguranca_serpro %}
                <div class="mt-4 flex items-center gap-2 rounded-md border border-blue-200 bg-blue-50 dark:bg-blue-500/15 dark:border-blue-500/40 px-4 py-3 text-sm text-blue-700 dark:text-blue-300">
                    <i class="bi bi-info-circle-fill"></i>
                    <span>Para atualizar as informações de protocolo, importe o recibo de envio na <a href="{% url 'lancamentos:list' %}" class="underline hover:no-underline font-medium">página de listagem</a>.</span>
                </div>
                {% endif %}
            </section>

            <section>
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2"><i class="bi bi-paperclip"></i> Anexos</h2>
                {% if anexos %}
                <div class="overflow-x-auto rounded-md border">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b bg-muted/50 text-muted-foreground">
                                <th class="h-10 px-4 text-left font-medium">Nome</th>
                                <th class="h-10 px-4 text-left font-medium">Descrição</th>
                                <th class="h-10 px-4 text-left font-medium">Data Upload</th>
                                <th class="h-10 px-4 text-left font-medium">Arquivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for anexo in anexos %}
                            <tr class="border-b last:border-0 hover:bg-muted/50">
                                <td class="px-4 py-3 font-medium">{{ anexo.nome_anexo }}</td>
                                <td class="px-4 py-3">{{ anexo.descricao }}</td>
                                <td class="px-4 py-3">{{ anexo.data_upload|date:"d/m/Y H:i" }}</td>
                                <td class="px-4 py-3">
                                    <a href="{{ anexo.arquivo.url }}" target="_blank" class="inline-flex items-center rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium hover:bg-accent hover:text-accent-foreground transition-colors"><i class="bi bi-file-earmark mr-1"></i>Visualizar</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="flex items-center gap-2 rounded-md border bg-muted/30 px-4 py-3 text-sm text-muted-foreground">
                    <i class="bi bi-info-circle"></i>
                    <span>Nenhum anexo para este lançamento.</span>
                </div>
                {% endif %}
            </section>
        </div>
    </div>
</div>
{% endblock %}
