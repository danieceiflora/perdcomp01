{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.id %}
        Editar Lançamento
    {% else %}
        Novo Lançamento
    {% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col">
            <h1 class="h3">
                {% if form.instance.id %}
                    Editar Lançamento
                {% else %}
                    Novo Lançamento
                {% endif %}
            </h1>
        </div>
        <div class="col text-end">
            <a href="{% url 'lancamentos:list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                {% if form.errors %}
                    <div class="alert alert-danger">
                        Por favor, corrija os erros abaixo.
                    </div>
                {% endif %}

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.adesao.id_for_label }}" class="form-label">Adesão *</label>
                            {{ form.adesao }}
                            {% if form.adesao.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.adesao.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="{{ form.tipo.id_for_label }}" class="form-label">Tipo *</label>
                            {{ form.tipo }}
                            {% if form.tipo.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tipo.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="{{ form.data.id_for_label }}" class="form-label">Data *</label>
                            {{ form.data }}
                            {% if form.data.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.data.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.valor.id_for_label }}" class="form-label">Valor *</label>
                            {{ form.valor }}
                            {% if form.valor.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.valor.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label for="{{ form.descricao.id_for_label }}" class="form-label">Descrição</label>
                            {{ form.descricao }}
                            {% if form.descricao.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.descricao.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <hr>
                
                <h4 class="h5 mb-3">Anexos</h4>
                
                <div id="anexos-formset">
                    {{ anexos_formset.management_form }}
                    
                    {% for form in anexos_formset %}
                        <div class="anexo-form mb-3 border p-3 rounded">
                            {% if form.instance.arquivo %}
                                <div class="mb-2">
                                    <strong>Arquivo atual:</strong> 
                                    <a href="{{ form.instance.arquivo.url }}" target="_blank">
                                        {{ form.instance.arquivo.name|slice:"10:" }}
                                    </a>
                                </div>
                            {% endif %}
                            
                            {{ form.id }}
                            {{ form.DELETE.as_hidden }}
                            
                            <div class="row">
                                <div class="col-md-10">
                                    <div class="mb-2">
                                        <label for="{{ form.arquivo.id_for_label }}" class="form-label">Arquivo</label>
                                        {{ form.arquivo }}
                                        {% if form.arquivo.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.arquivo.errors }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mt-4">
                                        <button type="button" class="btn btn-danger btn-sm remove-anexo">
                                            <i class="bi bi-trash"></i> Remover
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="mb-3">
                    <button type="button" class="btn btn-info" id="add-anexo">
                        <i class="bi bi-plus-circle"></i> Adicionar Anexo
                    </button>
                </div>

                <div class="mt-4 text-end">
                    <a href="{% url 'lancamentos:list' %}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Configurar datepicker
        const dateFields = document.querySelectorAll('input[type="date"]');
        dateFields.forEach(field => {
            if (!field.value) {
                const today = new Date().toISOString().split('T')[0];
                field.value = today;
            }
        });
        
        // Formset para anexos
        const formsetContainer = document.getElementById('anexos-formset');
        const addButton = document.getElementById('add-anexo');
        const totalForms = document.getElementById('id_anexos-TOTAL_FORMS');
        
        // Adicionar novo formulário de anexo
        addButton.addEventListener('click', function() {
            const formCount = parseInt(totalForms.value);
            const newForm = document.createElement('div');
            newForm.className = 'anexo-form mb-3 border p-3 rounded';
            
            newForm.innerHTML = `
                <input type="hidden" name="anexos-${formCount}-id" id="id_anexos-${formCount}-id">
                <input type="hidden" name="anexos-${formCount}-DELETE" id="id_anexos-${formCount}-DELETE">
                
                <div class="row">
                    <div class="col-md-10">
                        <div class="mb-2">
                            <label for="id_anexos-${formCount}-arquivo" class="form-label">Arquivo</label>
                            <input type="file" name="anexos-${formCount}-arquivo" class="form-control" id="id_anexos-${formCount}-arquivo">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mt-4">
                            <button type="button" class="btn btn-danger btn-sm remove-anexo">
                                <i class="bi bi-trash"></i> Remover
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            formsetContainer.appendChild(newForm);
            totalForms.value = formCount + 1;
            
            // Adicionar evento de remoção ao novo botão
            newForm.querySelector('.remove-anexo').addEventListener('click', removeAnexo);
        });
        
        // Função para remover formulário de anexo
        function removeAnexo() {
            const form = this.closest('.anexo-form');
            const deleteInput = form.querySelector('input[name$="-DELETE"]');
            
            if (deleteInput) {
                // Se o formulário já existe no banco, marcar para exclusão
                deleteInput.value = 'on';
                form.style.display = 'none';
            } else {
                // Se é um novo formulário, removê-lo do DOM
                form.remove();
            }
        }
        
        // Adicionar evento de remoção aos botões existentes
        document.querySelectorAll('.remove-anexo').forEach(button => {
            button.addEventListener('click', removeAnexo);
        });
    });
</script>
{% endblock %}
