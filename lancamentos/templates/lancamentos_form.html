{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if object %}Editar Lançamento{% else %}Novo Lançamento{% endif %}
{% endblock %}

{% block extra_head %}
<style>
  .delete-form {opacity:.55; position:relative;}
  .delete-form::after {content:"Será removido após salvar"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(239,68,68,.18); font-size:.75rem; font-weight:500; color:#b91c1c; backdrop-filter:blur(1px);}    
  /* Custom file input wrapper */
  .file-field {position:relative;}
  .file-field input[type=file] {opacity:0; position:absolute; inset:0; width:100%; height:100%; cursor:pointer;}
  .file-field .file-visual {display:flex; align-items:center; gap:.75rem; background:var(--file-bg,#f3f4f6); color:var(--file-fg,#111827); border:1px solid var(--file-border,#d1d5db); border-radius:.5rem; padding:.55rem .9rem; font-size:.75rem; line-height:1.1; min-height:42px;}
  .file-field .file-visual .file-btn {background:var(--file-btn-bg,#e5e7eb); color:var(--file-btn-fg,#111827); border:1px solid var(--file-btn-border,#d1d5db); padding:.35rem .8rem; border-radius:.4rem; font-weight:500; font-size:.7rem; letter-spacing:.5px; text-transform:uppercase; display:inline-flex; align-items:center; gap:.25rem;}
  .file-field .file-visual .file-name {flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:.7rem; opacity:.85;}
  .file-field .file-visual:focus-within {outline:2px solid var(--file-focus,#2563eb); outline-offset:2px;}
  .file-field:hover .file-visual {background:var(--file-bg-hover,#e5e7eb);}  
  /* Dark mode overrides */
  :root.dark .file-field .file-visual, .dark .file-field .file-visual, body.dark .file-field .file-visual {--file-bg:#1f2937; --file-fg:#f3f4f6; --file-border:#374151; --file-bg-hover:#273549;}
  :root.dark .file-field .file-visual .file-btn, .dark .file-field .file-visual .file-btn, body.dark .file-field .file-visual .file-btn {--file-btn-bg:#374151; --file-btn-fg:#f3f4f6; --file-btn-border:#4b5563;}
  :root.dark .file-field .file-visual .file-name, .dark .file-field .file-visual .file-name, body.dark .file-field .file-visual .file-name {opacity:.9;}
  .file-field .file-visual .file-btn:hover {filter:brightness(1.05);}    
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <div class="bg-card border rounded-lg shadow-sm">
        <div class="p-6 border-b flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-semibold text-card-foreground">{% if object %}Editar Lançamento{% else %}Novo Lançamento{% endif %}</h1>
                <p class="text-sm text-muted-foreground">Preencha os dados do lançamento e anexe documentos.</p>
            </div>
            <a href="{% url 'lancamentos:list' %}" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors">
                <i class="bi bi-arrow-left mr-2"></i> Voltar
            </a>
        </div>

        {% if user.is_staff or user.is_superuser %}
        <!-- Área de importação de documentos -->
        <div class="p-6 border-b bg-muted/10">
            <div class="flex flex-col gap-4">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-card-foreground">Importar Documentos de Lançamento</h2>
                        <p class="text-sm text-muted-foreground">Carregue declarações de compensação ou notificações de crédito em conta em PDF. O sistema detecta automaticamente o tipo de documento.</p>
                    </div>
                    <button type="button" id="importToggleButton" aria-controls="importDropZoneContainer" aria-expanded="false"
                            class="inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-2 text-sm font-medium text-card-foreground transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                        <i class="bi bi-chevron-down mr-2" aria-hidden="true"></i>
                        Expandir área
                    </button>
                </div>
                <div id="importDropZoneContainer" class="transition-all duration-200 hidden" aria-hidden="true">
                    <div class="flex flex-col gap-4">
                        <div id="importDropZone" role="button" tabindex="0"
                             data-compensacao-url="{% url 'adesao:importar_declaracao_compensacao' %}"
                             data-credito-url="{% url 'adesao:importar_credito_conta' %}"
                             class="relative flex flex-col items-center justify-center gap-3 rounded-lg border-2 border-dashed border-border bg-muted/30 p-5 text-center transition-all duration-200 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                            <input type="file" id="importFileInput" accept="application/pdf" class="hidden" multiple />
                            <i class="bi bi-cloud-arrow-up text-3xl text-muted-foreground"></i>
                            <div>
                                <p class="text-sm font-medium text-card-foreground">Arraste PDFs aqui ou clique no botão abaixo</p>
                                <p class="text-xs text-muted-foreground mt-1">Tipos aceitos: Declaração de Compensação • Notificação de Crédito em Conta</p>
                            </div>
                            <button type="button" id="importBrowseButton"
                                    class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium text-card-foreground transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                                Selecionar PDFs
                            </button>
                            <div id="importDropZoneOverlay" class="pointer-events-none absolute inset-0 hidden items-center justify-center rounded-lg bg-background/80 backdrop-blur-sm">
                                <div class="flex items-center gap-2 text-sm text-muted-foreground">
                                    <span class="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"></span>
                                    <span id="importDropZoneOverlayText">Processando arquivos...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Overlay de Progresso para Documentos -->
        <div id="declaracao-processing-overlay" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" role="dialog" aria-modal="true">
            <div class="flex w-full max-w-md flex-col rounded-lg border border-border bg-card text-card-foreground shadow-2xl p-6 sm:p-8" tabindex="-1">
                <div class="mb-6 text-center">
                    <h3 class="text-xl font-semibold mb-2">Processando documentos</h3>
                    <p class="text-sm text-muted-foreground">Aguarde enquanto processamos os documentos PDF.</p>
                </div>
                <div class="flex justify-center mb-6">
                    <div class="relative">
                        <div class="h-16 w-16 rounded-full border-4 border-primary/20"></div>
                        <div class="absolute inset-0 h-16 w-16 rounded-full border-4 border-primary border-t-transparent animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-primary">
                            <i class="bi bi-file-earmark-text text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="mb-2 flex items-center justify-between text-sm text-muted-foreground">
                        <span id="declaracao-overlay-progress-text">0 de 0 processados</span>
                        <span id="declaracao-overlay-progress-percentage">0%</span>
                    </div>
                    <div class="h-3 w-full rounded-full bg-muted/60">
                        <div id="declaracao-overlay-progress-bar" class="relative h-3 w-0 rounded-full bg-primary transition-all duration-300"></div>
                    </div>
                </div>
                <div class="mb-4 rounded-lg bg-muted/40 px-4 py-3 text-center">
                    <p class="text-xs text-muted-foreground">Processando:</p>
                    <p id="declaracao-overlay-current-file" class="truncate text-sm font-medium">—</p>
                </div>
                <div id="declaracao-overlay-success-message" class="hidden rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-700 dark:border-green-500/40 dark:bg-green-500/15 dark:text-green-300">
                    <div class="flex items-center justify-center gap-2 mb-3">
                        <i class="bi bi-check-circle-fill"></i>
                        <span id="declaracao-overlay-success-text" class="font-medium">Processamento concluído!</span>
                    </div>
                    <div class="flex items-center justify-center gap-2 mt-3 pt-3 border-t border-green-300 dark:border-green-500/30">
                        <a href="{% url 'adesao:importacao_logs_page' %}" target="_blank" class="inline-flex items-center gap-1 rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                            <i class="bi bi-clipboard-data"></i>
                            Ver logs de importação
                        </a>
                    </div>
                </div>
                <button id="declaracao-overlay-close-btn" type="button" class="mt-6 hidden inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                    <i class="bi bi-check-lg mr-2"></i>OK, Fechar
                </button>
            </div>
        </div>

        <form id="lancamento-form" method="post" enctype="multipart/form-data" novalidate class="p-6 space-y-8">
                {% csrf_token %}
                
                <!-- Exibir erros gerais (não específicos de um campo) -->
                {% if form.non_field_errors %}
                <div class="rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-sm p-4">
                    <ul class="list-disc list-inside space-y-1">
                        {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Exibir erros do campo oculto 'valor' -->
                {% if form.valor.errors %}
                <div class="rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-sm p-4">
                    <p class="font-medium mb-2">Erro no campo Valor:</p>
                    <ul class="list-disc list-inside space-y-1">
                        {% for error in form.valor.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Campo oculto de valor (quando necessário) -->
                <div class="hidden">
                    <label class="form-label visually-hidden" for="{{ form.valor.id_for_label }}">{{ form.valor.label }}</label>
                    {{ form.valor }}
                </div>

                <!-- Grupo 1: Adesão / Saldo / Sinal -->
                <div class="bg-muted/20 border rounded-md p-4">
                    <h3 class="text-sm font-semibold mb-4 tracking-wide text-muted-foreground">Dados do lançamento</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label for="{{ form.id_adesao.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.id_adesao.label }}</label>
                            {{ form.id_adesao }}
                            {% if form.id_adesao.errors %}<div class="text-sm text-destructive mt-1">{{ form.id_adesao.errors }}</div>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.saldo_atual_adesao.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.saldo_atual_adesao.label }}</label>
                            {{ form.saldo_atual_adesao }}
                            <p class="text-xs text-muted-foreground mt-1">Saldo disponível na adesão selecionada.</p>
                        </div>
                        <div>
                            <label for="{{ form.data_lancamento.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.data_lancamento.label }}</label>
                            {{ form.data_lancamento }}
                            {% if form.data_lancamento.errors %}<div class="text-sm text-destructive mt-1">{{ form.data_lancamento.errors }}</div>{% endif %}
                            <p class="text-xs text-muted-foreground mt-1">{{ form.data_lancamento.help_text }}</p>
                        </div>
                        <div>
                            <label for="{{ form.sinal.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.sinal.label }}</label>
                            {{ form.sinal }}
                            {% if form.sinal.errors %}<div class="text-sm text-destructive mt-1">{{ form.sinal.errors }}</div>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.codigo_guia.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.codigo_guia.label }}</label>
                            {{ form.codigo_guia }}
                            <p class="text-xs text-muted-foreground mt-1">Identificador da guia (opcional).</p>
                            {% if form.codigo_guia.errors %}<div class="text-sm text-destructive mt-1">{{ form.codigo_guia.errors }}</div>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Grupo 2: Tipo de Crédito / Detalhes / Observação -->
                <div class="bg-muted/20 border rounded-md p-4">
                    <h3 class="text-sm font-semibold mb-4 tracking-wide text-muted-foreground">Pedido e tipo de crédito</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-3">
                            <label for="{{ form.metodo_escolhido.id_for_label }}" class="block text-sm font-medium mb-1">Tipo de Crédito</label>
                            {{ form.metodo_escolhido }}
                            {% if form.metodo_escolhido.errors %}<div class="text-sm text-destructive mt-1">{{ form.metodo_escolhido.errors }}</div>{% endif %}
                            <p class="text-xs text-muted-foreground mt-1">Selecione o tipo de crédito para exibir os campos específicos.</p>
                        </div>
                        <div class="md:col-span-3">
                            <div class="border rounded-md p-4">
                                <h4 class="text-sm font-semibold mb-4 tracking-wide text-muted-foreground">Detalhes do tipo de crédito</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <!-- Declaração de Compensação -->
                                    <div id="lanc-group-total_credito_original_utilizado" class="hidden">
                                        <label for="{{ form.lanc_total_credito_original_utilizado.id_for_label }}" class="block text-sm font-medium mb-1">Total do Crédito Original Utilizado</label>
                                        {{ form.lanc_total_credito_original_utilizado }}
                                        <p class="text-xs text-muted-foreground mt-1">Este valor será utilizado para atualizar o saldo da adesão</p>
                                        {% if form.lanc_total_credito_original_utilizado.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_total_credito_original_utilizado.errors }}</div>{% endif %}
                                    </div>
                                    <div id="lanc-group-total_debitos_documento" class="hidden">
                                        <label for="{{ form.lanc_total_debitos_documento.id_for_label }}" class="block text-sm font-medium mb-1">Total dos Débitos deste Documento</label>
                                        {{ form.lanc_total_debitos_documento }}
                                        <p class="text-xs text-muted-foreground mt-1">Valor total dos débitos (apenas para registro)</p>
                                        {% if form.lanc_total_debitos_documento.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_total_debitos_documento.errors }}</div>{% endif %}
                                    </div>
                                    <div id="lanc-group-periodo_apuracao" class="hidden">
                                        <label for="{{ form.lanc_periodo_apuracao.id_for_label }}" class="block text-sm font-medium mb-1">Período de Apuração</label>
                                        {{ form.lanc_periodo_apuracao }}
                                        {% if form.lanc_periodo_apuracao.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_periodo_apuracao.errors }}</div>{% endif %}
                                    </div>
                                    <div id="lanc-group-descricao_debitos" class="hidden md:col-span-3">
                                        <label for="{{ form.lanc_descricao_debitos.id_for_label }}" class="block text-sm font-medium mb-1">Descrição dos Débitos</label>
                                        {{ form.lanc_descricao_debitos }}
                                        <p class="text-xs text-muted-foreground mt-1">Detalhamento dos itens de débito da declaração</p>
                                        {% if form.lanc_descricao_debitos.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_descricao_debitos.errors }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Crédito em Conta -->
                                    <div id="lanc-group-data_credito" class="hidden">
                                        <label for="{{ form.lanc_data_credito.id_for_label }}" class="block text-sm font-medium mb-1">Data do Crédito</label>
                                        {{ form.lanc_data_credito }}
                                        {% if form.lanc_data_credito.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_data_credito.errors }}</div>{% endif %}
                                    </div>
                                    <div id="lanc-group-valor_credito_em_conta" class="hidden">
                                        <label for="{{ form.lanc_valor_credito_em_conta.id_for_label }}" class="block text-sm font-medium mb-1">Valor creditado em conta</label>
                                        {{ form.lanc_valor_credito_em_conta }}
                                        {% if form.lanc_valor_credito_em_conta.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_valor_credito_em_conta.errors }}</div>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-3">
                            <label for="{{ form.descricao.id_for_label }}" class="block text-sm font-medium mb-1">Observação</label>
                            {{ form.descricao }}
                            {% if form.descricao.errors %}<div class="text-sm text-destructive mt-1">{{ form.descricao.errors }}</div>{% endif %}
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Aprovado</label>
                            <select name="aprovado" class="input w-full">
                                <option value="False">Não</option>
                                <option value="True">Sim</option>
                            </select>
                            <p class="text-xs text-muted-foreground mt-1">Se "Sim" for selecionado, o saldo será atualizado no salvamento.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Data de Aprovação</label>
                            <input type="datetime-local" name="data_aprovacao" class="input w-full" />
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium mb-1">Observação da Aprovação</label>
                            <textarea name="observacao_aprovacao" rows="3" class="input w-full" placeholder="Observações sobre a aprovação (opcional)"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Grupo: Informações de Recibo / Protocolo -->
                <div class="bg-muted/20 border rounded-md p-4">
                    <h3 class="text-sm font-semibold mb-4 tracking-wide text-muted-foreground flex items-center gap-2">
                        <i class="bi bi-file-earmark-check"></i>
                        Informações de Recibo / Protocolo
                    </h3>
                    <p class="text-xs text-muted-foreground mb-4">
                        Informações do recibo de envio da declaração. O status padrão para novos lançamentos é "Solicitado". 
                        Você pode informar os dados manualmente ou importar um recibo PDF na lista de lançamentos.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="{{ form.numero_controle.id_for_label }}" class="block text-sm font-medium mb-1">
                                {{ form.numero_controle.label }}
                            </label>
                            {{ form.numero_controle }}
                            {% if form.numero_controle.errors %}
                                <div class="text-xs text-destructive mt-1">
                                    {% for error in form.numero_controle.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ form.chave_seguranca_serpro.id_for_label }}" class="block text-sm font-medium mb-1">
                                {{ form.chave_seguranca_serpro.label }}
                            </label>
                            {{ form.chave_seguranca_serpro }}
                            {% if form.chave_seguranca_serpro.errors %}
                                <div class="text-xs text-destructive mt-1">
                                    {% for error in form.chave_seguranca_serpro.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium mb-1">
                                {{ form.status.label }}
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="text-xs text-destructive mt-1">
                                    {% for error in form.status.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <p class="text-xs text-muted-foreground mt-1">
                                Novos lançamentos: "Solicitado" por padrão
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Grupo: Identificação PERDCOMP e Item -->
                <div class="bg-muted/20 border rounded-md p-4">
                    <h3 class="text-sm font-semibold mb-4 tracking-wide text-muted-foreground flex items-center gap-2">
                        <i class="bi bi-hash"></i>
                        Identificação PERDCOMP
                    </h3>
                    <p class="text-xs text-muted-foreground mb-4">
                        Campos para rastreamento e vinculação de declarações PER/DCOMP. 
                        O PERDCOMP inicial é o da adesão selecionada acima.
                        Geralmente preenchidos automaticamente durante importações.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="{{ form.perdcomp_declaracao.id_for_label }}" class="block text-sm font-medium mb-1">
                                {{ form.perdcomp_declaracao.label }}
                            </label>
                            {{ form.perdcomp_declaracao }}
                            {% if form.perdcomp_declaracao.errors %}
                                <div class="text-xs text-destructive mt-1">
                                    {% for error in form.perdcomp_declaracao.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <p class="text-xs text-muted-foreground mt-1">
                                PERDCOMP da declaração de compensação
                            </p>
                        </div>
                        <div>
                            <label for="{{ form.perdcomp_retificador.id_for_label }}" class="block text-sm font-medium mb-1">
                                {{ form.perdcomp_retificador.label }}
                            </label>
                            {{ form.perdcomp_retificador }}
                            {% if form.perdcomp_retificador.errors %}
                                <div class="text-xs text-destructive mt-1">
                                    {% for error in form.perdcomp_retificador.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <p class="text-xs text-muted-foreground mt-1">
                                PERDCOMP retificador (se houver)
                            </p>
                        </div>
                        <div>
                            <label for="{{ form.item.id_for_label }}" class="block text-sm font-medium mb-1">
                                {{ form.item.label }}
                            </label>
                            {{ form.item }}
                            {% if form.item.errors %}
                                <div class="text-xs text-destructive mt-1">
                                    {% for error in form.item.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <p class="text-xs text-muted-foreground mt-1">
                                Item da declaração
                            </p>
                        </div>
                    </div>
                </div>
                    
                                       
                <!-- Grupo 3: Anexos -->
                <div class="bg-muted/20 border rounded-md p-4">
                    <h4 class="text-base font-semibold border-b pb-2 mb-4 flex items-center gap-2"><i class="bi bi-paperclip"></i> Anexos</h4>
                    <div id="dropzone-anexos" class="mb-4 border-2 border-dashed rounded-md p-6 text-center cursor-pointer transition-colors bg-muted/20 hover:bg-muted/30" style="cursor:pointer;">
                        <div class="flex flex-col items-center gap-2 text-sm text-muted-foreground">
                            <i class="bi bi-cloud-upload text-2xl"></i>
                            <span>Arraste arquivos aqui ou <span class="text-primary font-medium">clique para selecionar</span></span>
                            <span class="text-xs">Formatos aceitos: PDF, imagens, planilhas. Múltiplos arquivos suportados.</span>
                        </div>
                        <input id="hidden-multi-file" type="file" class="hidden" multiple>
                    </div>
                    
                    {{ anexos_formset.management_form }}
                    
                    <div id="anexos-container" class="space-y-4">
                        {% for anexo_form in anexos_formset.forms %}
                        {% if anexo_form.instance.pk or anexo_form.nome_anexo.value or anexo_form.arquivo.value %}
                        <div class="anexo-form {% if anexo_form.instance.pk and anexo_form.DELETE.value %}delete-form{% endif %} bg-muted/20 border rounded-md p-4"
                             data-initial-form="{{ forloop.first|yesno:'true,false' }}">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-medium text-sm">Anexo {% if forloop.counter > 1 %}#{{ forloop.counter }}{% endif %}</h5>
                                <button type="button" class="remove-anexo inline-flex items-center justify-center rounded-md border border-destructive bg-destructive/10 px-2 py-1 text-xs font-medium text-destructive hover:bg-destructive/20 transition-colors">
                                    <i class="bi bi-trash mr-1"></i>Remover
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {% if anexo_form.instance.pk %}
                                <div class="md:col-span-3 text-sm mb-2">
                                    <strong class="font-medium">Anexo atual:</strong>
                                    {% if anexo_form.instance.arquivo %}
                                        <a href="{{ anexo_form.instance.arquivo.url }}" target="_blank">{{ anexo_form.instance.nome_anexo }}</a>
                                    {% else %}
                                        {{ anexo_form.instance.nome_anexo }}
                                    {% endif %}
                                </div>
                                {% endif %}
                                {# Campos ocultos #}
                                {% for hidden in anexo_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                <div>
                                    <label for="{{ anexo_form.arquivo.id_for_label }}" class="block text-sm font-medium mb-1">Arquivo</label>
                                    <div class="file-field" data-file-wrapper>
                                        {{ anexo_form.arquivo }}
                                        <div class="file-visual">
                                            <span class="file-btn"><i class="bi bi-paperclip text-xs"></i> Selecionar</span>
                                            <span class="file-name" data-file-name>{% if anexo_form.instance.pk %}{{ anexo_form.instance.nome_anexo|default:'Arquivo existente' }}{% else %}Nenhum arquivo{% endif %}</span>
                                        </div>
                                    </div>
                                    {% if anexo_form.arquivo.errors %}<div class="text-sm text-destructive mt-1">{{ anexo_form.arquivo.errors }}</div>{% endif %}
                                </div>
                                <div>
                                    <label for="{{ anexo_form.nome_anexo.id_for_label }}" class="block text-sm font-medium mb-1">Nome</label>
                                    {{ anexo_form.nome_anexo }}
                                    {% if anexo_form.nome_anexo.errors %}<div class="text-sm text-destructive mt-1">{{ anexo_form.nome_anexo.errors }}</div>{% endif %}
                                </div>
                                <div>
                                    <label for="{{ anexo_form.descricao.id_for_label }}" class="block text-sm font-medium mb-1">Descrição</label>
                                    {{ anexo_form.descricao }}
                                    {% if anexo_form.descricao.errors %}<div class="text-sm text-destructive mt-1">{{ anexo_form.descricao.errors }}</div>{% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                        
                        <!-- Template form para clonagem via JavaScript (sempre oculto) -->
                        {% with anexos_formset.empty_form as template_form %}
                        <div class="anexo-form bg-muted/20 border rounded-md p-4 hidden" id="template-anexo-form" data-template-form="true">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-medium text-sm">Anexo</h5>
                                <button type="button" class="remove-anexo inline-flex items-center justify-center rounded-md border border-destructive bg-destructive/10 px-2 py-1 text-xs font-medium text-destructive hover:bg-destructive/20 transition-colors">
                                    <i class="bi bi-trash mr-1"></i>Remover
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {# Campos ocultos #}
                                {% for hidden in template_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                <div>
                                    <label for="{{ template_form.arquivo.id_for_label }}" class="block text-sm font-medium mb-1">Arquivo</label>
                                    <div class="file-field" data-file-wrapper>
                                        {{ template_form.arquivo }}
                                        <div class="file-visual">
                                            <span class="file-btn"><i class="bi bi-paperclip text-xs"></i> Selecionar</span>
                                            <span class="file-name" data-file-name>Nenhum arquivo</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="{{ template_form.nome_anexo.id_for_label }}" class="block text-sm font-medium mb-1">Nome</label>
                                    {{ template_form.nome_anexo }}
                                </div>
                                <div>
                                    <label for="{{ template_form.descricao.id_for_label }}" class="block text-sm font-medium mb-1">Descrição</label>
                                    {{ template_form.descricao }}
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                    </div>
                    
                    
                    
                    <div class="flex flex-col sm:flex-row flex-wrap items-stretch sm:items-center gap-3 pt-6 mt-6 border-t w-full">
                        <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground px-6 py-3 text-sm font-medium hover:bg-primary/90 transition-colors min-w-[140px]">
                            <i class="bi bi-check-lg mr-2"></i>Salvar
                        </button>
                        <a href="{% url 'lancamentos:list' %}" class="w-full sm:w-auto inline-flex items-center justify-center rounded-md border border-input bg-background px-6 py-3 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors min-w-[140px]">
                            <i class="bi bi-arrow-left mr-2"></i>Cancelar
                        </a>
                    </div>
            </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Detectar erros de formulário e mostrar modal
    document.addEventListener('DOMContentLoaded', function() {
    const hasFormErrors = JSON.parse('{% if form.errors or form.non_field_errors or anexos_formset.errors or anexos_formset.non_form_errors %}true{% else %}false{% endif %}');
        
        if (hasFormErrors) {
            // String única com separador para evitar conflitos de lint/JS
            const errorMessagesRaw = "{% for error in form.non_field_errors %}{{ error|escapejs }}||{% endfor %}{% for field in form %}{% for error in field.errors %}<strong>{{ field.label|escapejs }}</strong>: {{ error|escapejs }}||{% endfor %}{% endfor %}{% for error in anexos_formset.non_form_errors %}<strong>Anexos</strong>: {{ error|escapejs }}||{% endfor %}";
            const errorMessages = errorMessagesRaw.split('||').filter(Boolean);
            // Inserir erros no modal
            const errorContentEl = document.getElementById('modalErrorContent');
            if (errorContentEl) {
                const errorList = document.createElement('ul');
                errorList.className = 'space-y-2';
                
                errorMessages.forEach(msg => {
                    const li = document.createElement('li');
                    li.innerHTML = msg;
                    li.className = 'mb-2';
                    errorList.appendChild(li);
                });
                
                errorContentEl.innerHTML = '';
                errorContentEl.appendChild(errorList);
                
                // Mostrar o modal
                openErrorModal();
            }
        }
    });
    
    // AJAX submit para preservar arquivos selecionados em caso de erro
    (function(){
        const form = document.getElementById('lancamento-form');
        if(!form) return;
        const submitBtn = form.querySelector('button[type="submit"]');

        function clearErrors(){
            form.querySelectorAll('.ajax-error').forEach(e=>e.remove());
            form.querySelectorAll('.is-invalid').forEach(el=>el.classList.remove('is-invalid'));
        }
        function showError(el, msgs){
            if(!el){
                // tentar container declarado
                const fallback = form.querySelector(`[data-field-error-target="${(msgs && msgs.fieldName)||''}"]`) || form.querySelector(`[data-field-error-target]`);
                if(fallback){
                    fallback.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
                }
                return;
            }
            el.classList.add('is-invalid');
            const div = document.createElement('div');
            div.className = 'ajax-error text-xs text-destructive mt-1';
            div.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
            el.parentElement.appendChild(div);
        }
        function applyErrors(data){
            clearErrors();
            if(!data) return;
            if(data.form){
                Object.entries(data.form.fields||{}).forEach(([field,msgs])=>{
                    const el = form.querySelector(`[name="${field}"]`);
                    if(!el){
                        // procurar container dedicado
                        const container = form.querySelector(`[data-field-error-target="${field}"]`);
                        if(container){
                            container.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
                        }
                    } else {
                        showError(el,msgs);
                    }
                });
                if(data.form.non_field && data.form.non_field.length){
                    const alert = document.createElement('div');
                    alert.className='ajax-error rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-sm p-3 mb-4';
                    alert.innerHTML=data.form.non_field.join('<br>');
                    form.prepend(alert);
                }
            }
            if(Array.isArray(data.anexos)){
                const forms = form.querySelectorAll('#anexos-container .anexo-form');
                data.anexos.forEach((fErr, idx)=>{
                    const frm = forms[idx];
                    if(!frm) return;
                    Object.entries(fErr.fields||{}).forEach(([field,msgs])=>{
                        const fieldEl = frm.querySelector(`[name$='-${field}']`);
                        showError(fieldEl, msgs);
                    });
                    if(fErr.non_field && fErr.non_field.length){
                        const nf = document.createElement('div');
                        nf.className='ajax-error rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-xs p-2 mb-2';
                        nf.innerHTML=fErr.non_field.join('<br>');
                        frm.prepend(nf);
                    }
                });
            }
            if(data.anexos_non_form && data.anexos_non_form.length){
                const alert2 = document.createElement('div');
                alert2.className='ajax-error rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-sm p-3 mb-4';
                alert2.innerHTML=data.anexos_non_form.join('<br>');
                form.prepend(alert2);
            }
        }
    // Submissão tradicional restaurada: nenhum interceptador AJAX aqui.
    })();
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const metodoField = document.getElementById('{{ form.metodo_escolhido.id_for_label }}') || document.querySelector('select[name="metodo_escolhido"]');
        const mapGroups = {
            'declaracao de compensacao': ['lanc-group-total_credito_original_utilizado','lanc-group-total_debitos_documento','lanc-group-periodo_apuracao','lanc-group-descricao_debitos'],
            'credito em conta': ['lanc-group-data_credito','lanc-group-valor_credito_em_conta']
        };
        function norm(v){return (v||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();}
        function hideAll(){document.querySelectorAll('[id^="lanc-group-"]').forEach(el=>el.classList.add('hidden'));}
        function update(){hideAll(); const sel = norm(metodoField.value); const groups = mapGroups[sel]||[]; groups.forEach(id=>{const el=document.getElementById(id); if(el) el.classList.remove('hidden');});}
        if(metodoField){metodoField.addEventListener('change',update); update();}
        
        // Atualizar saldo quando adesão for selecionada
        const adesaoField = document.querySelector('select[name="id_adesao"]');
        const saldoField = document.querySelector('input[name="saldo_atual_adesao"]');
        const adesoesSaldos = JSON.parse('{{ adesoes_saldos|escapejs }}');
        
        function updateSaldo() {
            const adesaoId = adesaoField.value;
            if (adesaoId && adesoesSaldos[adesaoId] !== undefined) {
                const saldo = adesoesSaldos[adesaoId];
                saldoField.value = saldo.toFixed(2);
                saldoField.placeholder = `R$ ${saldo.toFixed(2)}`;
            } else {
                saldoField.value = '';
                saldoField.placeholder = 'Selecione uma adesão...';
            }
        }
        
        if (adesaoField && saldoField) {
            adesaoField.addEventListener('change', updateSaldo);
            // Executar na inicialização se já houver uma adesão selecionada
            updateSaldo();
        }
        // Garantir que o campo de data esteja preenchido corretamente
        const dataField = document.querySelector('input[name="data_lancamento"]');
        if (dataField && !dataField.value) {
            // Se estamos editando e por algum motivo o campo está vazio, preenchemos com a data atual
            const today = new Date().toISOString().split('T')[0];
            dataField.value = today;
        }
        
    // Função para gerenciar o formset de anexos
    const anexosContainer = document.getElementById('anexos-container');
    const addAnexoBtn = document.getElementById('add-anexo');
    const dropzone = document.getElementById('dropzone-anexos');
    const hiddenMultiFile = document.getElementById('hidden-multi-file');
        
        // Pegando o prefixo do formset
        const prefix = '{{ anexos_formset.prefix }}';
        
        // Atualizando os campos quando um novo anexo é adicionado
        const updateElementIndex = function(el, prefix, ndx) {
            const id_regex = new RegExp('(' + prefix + '-\\d+)', 'g');
            const replacement = prefix + '-' + ndx;
            
            // Atualizar todos os elementos input, select, textarea
            el.querySelectorAll('input, select, textarea').forEach((element) => {
                ['id', 'name'].forEach((attr) => {
                    if (element.getAttribute(attr)) {
                        element.setAttribute(attr, element.getAttribute(attr).replace(id_regex, replacement));
                    }
                });
            });
            
            // Atualizando os atributos for de todas as labels dentro deste elemento
            el.querySelectorAll('label').forEach((label) => {
                if (label.getAttribute('for')) {
                    label.setAttribute('for', 
                        label.getAttribute('for').replace(id_regex, replacement)
                    );
                }
            });
            
            // Atualizar qualquer outro atributo que contenha o padrão
            el.querySelectorAll('*').forEach((element) => {
                ['data-target', 'data-toggle', 'aria-describedby'].forEach((attr) => {
                    if (element.getAttribute(attr)) {
                        element.setAttribute(attr, 
                            element.getAttribute(attr).replace(id_regex, replacement)
                        );
                    }
                });
            });
        };
        
        // Função para adicionar um novo anexo
        if(addAnexoBtn){
            addAnexoBtn.addEventListener('click', function(e) {
                e.preventDefault();
                // Reutiliza a mesma lógica de clone do primeiro form
                const formTemplate = anexosContainer.querySelector('.anexo-form');
                if (!formTemplate) return;
                const totalForms = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
                const currentFormCount = parseInt(totalForms.value);
                const newForm = formTemplate.cloneNode(true);
                const anexoAtualDiv = newForm.querySelector('.md-col-span-3.mb-2');
                if (anexoAtualDiv) anexoAtualDiv.remove();
                newForm.querySelectorAll('input, select, textarea').forEach((input) => {
                    if (input.type === 'hidden') {
                        if (input.name && input.name.includes('-id')) input.value = '';
                    } else {
                        input.value = '';
                    }
                });
                newForm.classList.remove('delete-form');
                const headerDiv = newForm.querySelector('.flex.items-center.justify-between.mb-2');
                const titulo = headerDiv.querySelector('h5');
                if (titulo) titulo.textContent = `Anexo #${currentFormCount + 1}`;
                let removeButton = headerDiv.querySelector('.remove-anexo');
                if (!removeButton) {
                    removeButton = document.createElement('button');
                    removeButton.type = 'button';
                    removeButton.className = 'remove-anexo inline-flex items-center justify-center rounded-md border border-destructive bg-destructive/10 px-2 py-1 text-xs font-medium text-destructive hover:bg-destructive/20 transition-colors';
                    removeButton.innerHTML = '<i class="bi bi-trash mr-1"></i>Remover';
                    headerDiv.appendChild(removeButton);
                }
                updateElementIndex(newForm, prefix, currentFormCount);
                totalForms.value = currentFormCount + 1;
                anexosContainer.appendChild(newForm);
                updateAnexoNumbers();
                setupRemoveButtons();
            });
        }
        
        // Função para remover anexo
        function setupRemoveButtons() {
            document.querySelectorAll('.remove-anexo').forEach(button => {
                // Remover event listeners antigos para evitar duplicação
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                newButton.addEventListener('click', function() {
                    // Encontrar o form pai
                    const anexoForm = this.closest('.anexo-form');
                    
                    // Verificar se é um anexo existente com campo DELETE
                    const deleteField = anexoForm.querySelector('input[name$="-DELETE"]');
                    if (deleteField) {
                        // Marcar para exclusão e ocultar visualmente
                        deleteField.value = 'on';
                        anexoForm.classList.add('delete-form');
                        anexoForm.style.display = 'none';
                    } else {
                        // Se for um novo anexo, remover completamente do DOM
                        anexoForm.remove();
                        
                        // Atualizar os índices dos formsets
                        const forms = document.querySelectorAll('.anexo-form');
                        const totalForms = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
                        totalForms.value = forms.length;
                        
                        // Atualizar os índices de cada formset
                        forms.forEach((form, idx) => {
                            updateElementIndex(form, prefix, idx);
                        });
                        
                        // Atualizar a numeração dos anexos
                        updateAnexoNumbers();
                    }
                });
            });
        }
        
        // Função para atualizar a numeração dos anexos
        function updateAnexoNumbers() {
            const anexoForms = document.querySelectorAll('.anexo-form:not([data-template-form])');
            anexoForms.forEach((form, index) => {
                const heading = form.querySelector('h5');
                if (heading) {
                    heading.textContent = `Anexo #${index + 1}`;
                }
            });
        }
        
        // Configurar botões de remoção ao carregar a página
    setupRemoveButtons();

        // -------- Drag & Drop --------
        function highlight(on){
            if(!dropzone) return; dropzone.classList.toggle('ring-2', on); dropzone.classList.toggle('ring-primary/50', on);
        }

        function createFormForFile(file){
            // Usar o template dedicado
            const templateForm = document.getElementById('template-anexo-form');
            if(!templateForm) return;
            
            const totalForms = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
            const currentIndex = parseInt(totalForms.value);
            
            // Clonar o template
            const formEl = templateForm.cloneNode(true);
            formEl.classList.remove('hidden');
            formEl.removeAttribute('id');
            formEl.removeAttribute('data-template-form');
            
            // Atualizar índices
            updateElementIndex(formEl, prefix, currentIndex);
            totalForms.value = currentIndex + 1;
            
            // Anexar ao container
            anexosContainer.appendChild(formEl);
            
            // Configurar o arquivo no input
            const inputFile = formEl.querySelector('input[type="file"]');
            if(inputFile){
                // Criar um DataTransfer para setar o File (somente navegadores modernos)
                const dt = new DataTransfer();
                dt.items.add(file);
                inputFile.files = dt.files;
                // Disparar evento change para atualizar qualquer listener e UI
                try { inputFile.dispatchEvent(new Event('change', { bubbles: true })); } catch(_) {}
            }
            
            // Preencher nome do anexo automaticamente
            const nomeInput = formEl.querySelector('input[name$="-nome_anexo"]');
            if(nomeInput && !nomeInput.value){ 
                nomeInput.value = file.name; 
            }
            
            // Atualizar o wrapper do arquivo para mostrar o nome do arquivo
            const fileWrapper = formEl.querySelector('[data-file-wrapper]');
            if(fileWrapper) {
                updateSingleWrapper(fileWrapper);
                const nameSpan = fileWrapper.querySelector('[data-file-name]');
                if(nameSpan) { nameSpan.textContent = file.name; }
            }
            
            // Atualizar numeração e botões
            updateAnexoNumbers();
            setupRemoveButtons();
            
            // Re-bind file wrappers para o novo form
            bindFileWrappers(formEl);
        }
        function handleFiles(files){
            const added = [];
            const failed = [];
            [...files].forEach(f=>{
                try {
                    createFormForFile(f);
                    added.push(f.name);
                } catch(err){
                    failed.push(f.name);
                }
            });
            // contador removido
            showAnexoFeedback(added, failed);
        }
        if(dropzone){
            ['dragenter','dragover'].forEach(evt=>dropzone.addEventListener(evt, e=>{e.preventDefault(); e.stopPropagation(); highlight(true);}));
            ['dragleave','drop'].forEach(evt=>dropzone.addEventListener(evt, e=>{e.preventDefault(); e.stopPropagation(); if(evt==='dragleave') highlight(false);}));
            dropzone.addEventListener('drop', e=>{highlight(false); if(e.dataTransfer?.files){ handleFiles(e.dataTransfer.files); }});
            dropzone.addEventListener('click', ()=> hiddenMultiFile?.click());
        }
        if(hiddenMultiFile){
            hiddenMultiFile.addEventListener('change', e=>{ handleFiles(e.target.files); hiddenMultiFile.value=''; });
        }
        // Atualiza contador também após remoções
    // contador removido - sem observer

        // Modal de feedback de anexos
        function ensureAnexoModal(){
            let modal = document.getElementById('anexoFeedbackModal');
            if(modal) return modal;
            modal = document.createElement('div');
            modal.id='anexoFeedbackModal';
            modal.className='fixed inset-0 z-50 hidden';
            modal.innerHTML = `
                <div class="absolute inset-0 bg-black/60" data-overlay></div>
                <div class="relative z-10 max-w-md w-full mx-auto mt-24 bg-card border rounded-lg shadow-lg overflow-hidden">
                    <div class="flex items-center justify-between px-5 py-3 border-b">
                        <h3 class="text-sm font-semibold flex items-center gap-2"><i class="bi bi-files"></i> Anexos</h3>
                        <button type="button" data-close class="p-1 rounded hover:bg-muted">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div class="p-5 space-y-4 text-sm" id="anexoFeedbackBody"></div>
                    <div class="px-5 py-3 border-t flex justify-end">
                        <button type="button" data-close class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-xs font-medium hover:bg-accent hover:text-accent-foreground">Fechar</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.addEventListener('click', e=>{ if(e.target.dataset.overlay!==undefined || e.target.closest('[data-close]')) closeAnexoModal(); });
            document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAnexoModal(); });
            return modal;
        }
        function openAnexoModal(){ const m=ensureAnexoModal(); m.classList.remove('hidden'); document.body.style.overflow='hidden'; }
        function closeAnexoModal(){ const m=document.getElementById('anexoFeedbackModal'); if(m){ m.classList.add('hidden'); document.body.style.overflow=''; } }
        function showAnexoFeedback(added, failed){
            if(!added.length && !failed.length) return;
            const modal = ensureAnexoModal();
            const body = modal.querySelector('#anexoFeedbackBody');
            let html='';
            if(added.length){
                html += `<div class="rounded-md border border-emerald-500/40 bg-emerald-500/10 p-3"><div class="font-medium text-emerald-600 text-xs mb-1 flex items-center gap-1"><i class='bi bi-check2-circle'></i> Adicionados</div><ul class='text-emerald-700 list-disc ml-4 space-y-1'>${added.map(a=>`<li>${a}</li>`).join('')}</ul></div>`;
            }
            if(failed.length){
                html += `<div class="rounded-md border border-destructive/40 bg-destructive/10 p-3"><div class="font-medium text-destructive text-xs mb-1 flex items-center gap-1"><i class='bi bi-exclamation-triangle'></i> Falharam</div><ul class='text-destructive list-disc ml-4 space-y-1'>${failed.map(a=>`<li>${a}</li>`).join('')}</ul></div>`;
            }
            body.innerHTML = html;
            openAnexoModal();
        }

        // Atualiza nomes de arquivos exibidos nos wrappers custom
        function updateSingleWrapper(wrapper){
            const input = wrapper.querySelector('input[type=file]');
            const nameSpan = wrapper.querySelector('[data-file-name]');
            if(!input || !nameSpan) return;
            if(input.files && input.files.length){
                nameSpan.textContent = input.files.length === 1 ? input.files[0].name : input.files.length + ' arquivos selecionados';
            } else {
                nameSpan.textContent = 'Nenhum arquivo';
            }
        }
        function bindFileWrappers(scope=document){
            scope.querySelectorAll('[data-file-wrapper]').forEach(wrapper=>{
                const input = wrapper.querySelector('input[type=file]');
                if(!input || wrapper.dataset.bound) return;
                wrapper.dataset.bound = '1';
                input.addEventListener('change', ()=> updateSingleWrapper(wrapper));
                updateSingleWrapper(wrapper);
            });
        }
        bindFileWrappers();
        // Re-bind after dynamic add (MutationObserver)
        const mo = new MutationObserver(()=> bindFileWrappers());
        mo.observe(document.getElementById('anexos-container'), {childList:true, subtree:true});
    });

        // Tailwind Error Modal (light replacement for bootstrap)
        function openErrorModal(){
                let modal=document.getElementById('errorModalTW');
                if(!modal){
                        modal=document.createElement('div');
                        modal.id='errorModalTW';
                        modal.className='fixed inset-0 z-50 flex items-center justify-center p-4';
                        modal.innerHTML=`<div class="absolute inset-0 bg-black/60" data-overlay></div>
                                <div class="relative z-10 w-full max-w-lg bg-card border rounded-lg shadow-lg overflow-hidden">
                                    <div class="flex items-center justify-between px-6 py-4 border-b bg-destructive/10">
                                        <h3 class="text-lg font-semibold text-destructive flex items-center gap-2"><i class="bi bi-exclamation-triangle-fill"></i> Erro no Formulário</h3>
                                        <button type="button" class="rounded-md p-2 hover:bg-muted" data-close><i class="bi bi-x"></i></button>
                                    </div>
                                    <div class="p-6 max-h-[60vh] overflow-y-auto text-sm" id="modalErrorContent"></div>
                                    <div class="flex justify-end px-6 py-4 border-t">
                                        <button type="button" data-close class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground">Fechar</button>
                                    </div>
                                </div>`;
                        document.body.appendChild(modal);
                        modal.addEventListener('click',e=>{if(e.target.dataset.overlay!==undefined||e.target.closest('[data-close]')){closeErrorModal();}});
                        document.addEventListener('keydown', escHandler);
                }
                modal.classList.remove('hidden');
                document.body.style.overflow='hidden';
        }
        function closeErrorModal(){
                const modal=document.getElementById('errorModalTW');
                if(modal){modal.classList.add('hidden'); document.body.style.overflow='';}
        }
        function escHandler(e){ if(e.key==='Escape'){ closeErrorModal(); } }

// ====== DRAG AND DROP PARA DECLARAÇÃO DE COMPENSAÇÃO ======
document.addEventListener('DOMContentLoaded', () => {
    const overlayEls = {
        root: document.getElementById('declaracao-processing-overlay'),
        currentFile: document.getElementById('declaracao-overlay-current-file'),
        closeBtn: document.getElementById('declaracao-overlay-close-btn'),
        successMessage: document.getElementById('declaracao-overlay-success-message'),
        successText: document.getElementById('declaracao-overlay-success-text'),
        progressText: document.getElementById('declaracao-overlay-progress-text'),
        progressPercentage: document.getElementById('declaracao-overlay-progress-percentage'),
        progressBar: document.getElementById('declaracao-overlay-progress-bar'),
    };

    let processedCount = 0;
    let totalCount = 0;
    let successCount = 0;
    let errorCount = 0;
    let results = [];

    function resetOverlay() {
        processedCount = 0;
        totalCount = 0;
        successCount = 0;
        errorCount = 0;
        results = [];
        
        if (overlayEls.currentFile) overlayEls.currentFile.textContent = '—';
        if (overlayEls.successMessage) overlayEls.successMessage.classList.add('hidden');
        if (overlayEls.closeBtn) overlayEls.closeBtn.classList.add('hidden');
        if (overlayEls.progressText) overlayEls.progressText.textContent = '0 de 0 processados';
        if (overlayEls.progressPercentage) overlayEls.progressPercentage.textContent = '0%';
        if (overlayEls.progressBar) overlayEls.progressBar.style.width = '0%';
    }

    function updateProgress() {
        const percentage = totalCount > 0 ? Math.round((processedCount / totalCount) * 100) : 0;
        
        if (overlayEls.progressText) {
            overlayEls.progressText.textContent = `${processedCount} de ${totalCount} processado${totalCount !== 1 ? 's' : ''}`;
        }
        if (overlayEls.progressPercentage) {
            overlayEls.progressPercentage.textContent = `${percentage}%`;
        }
        if (overlayEls.progressBar) {
            overlayEls.progressBar.style.width = `${percentage}%`;
        }
    }

    function showOverlay(fileCount) {
        if (!overlayEls.root) return;
        resetOverlay();
        totalCount = fileCount;
        overlayEls.root.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        updateProgress();
    }

    function showFinalResult() {
        if (!overlayEls.root) return;
        
        if (overlayEls.currentFile) {
            overlayEls.currentFile.textContent = 'Processamento concluído!';
        }
        
        if (overlayEls.successText) {
            overlayEls.successText.textContent = `${successCount} arquivo${successCount !== 1 ? 's' : ''} processado${successCount !== 1 ? 's' : ''} com sucesso${errorCount > 0 ? `, ${errorCount} com erro${errorCount !== 1 ? 's' : ''}` : ''}`;
        }
        
        if (overlayEls.successMessage) {
            overlayEls.successMessage.classList.remove('hidden');
        }
        
        if (overlayEls.closeBtn) {
            overlayEls.closeBtn.classList.remove('hidden');
            overlayEls.closeBtn.focus();
        }
    }

    function closeOverlay() {
        if (overlayEls.root) {
            overlayEls.root.classList.add('hidden');
            document.body.style.overflow = '';
        }
        // Recarregar página após fechar para mostrar novos lançamentos
        if (successCount > 0) {
            window.location.reload();
        }
    }

    if (overlayEls.closeBtn) {
        overlayEls.closeBtn.addEventListener('click', closeOverlay);
    }

    if (overlayEls.root) {
        overlayEls.root.addEventListener('click', (e) => {
            if (e.target === overlayEls.root && overlayEls.closeBtn && !overlayEls.closeBtn.classList.contains('hidden')) {
                closeOverlay();
            }
        });
    }

    // Toggle expand/collapse
    const toggleButton = document.getElementById('importToggleButton');
    const container = document.getElementById('importDropZoneContainer');
    
    if (toggleButton && container) {
        toggleButton.addEventListener('click', () => {
            const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
            toggleButton.setAttribute('aria-expanded', !isExpanded);
            container.setAttribute('aria-hidden', isExpanded);
            container.classList.toggle('hidden');
            
            const icon = toggleButton.querySelector('i');
            if (icon) {
                icon.classList.toggle('bi-chevron-down', isExpanded);
                icon.classList.toggle('bi-chevron-up', !isExpanded);
            }
            toggleButton.innerHTML = isExpanded 
                ? '<i class="bi bi-chevron-down mr-2" aria-hidden="true"></i>Expandir área'
                : '<i class="bi bi-chevron-up mr-2" aria-hidden="true"></i>Recolher área';
        });
    }
    
    const dropzone = document.getElementById('importDropZone');
    const fileInput = document.getElementById('importFileInput');
    const browseButton = document.getElementById('importBrowseButton');
    
    if (!dropzone || !fileInput) return;
    
    const compensacaoUrl = dropzone.getAttribute('data-compensacao-url');
    const creditoUrl = dropzone.getAttribute('data-credito-url');
    
    function getCookie(name) {
        const cookies = document.cookie ? document.cookie.split('; ') : [];
        for (let i = 0; i < cookies.length; i++) {
            const parts = cookies[i].split('=');
            if (decodeURIComponent(parts[0]) === name) {
                parts.shift();
                return decodeURIComponent(parts.join('='));
            }
        }
        return null;
    }
    
    const normalizeText = (value) => {
        if (!value) return '';
        let normalized = value;
        if (typeof normalized.normalize === 'function') {
            normalized = normalized.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }
        return normalized.toLowerCase();
    };
    
    const detectPdfType = (file) => new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const buffer = reader.result;
                let rawText = '';
                if (buffer instanceof ArrayBuffer) {
                    if (typeof TextDecoder !== 'undefined') {
                        const decoder = new TextDecoder('latin1', { fatal: false });
                        rawText = decoder.decode(buffer);
                    } else {
                        rawText = Array.from(new Uint8Array(buffer)).map((byte) => String.fromCharCode(byte)).join('');
                    }
                } else if (typeof buffer === 'string') {
                    rawText = buffer;
                }
                const normalized = normalizeText(rawText);
                
                // DEBUG: Log para diagnóstico
                console.log('=== DEBUG PDF DETECTION ===');
                console.log('Arquivo:', file.name);
                console.log('Tamanho buffer:', buffer.byteLength || buffer.length);
                console.log('Primeiros 1000 chars do rawText:', rawText.substring(0, 1000));
                console.log('Primeiros 1000 chars normalizados:', normalized.substring(0, 1000));
                console.log('Contém "Aviso" (raw)?', rawText.includes('Aviso'));
                console.log('Contém "aviso" (normalized)?', normalized.includes('aviso'));
                console.log('Contém "pagamento" (normalized)?', normalized.includes('pagamento'));
                console.log('Contém "ressarcimento" (normalized)?', normalized.includes('ressarcimento'));
                
                // Detectar crédito em conta
                if (normalized.includes('aviso de pagamento de ressarcimento')) {
                    console.log('✓ DETECTADO: Crédito em conta (aviso de pagamento)');
                    resolve('credito');
                    return;
                }
                
                // Detectar declaração de compensação
                if (normalized.includes('declaracao de compensacao') || normalized.includes('per/dcomp inicial')) {
                    console.log('✓ DETECTADO: Declaração de compensação');
                    resolve('compensacao');
                    return;
                }
                
                console.log('⚠ Tipo não detectado - usando fallback (null)');
                console.log('Patterns buscados:');
                console.log('  - aviso de pagamento de ressarcimento');
                console.log('  - declaracao de compensacao');
                console.log('  - per/dcomp inicial');
                console.log('========================');
            } catch (error) {
                console.warn('Falha ao analisar PDF para detecção automática:', error);
            }
            resolve(null);
        };
        reader.onerror = () => {
            console.warn('Falha ao ler PDF para detecção automática.');
            resolve(null);
        };
        reader.readAsArrayBuffer(file);
    });
    
    async function uploadFile(file, uploadUrl) {
        const csrfToken = getCookie('csrftoken');
        const formData = new FormData();
        formData.append('pdf', file);
        
        if (overlayEls.currentFile) {
            overlayEls.currentFile.textContent = file.name;
        }
        
        try {
            const response = await fetch(uploadUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData,
            });
            
            const data = await response.json();
            
            processedCount++;
            updateProgress();
            
            if (response.ok && data.ok) {
                successCount++;
                results.push({
                    file: file.name,
                    success: true,
                    data: data
                });
            } else {
                errorCount++;
                results.push({
                    file: file.name,
                    success: false,
                    error: data.error || `Erro ${response.status}`
                });
            }
            
        } catch (error) {
            processedCount++;
            errorCount++;
            updateProgress();
            results.push({
                file: file.name,
                success: false,
                error: error.message
            });
        }
    }
    
    async function processFiles(files) {
        if (!files || files.length === 0) return;
        
        const pdfFiles = Array.from(files).filter(f => 
            f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf')
        );
        
        if (pdfFiles.length === 0) {
            alert('Nenhum arquivo PDF encontrado');
            return;
        }
        
        const csrfToken = getCookie('csrftoken');
        if (!csrfToken) {
            alert('Token CSRF não encontrado. Recarregue a página e tente novamente.');
            return;
        }
        
        showOverlay(pdfFiles.length);
        
        // Processar arquivos sequencialmente com detecção automática de tipo
        for (const file of pdfFiles) {
            const pdfType = await detectPdfType(file);
            
            let uploadUrl = null;
            if (pdfType === 'credito') {
                uploadUrl = creditoUrl;
            } else if (pdfType === 'compensacao') {
                uploadUrl = compensacaoUrl;
            } else {
                // Fallback: tentar como declaração de compensação
                uploadUrl = compensacaoUrl;
            }
            
            if (uploadUrl) {
                await uploadFile(file, uploadUrl);
            } else {
                processedCount++;
                errorCount++;
                updateProgress();
                results.push({
                    file: file.name,
                    success: false,
                    error: 'Tipo de documento não reconhecido'
                });
            }
        }
        
        showFinalResult();
    }
    
    // Click to browse
    if (browseButton) {
        browseButton.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });
    }
    
    dropzone.addEventListener('click', (e) => {
        if (e.target === browseButton || browseButton.contains(e.target)) return;
        fileInput.click();
    });
    
    // Drag events
    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('border-primary', 'bg-primary/5');
    });
    
    dropzone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropzone.classList.remove('border-primary', 'bg-primary/5');
    });
    
    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('border-primary', 'bg-primary/5');
        
        const files = e.dataTransfer?.files;
        if (files && files.length > 0) {
            processFiles(files);
        }
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) {
            processFiles(e.target.files);
            fileInput.value = '';
        }
    });
});
</script>
{% endblock %}
