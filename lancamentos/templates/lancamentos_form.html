{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if object %}Editar Lançamento{% else %}Novo Lançamento{% endif %}
{% endblock %}

{% block extra_head %}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <div class="bg-card border rounded-lg shadow-sm">
        <div class="p-6 border-b flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-semibold text-card-foreground">{% if object %}Editar Lançamento{% else %}Novo Lançamento{% endif %}</h1>
                <p class="text-sm text-muted-foreground">Preencha os dados do lançamento e anexe documentos.</p>
            </div>
            <a href="{% url 'lancamentos:list' %}" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors">
                <i class="bi bi-arrow-left mr-2"></i> Voltar
            </a>
        </div>
        <form id="lancamento-form" method="post" enctype="multipart/form-data" novalidate class="p-6 space-y-8">
                {% csrf_token %}
                
                <!-- Exibir erros gerais (não específicos de um campo) -->
                {% if form.non_field_errors %}
                <div class="rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-sm p-4">
                    <ul class="list-disc list-inside space-y-1">
                        {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Campo Valor ocultado do front: mantém input para submissão -->
                <div class="hidden">
                    <label class="form-label visually-hidden" for="{{ form.valor.id_for_label }}">{{ form.valor.label }}</label>
                    {{ form.valor }}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-5">
                                                <div>
                                                        <label for="{{ form.id_adesao.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.id_adesao.label }}</label>
                                                        {{ form.id_adesao }}
                                                        {% if form.id_adesao.errors %}<div class="text-sm text-destructive mt-1">{{ form.id_adesao.errors }}</div>{% endif %}
                                                </div>
                        <div>
                            <label for="{{ form.saldo_atual_adesao.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.saldo_atual_adesao.label }}</label>
                            {{ form.saldo_atual_adesao }}
                            <p class="text-xs text-muted-foreground mt-1">Saldo disponível na adesão selecionada.</p>
                        </div>
                                                <div>
                                                        <label for="{{ form.metodo_escolhido.id_for_label }}" class="block text-sm font-medium mb-1">Método</label>
                                                        {{ form.metodo_escolhido }}
                                                        {% if form.metodo_escolhido.errors %}<div class="text-sm text-destructive mt-1">{{ form.metodo_escolhido.errors }}</div>{% endif %}
                                                        <p class="text-xs text-muted-foreground mt-1">Selecione o método para exibir os campos específicos.</p>
                                                </div>
                                                <div>
                                                        <label for="{{ form.data_lancamento.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.data_lancamento.label }}</label>
                                                        {{ form.data_lancamento }}
                                                        {% if form.data_lancamento.errors %}<div class="text-sm text-destructive mt-1">{{ form.data_lancamento.errors }}</div>{% endif %}
                                                        <p class="text-xs text-muted-foreground mt-1">{{ form.data_lancamento.help_text }}</p>
                                                </div>
                    </div>
                    <div class="space-y-5">
                                                <div>
                                                        <label for="{{ form.tipo.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.tipo.label }}</label>
                                                        {{ form.tipo }}
                                                        {% if form.tipo.errors %}<div class="text-sm text-destructive mt-1">{{ form.tipo.errors }}</div>{% endif %}
                                                </div>
                                                <div class="md:w-1/3">
                                                        <label for="{{ form.sinal.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.sinal.label }}</label>
                                                        {{ form.sinal }}
                                                        {% if form.sinal.errors %}<div class="text-sm text-destructive mt-1">{{ form.sinal.errors }}</div>{% endif %}
                                                </div>
                    </div>
                </div>
                
                <!-- Seção dinâmica: Detalhes do método -->
                <div class="bg-muted/20 border rounded-md p-4">
                    <h3 class="text-sm font-semibold mb-4 tracking-wide text-muted-foreground">Detalhes do método</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Pedido de restituição -->
                                                        <div id="lanc-group-total_credito_original_utilizado" class="hidden">
                                                                <label for="{{ form.lanc_total_credito_original_utilizado.id_for_label }}" class="block text-sm font-medium mb-1">Total Crédito Original Utilizado</label>
                                                                {{ form.lanc_total_credito_original_utilizado }}
                                                                {% if form.lanc_total_credito_original_utilizado.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_total_credito_original_utilizado.errors }}</div>{% endif %}
                                                        </div>
                                                        <div id="lanc-group-debito" class="hidden">
                                                                <label for="{{ form.lanc_debito.id_for_label }}" class="block text-sm font-medium mb-1">Débito</label>
                                                                {{ form.lanc_debito }}
                                                                {% if form.lanc_debito.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_debito.errors }}</div>{% endif %}
                                                        </div>
                                                        <div id="lanc-group-periodo_apuracao" class="hidden">
                                                                <label for="{{ form.lanc_periodo_apuracao.id_for_label }}" class="block text-sm font-medium mb-1">Período de Apuração</label>
                                                                {{ form.lanc_periodo_apuracao }}
                                                                {% if form.lanc_periodo_apuracao.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_periodo_apuracao.errors }}</div>{% endif %}
                                                        </div>
                            <!-- Pedido de ressarcimento -->
                                                        <div id="lanc-group-debito_r" class="hidden">
                                                                <label for="{{ form.lanc_debito_r.id_for_label }}" class="block text-sm font-medium mb-1">Débito</label>
                                                                {{ form.lanc_debito_r }}
                                                                {% if form.lanc_debito_r.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_debito_r.errors }}</div>{% endif %}
                                                        </div>
                                                        <div id="lanc-group-periodo_apuracao_r" class="hidden">
                                                                <label for="{{ form.lanc_periodo_apuracao_r.id_for_label }}" class="block text-sm font-medium mb-1">Período de Apuração</label>
                                                                {{ form.lanc_periodo_apuracao_r }}
                                                                {% if form.lanc_periodo_apuracao_r.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_periodo_apuracao_r.errors }}</div>{% endif %}
                                                        </div>
                                                        <div id="lanc-group-total_r" class="hidden">
                                                                <label for="{{ form.lanc_total_r.id_for_label }}" class="block text-sm font-medium mb-1">Total</label>
                                                                {{ form.lanc_total_r }}
                                                                {% if form.lanc_total_r.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_total_r.errors }}</div>{% endif %}
                                                        </div>
                    </div>
                </div>

                                <div>
                                        <label for="{{ form.descricao.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.descricao.label }}</label>
                                        {{ form.descricao }}
                                        {% if form.descricao.errors %}<div class="text-sm text-destructive mt-1">{{ form.descricao.errors }}</div>{% endif %}
                                </div>
                    
                                       
                    <h4 class="text-lg font-semibold border-b pb-2 mb-4 flex items-center gap-2"><i class="bi bi-paperclip"></i> Anexos</h4>
                    
                    {{ anexos_formset.management_form }}
                    
                    <div id="anexos-container">
                        {% for anexo_form in anexos_formset.forms %}
                            <div class="anexo-form {% if anexo_form.instance.pk and anexo_form.DELETE.value %}delete-form{% endif %} bg-muted/30 border rounded-md p-4 mb-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {% if anexo_form.instance.pk %}
                                    <div class="md:col-span-3 text-sm mb-2">
                                        <strong class="font-medium">Anexo atual:</strong> 
                                        {% if anexo_form.instance.arquivo %}
                                            <a href="{{ anexo_form.instance.arquivo.url }}" target="_blank">{{ anexo_form.instance.nome_anexo }}</a>
                                        {% else %}
                                            {{ anexo_form.instance.nome_anexo }}
                                        {% endif %}
                                        
                                       
                                    </div>
                                    {% endif %}
                                
                                    <!-- Campos ocultos -->
                                    {% for hidden in anexo_form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                
                                                                        <div>
                                                                                <label for="{{ anexo_form.arquivo.id_for_label }}" class="block text-sm font-medium mb-1">Arquivo</label>
                                                                                {{ anexo_form.arquivo }}
                                                                                {% if anexo_form.arquivo.errors %}<div class="text-sm text-destructive mt-1">{{ anexo_form.arquivo.errors }}</div>{% endif %}
                                                                        </div>
                                                                        <div>
                                                                                <label for="{{ anexo_form.nome_anexo.id_for_label }}" class="block text-sm font-medium mb-1">Nome</label>
                                                                                {{ anexo_form.nome_anexo }}
                                                                                {% if anexo_form.nome_anexo.errors %}<div class="text-sm text-destructive mt-1">{{ anexo_form.nome_anexo.errors }}</div>{% endif %}
                                                                        </div>
                                                                        <div>
                                                                                <label for="{{ anexo_form.descricao.id_for_label }}" class="block text-sm font-medium mb-1">Descrição</label>
                                                                                {{ anexo_form.descricao }}
                                                                                {% if anexo_form.descricao.errors %}<div class="text-sm text-destructive mt-1">{{ anexo_form.descricao.errors }}</div>{% endif %}
                                                                        </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <button type="button" id="add-anexo" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors mb-2">
                        <i class="bi bi-plus-circle mr-2"></i> Adicionar Anexo
                    </button>
                    
                    <div class="flex flex-col sm:flex-row flex-wrap items-stretch sm:items-center gap-3 pt-6 mt-6 border-t w-full">
                        <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground px-6 py-3 text-sm font-medium hover:bg-primary/90 transition-colors min-w-[140px]">
                            <i class="bi bi-check-lg mr-2"></i>Salvar
                        </button>
                        <a href="{% url 'lancamentos:list' %}" class="w-full sm:w-auto inline-flex items-center justify-center rounded-md border border-input bg-background px-6 py-3 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors min-w-[140px]">
                            <i class="bi bi-arrow-left mr-2"></i>Cancelar
                        </a>
                    </div>
            </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Detectar erros de formulário e mostrar modal
    document.addEventListener('DOMContentLoaded', function() {
    const hasFormErrors = JSON.parse('{% if form.errors or form.non_field_errors or anexos_formset.errors or anexos_formset.non_form_errors %}true{% else %}false{% endif %}');
        
        if (hasFormErrors) {
            // String única com separador para evitar conflitos de lint/JS
            const errorMessagesRaw = "{% for error in form.non_field_errors %}{{ error|escapejs }}||{% endfor %}{% for field in form %}{% for error in field.errors %}<strong>{{ field.label|escapejs }}</strong>: {{ error|escapejs }}||{% endfor %}{% endfor %}{% for error in anexos_formset.non_form_errors %}<strong>Anexos</strong>: {{ error|escapejs }}||{% endfor %}";
            const errorMessages = errorMessagesRaw.split('||').filter(Boolean);
            // Inserir erros no modal
            const errorContentEl = document.getElementById('modalErrorContent');
            if (errorContentEl) {
                const errorList = document.createElement('ul');
                errorList.className = 'space-y-2';
                
                errorMessages.forEach(msg => {
                    const li = document.createElement('li');
                    li.innerHTML = msg;
                    li.className = 'mb-2';
                    errorList.appendChild(li);
                });
                
                errorContentEl.innerHTML = '';
                errorContentEl.appendChild(errorList);
                
                // Mostrar o modal
                openErrorModal();
            }
        }
    });
    
    // AJAX submit para preservar arquivos selecionados em caso de erro
    (function(){
        const form = document.getElementById('lancamento-form');
        if(!form) return;
        const submitBtn = form.querySelector('button[type="submit"]');

        function clearErrors(){
            form.querySelectorAll('.ajax-error').forEach(e=>e.remove());
            form.querySelectorAll('.is-invalid').forEach(el=>el.classList.remove('is-invalid'));
        }
        function showError(el, msgs){
            if(!el){
                // tentar container declarado
                const fallback = form.querySelector(`[data-field-error-target="${(msgs && msgs.fieldName)||''}"]`) || form.querySelector(`[data-field-error-target]`);
                if(fallback){
                    fallback.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
                }
                return;
            }
            el.classList.add('is-invalid');
            const div = document.createElement('div');
            div.className = 'ajax-error text-xs text-destructive mt-1';
            div.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
            el.parentElement.appendChild(div);
        }
        function applyErrors(data){
            clearErrors();
            if(!data) return;
            if(data.form){
                Object.entries(data.form.fields||{}).forEach(([field,msgs])=>{
                    const el = form.querySelector(`[name="${field}"]`);
                    if(!el){
                        // procurar container dedicado
                        const container = form.querySelector(`[data-field-error-target="${field}"]`);
                        if(container){
                            container.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
                        }
                    } else {
                        showError(el,msgs);
                    }
                });
                if(data.form.non_field && data.form.non_field.length){
                    const alert = document.createElement('div');
                    alert.className='ajax-error rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-sm p-3 mb-4';
                    alert.innerHTML=data.form.non_field.join('<br>');
                    form.prepend(alert);
                }
            }
            if(Array.isArray(data.anexos)){
                const forms = form.querySelectorAll('#anexos-container .anexo-form');
                data.anexos.forEach((fErr, idx)=>{
                    const frm = forms[idx];
                    if(!frm) return;
                    Object.entries(fErr.fields||{}).forEach(([field,msgs])=>{
                        const fieldEl = frm.querySelector(`[name$='-${field}']`);
                        showError(fieldEl, msgs);
                    });
                    if(fErr.non_field && fErr.non_field.length){
                        const nf = document.createElement('div');
                        nf.className='ajax-error rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-xs p-2 mb-2';
                        nf.innerHTML=fErr.non_field.join('<br>');
                        frm.prepend(nf);
                    }
                });
            }
            if(data.anexos_non_form && data.anexos_non_form.length){
                const alert2 = document.createElement('div');
                alert2.className='ajax-error rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-sm p-3 mb-4';
                alert2.innerHTML=data.anexos_non_form.join('<br>');
                form.prepend(alert2);
            }
        }
    // Submissão tradicional restaurada: nenhum interceptador AJAX aqui.
    })();
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const metodoField = document.getElementById('{{ form.metodo_escolhido.id_for_label }}') || document.querySelector('select[name="metodo_escolhido"]');
        const mapGroups = {
            'pedido de ressarcimento': ['lanc-group-debito_r','lanc-group-periodo_apuracao_r','lanc-group-total_r'],
            'pedido de restituição': ['lanc-group-total_credito_original_utilizado','lanc-group-debito','lanc-group-periodo_apuracao'],
            'pedido de restituiçao': ['lanc-group-total_credito_original_utilizado','lanc-group-debito','lanc-group-periodo_apuracao'],
            'pedido de restituicao': ['lanc-group-total_credito_original_utilizado','lanc-group-debito','lanc-group-periodo_apuracao']
        };
        function norm(v){return (v||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();}
        function hideAll(){document.querySelectorAll('[id^="lanc-group-"]').forEach(el=>el.classList.add('hidden'));}
        function update(){hideAll(); const sel = norm(metodoField.value); const groups = mapGroups[sel]||[]; groups.forEach(id=>{const el=document.getElementById(id); if(el) el.classList.remove('hidden');});}
        if(metodoField){metodoField.addEventListener('change',update); update();}
        
        // Atualizar saldo quando adesão for selecionada
        const adesaoField = document.querySelector('select[name="id_adesao"]');
        const saldoField = document.querySelector('input[name="saldo_atual_adesao"]');
        const adesoesSaldos = JSON.parse('{{ adesoes_saldos|escapejs }}');
        
        function updateSaldo() {
            const adesaoId = adesaoField.value;
            if (adesaoId && adesoesSaldos[adesaoId] !== undefined) {
                const saldo = adesoesSaldos[adesaoId];
                saldoField.value = saldo.toFixed(2);
                saldoField.placeholder = `R$ ${saldo.toFixed(2)}`;
            } else {
                saldoField.value = '';
                saldoField.placeholder = 'Selecione uma adesão...';
            }
        }
        
        if (adesaoField && saldoField) {
            adesaoField.addEventListener('change', updateSaldo);
            // Executar na inicialização se já houver uma adesão selecionada
            updateSaldo();
        }
        // Garantir que o campo de data esteja preenchido corretamente
        const dataField = document.querySelector('input[name="data_lancamento"]');
        if (dataField && !dataField.value) {
            // Se estamos editando e por algum motivo o campo está vazio, preenchemos com a data atual
            const today = new Date().toISOString().split('T')[0];
            dataField.value = today;
        }
        
    // Função para gerenciar o formset de anexos
        const anexosContainer = document.getElementById('anexos-container');
        const addAnexoBtn = document.getElementById('add-anexo');
        
        // Pegando o prefixo do formset
        const prefix = '{{ anexos_formset.prefix }}';
        
        // Atualizando os campos quando um novo anexo é adicionado
        const updateElementIndex = function(el, prefix, ndx) {
            const id_regex = new RegExp('(' + prefix + '-\\d+)', 'g');
            const replacement = prefix + '-' + ndx;
            
            // Atualizar todos os elementos input, select, textarea
            el.querySelectorAll('input, select, textarea').forEach((element) => {
                ['id', 'name'].forEach((attr) => {
                    if (element.getAttribute(attr)) {
                        element.setAttribute(attr, element.getAttribute(attr).replace(id_regex, replacement));
                    }
                });
            });
            
            // Atualizando os atributos for de todas as labels dentro deste elemento
            el.querySelectorAll('label').forEach((label) => {
                if (label.getAttribute('for')) {
                    label.setAttribute('for', 
                        label.getAttribute('for').replace(id_regex, replacement)
                    );
                }
            });
            
            // Atualizar qualquer outro atributo que contenha o padrão
            el.querySelectorAll('*').forEach((element) => {
                ['data-target', 'data-toggle', 'aria-describedby'].forEach((attr) => {
                    if (element.getAttribute(attr)) {
                        element.setAttribute(attr, 
                            element.getAttribute(attr).replace(id_regex, replacement)
                        );
                    }
                });
            });
        };
        
        // Função para adicionar um novo anexo
        addAnexoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Pegando o número total de forms
            let totalForms = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
            let currentFormCount = parseInt(totalForms.value);
            
            // Pegando o primeiro form como template
            const formTemplate = anexosContainer.querySelector('.anexo-form');
            if (!formTemplate) return;
            
            const newForm = formTemplate.cloneNode(true);
            
            // Remover informações de anexo existente
            const anexoAtualDiv = newForm.querySelector('.col-12.mb-2');
            if (anexoAtualDiv) {
                anexoAtualDiv.remove();
            }
            
            // Resetando todos os valores dos inputs
            newForm.querySelectorAll('input, select, textarea').forEach((input) => {
                if (input.getAttribute('type') === 'hidden') {
                    // Para campos hidden, limpar apenas se não for o ID
                    if (input.name && input.name.includes('-id')) {
                        input.value = '';
                    }
                } else {
                    input.value = '';
                }
                
                // Limpando quaisquer mensagens de erro
                const errorDiv = input.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('text-danger')) {
                    errorDiv.innerHTML = '';
                }
            });
            
            // Remover classe delete-form se existir
            newForm.classList.remove('delete-form');
            
            // Atualizando os índices
            updateElementIndex(newForm, prefix, currentFormCount);
            
            // Atualizando o valor total de forms
            totalForms.value = currentFormCount + 1;
            
            // Adicionando o novo form ao container
            anexosContainer.appendChild(newForm);
        });
    });

        // Tailwind Error Modal (light replacement for bootstrap)
        function openErrorModal(){
                let modal=document.getElementById('errorModalTW');
                if(!modal){
                        modal=document.createElement('div');
                        modal.id='errorModalTW';
                        modal.className='fixed inset-0 z-50 flex items-center justify-center p-4';
                        modal.innerHTML=`<div class="absolute inset-0 bg-black/60" data-overlay></div>
                                <div class="relative z-10 w-full max-w-lg bg-card border rounded-lg shadow-lg overflow-hidden">
                                    <div class="flex items-center justify-between px-6 py-4 border-b bg-destructive/10">
                                        <h3 class="text-lg font-semibold text-destructive flex items-center gap-2"><i class="bi bi-exclamation-triangle-fill"></i> Erro no Formulário</h3>
                                        <button type="button" class="rounded-md p-2 hover:bg-muted" data-close><i class="bi bi-x"></i></button>
                                    </div>
                                    <div class="p-6 max-h-[60vh] overflow-y-auto text-sm" id="modalErrorContent"></div>
                                    <div class="flex justify-end px-6 py-4 border-t">
                                        <button type="button" data-close class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground">Fechar</button>
                                    </div>
                                </div>`;
                        document.body.appendChild(modal);
                        modal.addEventListener('click',e=>{if(e.target.dataset.overlay!==undefined||e.target.closest('[data-close]')){closeErrorModal();}});
                        document.addEventListener('keydown', escHandler);
                }
                modal.classList.remove('hidden');
                document.body.style.overflow='hidden';
        }
        function closeErrorModal(){
                const modal=document.getElementById('errorModalTW');
                if(modal){modal.classList.add('hidden'); document.body.style.overflow='';}
        }
        function escHandler(e){ if(e.key==='Escape'){ closeErrorModal(); } }
</script>
{% endblock %}
