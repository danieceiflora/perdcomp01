{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if object %}Editar Lançamento{% else %}Novo Lançamento{% endif %}
{% endblock %}

{% block extra_head %}
<style>
    .anexo-form {
        background-color: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }
    .delete-form {
        background-color: #fff3f3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <form id="lancamento-form" method="post" enctype="multipart/form-data" class="card card-body" novalidate>
                {% csrf_token %}
                
                <!-- Exibir erros gerais (não específicos de um campo) -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Campo Valor ocultado do front: mantém input para submissão -->
                <div class="col-md-3 d-none">
                    <label class="form-label visually-hidden" for="{{ form.valor.id_for_label }}">{{ form.valor.label }}</label>
                    <div class="input-group">
                        {{ form.valor }}
                        <span class="input-group-text">R$</span>
                    </div>
                    <!-- Erros serão exibidos no modal -->
                </div>
        
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="{{ form.id_adesao.id_for_label }}" class="form-label">{{ form.id_adesao.label }}:</label>
                            {{ form.id_adesao }}
                            {% if form.id_adesao.errors %}
                                <div class="text-danger">
                                    {{ form.id_adesao.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.saldo_atual_adesao.id_for_label }}" class="form-label">{{ form.saldo_atual_adesao.label }}:</label>
                            <div class="input-group">
                                {{ form.saldo_atual_adesao }}
                                <span class="input-group-text">R$</span>
                            </div>
                            <small class="form-text text-muted">Saldo disponível na adesão selecionada.</small>
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.metodo_escolhido.id_for_label }}" class="form-label">Método:</label>
                            {{ form.metodo_escolhido }}
                            {% if form.metodo_escolhido.errors %}
                                <div class="text-danger">
                                    {{ form.metodo_escolhido.errors }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">Selecione o método para exibir os campos específicos.</small>
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.data_lancamento.id_for_label }}" class="form-label">{{ form.data_lancamento.label }}:</label>
                            {{ form.data_lancamento }}
                            {% if form.data_lancamento.errors %}
                                <div class="text-danger">
                                    {{ form.data_lancamento.errors }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ form.data_lancamento.help_text }}</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="{{ form.tipo.id_for_label }}" class="form-label">{{ form.tipo.label }}:</label>
                            {{ form.tipo }}
                            {% if form.tipo.errors %}
                                <div class="text-danger">
                                    {{ form.tipo.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="{{ form.sinal.id_for_label }}" class="form-label">{{ form.sinal.label }}:</label>
                                    {{ form.sinal }}
                                    {% if form.sinal.errors %}
                                        <div class="text-danger">
                                            {{ form.sinal.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Seção dinâmica: Detalhes do método -->
                <div class="card mb-4">
                    <div class="card-header"><strong>Detalhes do método</strong></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Pedido de restituição -->
                            <div id="lanc-group-total_credito_original_utilizado" class="col-md-4 d-none">
                                <label for="{{ form.lanc_total_credito_original_utilizado.id_for_label }}" class="form-label">Total Crédito Original Utilizado</label>
                                {{ form.lanc_total_credito_original_utilizado }}
                                {% if form.lanc_total_credito_original_utilizado.errors %}
                                    <div class="text-danger">{{ form.lanc_total_credito_original_utilizado.errors }}</div>
                                {% endif %}
                            </div>
                            <div id="lanc-group-debito" class="col-md-4 d-none">
                                <label for="{{ form.lanc_debito.id_for_label }}" class="form-label">Débito</label>
                                {{ form.lanc_debito }}
                                {% if form.lanc_debito.errors %}
                                    <div class="text-danger">{{ form.lanc_debito.errors }}</div>
                                {% endif %}
                            </div>
                            <div id="lanc-group-periodo_apuracao" class="col-md-4 d-none">
                                <label for="{{ form.lanc_periodo_apuracao.id_for_label }}" class="form-label">Período de Apuração</label>
                                {{ form.lanc_periodo_apuracao }}
                                {% if form.lanc_periodo_apuracao.errors %}
                                    <div class="text-danger">{{ form.lanc_periodo_apuracao.errors }}</div>
                                {% endif %}
                            </div>
                            <!-- Pedido de ressarcimento -->
                            <div id="lanc-group-debito_r" class="col-md-4 d-none">
                                <label for="{{ form.lanc_debito_r.id_for_label }}" class="form-label">Débito</label>
                                {{ form.lanc_debito_r }}
                                {% if form.lanc_debito_r.errors %}
                                    <div class="text-danger">{{ form.lanc_debito_r.errors }}</div>
                                {% endif %}
                            </div>
                            <div id="lanc-group-periodo_apuracao_r" class="col-md-4 d-none">
                                <label for="{{ form.lanc_periodo_apuracao_r.id_for_label }}" class="form-label">Período de Apuração</label>
                                {{ form.lanc_periodo_apuracao_r }}
                                {% if form.lanc_periodo_apuracao_r.errors %}
                                    <div class="text-danger">{{ form.lanc_periodo_apuracao_r.errors }}</div>
                                {% endif %}
                            </div>
                            <div id="lanc-group-total_r" class="col-md-4 d-none">
                                <label for="{{ form.lanc_total_r.id_for_label }}" class="form-label">Total</label>
                                {{ form.lanc_total_r }}
                                {% if form.lanc_total_r.errors %}
                                    <div class="text-danger">{{ form.lanc_total_r.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label for="{{ form.descricao.id_for_label }}" class="form-label">{{ form.descricao.label }}:</label>
                    {{ form.descricao }}
                    {% if form.descricao.errors %}
                        <div class="text-danger">
                            {{ form.descricao.errors }}
                        </div>
                    {% endif %}
                </div>
                    
                                       
                    <h4 class="border-bottom pb-2 mb-3">Anexos</h4>
                    
                    {{ anexos_formset.management_form }}
                    
                    <div id="anexos-container">
                        {% for anexo_form in anexos_formset.forms %}
                            <div class="anexo-form {% if anexo_form.instance.pk and anexo_form.DELETE.value %}delete-form{% endif %}">
                                <div class="row">
                                    {% if anexo_form.instance.pk %}
                                    <div class="col-12 mb-2">
                                        <strong>Anexo atual:</strong> 
                                        {% if anexo_form.instance.arquivo %}
                                            <a href="{{ anexo_form.instance.arquivo.url }}" target="_blank">{{ anexo_form.instance.nome_anexo }}</a>
                                        {% else %}
                                            {{ anexo_form.instance.nome_anexo }}
                                        {% endif %}
                                        
                                       
                                    </div>
                                    {% endif %}
                                
                                    <!-- Campos ocultos -->
                                    {% for hidden in anexo_form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ anexo_form.arquivo.id_for_label }}" class="form-label">Arquivo:</label>
                                            {{ anexo_form.arquivo }}
                                            {% if anexo_form.arquivo.errors %}
                                                <div class="text-danger">
                                                    {{ anexo_form.arquivo.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ anexo_form.nome_anexo.id_for_label }}" class="form-label">Nome:</label>
                                            {{ anexo_form.nome_anexo }}
                                            {% if anexo_form.nome_anexo.errors %}
                                                <div class="text-danger">
                                                    {{ anexo_form.nome_anexo.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ anexo_form.descricao.id_for_label }}" class="form-label">Descrição:</label>
                                            {{ anexo_form.descricao }}
                                            {% if anexo_form.descricao.errors %}
                                                <div class="text-danger">
                                                    {{ anexo_form.descricao.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <button type="button" id="add-anexo" class="btn btn-outline-primary mb-4">
                        <i class="bi bi-plus-circle"></i> Adicionar Anexo
                    </button>
                    
                    <div class="card-footer">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-lg"></i> Salvar
                        </button>
                        <a href="{% url 'lancamentos:list' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                    </div>
            </form>
            
            <!-- Modal de Erro do Formulário -->
            <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="errorModalLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i>Erro no Formulário</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <div id="modalErrorContent">
                                <!-- Conteúdo preenchido via JS -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Detectar erros de formulário e mostrar modal
    document.addEventListener('DOMContentLoaded', function() {
        const hasFormErrors = {% if form.errors or form.non_field_errors or anexos_formset.errors or anexos_formset.non_form_errors %}true{% else %}false{% endif %};
        
        if (hasFormErrors) {
            // Coletar todos os erros para exibir no modal
            const errorMessages = [];
            
            // Erros gerais do formulário
            {% if form.non_field_errors %}
                {% for error in form.non_field_errors %}
                    errorMessages.push("{{ error }}");
                {% endfor %}
            {% endif %}
            
            // Erros específicos de campos
            {% for field in form %}
                {% if field.errors %}
                    {% for error in field.errors %}
                        errorMessages.push("<strong>{{ field.label }}</strong>: {{ error }}");
                    {% endfor %}
                {% endif %}
            {% endfor %}
            
            // Erros do formset
            {% if anexos_formset.non_form_errors %}
                {% for error in anexos_formset.non_form_errors %}
                    errorMessages.push("<strong>Anexos</strong>: {{ error }}");
                {% endfor %}
            {% endif %}
            
            // Inserir erros no modal
            const errorContentEl = document.getElementById('modalErrorContent');
            if (errorContentEl) {
                const errorList = document.createElement('ul');
                errorList.className = 'alert alert-danger mb-0 list-unstyled';
                
                errorMessages.forEach(msg => {
                    const li = document.createElement('li');
                    li.innerHTML = msg;
                    li.className = 'mb-2';
                    errorList.appendChild(li);
                });
                
                errorContentEl.innerHTML = '';
                errorContentEl.appendChild(errorList);
                
                // Mostrar o modal
                const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                errorModal.show();
            }
        }
    });
    
    // AJAX submit para preservar arquivos selecionados em caso de erro
    (function(){
        const form = document.getElementById('lancamento-form');
        if(!form) return;
        const submitBtn = form.querySelector('button[type="submit"]');

        function clearErrors(){
            form.querySelectorAll('.ajax-error').forEach(e=>e.remove());
            form.querySelectorAll('.is-invalid').forEach(el=>el.classList.remove('is-invalid'));
        }
        function showError(el, msgs){
            if(!el){
                // tentar container declarado
                const fallback = form.querySelector(`[data-field-error-target="${(msgs && msgs.fieldName)||''}"]`) || form.querySelector(`[data-field-error-target]`);
                if(fallback){
                    fallback.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
                }
                return;
            }
            el.classList.add('is-invalid');
            const div = document.createElement('div');
            div.className = 'invalid-feedback d-block ajax-error';
            div.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
            el.parentElement.appendChild(div);
        }
        function applyErrors(data){
            clearErrors();
            if(!data) return;
            if(data.form){
                Object.entries(data.form.fields||{}).forEach(([field,msgs])=>{
                    const el = form.querySelector(`[name="${field}"]`);
                    if(!el){
                        // procurar container dedicado
                        const container = form.querySelector(`[data-field-error-target="${field}"]`);
                        if(container){
                            container.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
                        }
                    } else {
                        showError(el,msgs);
                    }
                });
                if(data.form.non_field && data.form.non_field.length){
                    const alert = document.createElement('div');
                    alert.className='alert alert-danger ajax-error';
                    alert.innerHTML=data.form.non_field.join('<br>');
                    form.prepend(alert);
                }
            }
            if(Array.isArray(data.anexos)){
                const forms = form.querySelectorAll('#anexos-container .anexo-form');
                data.anexos.forEach((fErr, idx)=>{
                    const frm = forms[idx];
                    if(!frm) return;
                    Object.entries(fErr.fields||{}).forEach(([field,msgs])=>{
                        const fieldEl = frm.querySelector(`[name$='-${field}']`);
                        showError(fieldEl, msgs);
                    });
                    if(fErr.non_field && fErr.non_field.length){
                        const nf = document.createElement('div');
                        nf.className='alert alert-danger ajax-error mb-2';
                        nf.innerHTML=fErr.non_field.join('<br>');
                        frm.prepend(nf);
                    }
                });
            }
            if(data.anexos_non_form && data.anexos_non_form.length){
                const alert2 = document.createElement('div');
                alert2.className='alert alert-danger ajax-error';
                alert2.innerHTML=data.anexos_non_form.join('<br>');
                form.prepend(alert2);
            }
        }
    // Submissão tradicional restaurada: nenhum interceptador AJAX aqui.
    })();
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const metodoField = document.getElementById('{{ form.metodo_escolhido.id_for_label }}') || document.querySelector('select[name="metodo_escolhido"]');
        const mapGroups = {
            'pedido de ressarcimento': ['lanc-group-debito_r','lanc-group-periodo_apuracao_r','lanc-group-total_r'],
            'pedido de restituição': ['lanc-group-total_credito_original_utilizado','lanc-group-debito','lanc-group-periodo_apuracao'],
            'pedido de restituiçao': ['lanc-group-total_credito_original_utilizado','lanc-group-debito','lanc-group-periodo_apuracao'],
            'pedido de restituicao': ['lanc-group-total_credito_original_utilizado','lanc-group-debito','lanc-group-periodo_apuracao']
        };
        function norm(v){return (v||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();}
        function hideAll(){document.querySelectorAll('[id^="lanc-group-"]').forEach(el=>{el.classList.add('d-none');});}
        function update(){hideAll(); const sel = norm(metodoField.value); const groups = mapGroups[sel]||[]; groups.forEach(id=>{const el=document.getElementById(id); if(el) el.classList.remove('d-none');});}
        if(metodoField){metodoField.addEventListener('change',update); update();}
        
        // Atualizar saldo quando adesão for selecionada
        const adesaoField = document.querySelector('select[name="id_adesao"]');
        const saldoField = document.querySelector('input[name="saldo_atual_adesao"]');
        const adesoesSaldos = JSON.parse('{{ adesoes_saldos|escapejs }}');
        
        function updateSaldo() {
            const adesaoId = adesaoField.value;
            if (adesaoId && adesoesSaldos[adesaoId] !== undefined) {
                const saldo = adesoesSaldos[adesaoId];
                saldoField.value = saldo.toFixed(2);
                saldoField.placeholder = `R$ ${saldo.toFixed(2)}`;
            } else {
                saldoField.value = '';
                saldoField.placeholder = 'Selecione uma adesão...';
            }
        }
        
        if (adesaoField && saldoField) {
            adesaoField.addEventListener('change', updateSaldo);
            // Executar na inicialização se já houver uma adesão selecionada
            updateSaldo();
        }
        // Garantir que o campo de data esteja preenchido corretamente
        const dataField = document.querySelector('input[name="data_lancamento"]');
        if (dataField && !dataField.value) {
            // Se estamos editando e por algum motivo o campo está vazio, preenchemos com a data atual
            const today = new Date().toISOString().split('T')[0];
            dataField.value = today;
        }
        
        // Função para gerenciar o formset de anexos
        const anexosContainer = document.getElementById('anexos-container');
        const addAnexoBtn = document.getElementById('add-anexo');
        
        // Pegando o prefixo do formset
        const prefix = '{{ anexos_formset.prefix }}';
        
        // Atualizando os campos quando um novo anexo é adicionado
        const updateElementIndex = function(el, prefix, ndx) {
            const id_regex = new RegExp('(' + prefix + '-\\d+)', 'g');
            const replacement = prefix + '-' + ndx;
            
            // Atualizar todos os elementos input, select, textarea
            el.querySelectorAll('input, select, textarea').forEach((element) => {
                ['id', 'name'].forEach((attr) => {
                    if (element.getAttribute(attr)) {
                        element.setAttribute(attr, 
                            element.getAttribute(attr).replace(id_regex, replacement)
                        );
                    }
                });
            });
            
            // Atualizando os atributos for de todas as labels dentro deste elemento
            el.querySelectorAll('label').forEach((label) => {
                if (label.getAttribute('for')) {
                    label.setAttribute('for', 
                        label.getAttribute('for').replace(id_regex, replacement)
                    );
                }
            });
            
            // Atualizar qualquer outro atributo que contenha o padrão
            el.querySelectorAll('*').forEach((element) => {
                ['data-target', 'data-toggle', 'aria-describedby'].forEach((attr) => {
                    if (element.getAttribute(attr)) {
                        element.setAttribute(attr, 
                            element.getAttribute(attr).replace(id_regex, replacement)
                        );
                    }
                });
            });
        };
        
        // Função para adicionar um novo anexo
        addAnexoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Pegando o número total de forms
            let totalForms = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
            let currentFormCount = parseInt(totalForms.value);
            
            // Pegando o primeiro form como template
            const formTemplate = anexosContainer.querySelector('.anexo-form');
            if (!formTemplate) return;
            
            const newForm = formTemplate.cloneNode(true);
            
            // Remover informações de anexo existente
            const anexoAtualDiv = newForm.querySelector('.col-12.mb-2');
            if (anexoAtualDiv) {
                anexoAtualDiv.remove();
            }
            
            // Resetando todos os valores dos inputs
            newForm.querySelectorAll('input, select, textarea').forEach((input) => {
                if (input.getAttribute('type') === 'hidden') {
                    // Para campos hidden, limpar apenas se não for o ID
                    if (input.name && input.name.includes('-id')) {
                        input.value = '';
                    }
                } else {
                    input.value = '';
                }
                
                // Limpando quaisquer mensagens de erro
                const errorDiv = input.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('text-danger')) {
                    errorDiv.innerHTML = '';
                }
            });
            
            // Remover classe delete-form se existir
            newForm.classList.remove('delete-form');
            
            // Atualizando os índices
            updateElementIndex(newForm, prefix, currentFormCount);
            
            // Atualizando o valor total de forms
            totalForms.value = currentFormCount + 1;
            
            // Adicionando o novo form ao container
            anexosContainer.appendChild(newForm);
        });
    });
</script>
{% endblock %}
