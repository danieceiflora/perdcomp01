{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if object %}Editar Lançamento{% else %}Novo Lançamento{% endif %}
{% endblock %}

{% block extra_head %}
<style>
  .delete-form {opacity:.55; position:relative;}
  .delete-form::after {content:"Será removido após salvar"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(239,68,68,.18); font-size:.75rem; font-weight:500; color:#b91c1c; backdrop-filter:blur(1px);}    
  /* Custom file input wrapper */
  .file-field {position:relative;}
  .file-field input[type=file] {opacity:0; position:absolute; inset:0; width:100%; height:100%; cursor:pointer;}
  .file-field .file-visual {display:flex; align-items:center; gap:.75rem; background:var(--file-bg,#f3f4f6); color:var(--file-fg,#111827); border:1px solid var(--file-border,#d1d5db); border-radius:.5rem; padding:.55rem .9rem; font-size:.75rem; line-height:1.1; min-height:42px;}
  .file-field .file-visual .file-btn {background:var(--file-btn-bg,#e5e7eb); color:var(--file-btn-fg,#111827); border:1px solid var(--file-btn-border,#d1d5db); padding:.35rem .8rem; border-radius:.4rem; font-weight:500; font-size:.7rem; letter-spacing:.5px; text-transform:uppercase; display:inline-flex; align-items:center; gap:.25rem;}
  .file-field .file-visual .file-name {flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:.7rem; opacity:.85;}
  .file-field .file-visual:focus-within {outline:2px solid var(--file-focus,#2563eb); outline-offset:2px;}
  .file-field:hover .file-visual {background:var(--file-bg-hover,#e5e7eb);}  
  /* Dark mode overrides */
  :root.dark .file-field .file-visual, .dark .file-field .file-visual, body.dark .file-field .file-visual {--file-bg:#1f2937; --file-fg:#f3f4f6; --file-border:#374151; --file-bg-hover:#273549;}
  :root.dark .file-field .file-visual .file-btn, .dark .file-field .file-visual .file-btn, body.dark .file-field .file-visual .file-btn {--file-btn-bg:#374151; --file-btn-fg:#f3f4f6; --file-btn-border:#4b5563;}
  :root.dark .file-field .file-visual .file-name, .dark .file-field .file-visual .file-name, body.dark .file-field .file-visual .file-name {opacity:.9;}
  .file-field .file-visual .file-btn:hover {filter:brightness(1.05);}    
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <div class="bg-card border rounded-lg shadow-sm">
        <div class="p-6 border-b flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-semibold text-card-foreground">{% if object %}Editar Lançamento{% else %}Novo Lançamento{% endif %}</h1>
                <p class="text-sm text-muted-foreground">Preencha os dados do lançamento e anexe documentos.</p>
            </div>
            <a href="{% url 'lancamentos:list' %}" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors">
                <i class="bi bi-arrow-left mr-2"></i> Voltar
            </a>
        </div>

        {% if user.is_staff or user.is_superuser %}
        <!-- Área de importação de declaração de compensação -->
        <div class="p-6 border-b bg-muted/10">
            <div class="flex flex-col gap-3">
                <div class="flex items-start gap-2">
                    <i class="bi bi-file-earmark-arrow-up text-primary text-lg"></i>
                    <div>
                        <h3 class="text-sm font-semibold">Importar Declaração de Compensação</h3>
                        <p class="text-xs text-muted-foreground">Arraste um PDF de declaração de compensação ou clique para selecionar</p>
                    </div>
                </div>
                <div id="import-declaracao-dropzone" 
                     class="border-2 border-dashed rounded-md p-6 text-center cursor-pointer transition-colors hover:border-primary hover:bg-muted/30"
                     data-url="{% url 'adesao:importar_declaracao_compensacao' %}">
                    <div class="flex flex-col items-center gap-2 text-sm text-muted-foreground">
                        <i class="bi bi-cloud-upload text-2xl"></i>
                        <span>Arraste o PDF aqui ou <span class="text-primary font-medium">clique para selecionar</span></span>
                        <span class="text-xs">Apenas arquivos PDF de Declaração de Compensação</span>
                    </div>
                    <input id="declaracao-file-input" type="file" accept=".pdf" class="hidden">
                </div>
                <div id="import-declaracao-status" class="hidden rounded-md border p-3 text-sm"></div>
            </div>
        </div>
        {% endif %}

        <form id="lancamento-form" method="post" enctype="multipart/form-data" novalidate class="p-6 space-y-8">
                {% csrf_token %}
                
                <!-- Exibir erros gerais (não específicos de um campo) -->
                {% if form.non_field_errors %}
                <div class="rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-sm p-4">
                    <ul class="list-disc list-inside space-y-1">
                        {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Campo oculto de valor (quando necessário) -->
                <div class="hidden">
                    <label class="form-label visually-hidden" for="{{ form.valor.id_for_label }}">{{ form.valor.label }}</label>
                    {{ form.valor }}
                </div>

                <!-- Grupo 1: Adesão / Saldo / Sinal -->
                <div class="bg-muted/20 border rounded-md p-4">
                    <h3 class="text-sm font-semibold mb-4 tracking-wide text-muted-foreground">Dados do lançamento</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label for="{{ form.id_adesao.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.id_adesao.label }}</label>
                            {{ form.id_adesao }}
                            {% if form.id_adesao.errors %}<div class="text-sm text-destructive mt-1">{{ form.id_adesao.errors }}</div>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.saldo_atual_adesao.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.saldo_atual_adesao.label }}</label>
                            {{ form.saldo_atual_adesao }}
                            <p class="text-xs text-muted-foreground mt-1">Saldo disponível na adesão selecionada.</p>
                        </div>
                        <div>
                            <label for="{{ form.sinal.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.sinal.label }}</label>
                            {{ form.sinal }}
                            {% if form.sinal.errors %}<div class="text-sm text-destructive mt-1">{{ form.sinal.errors }}</div>{% endif %}
                        </div>
                        <div class="md:col-span-2">
                            <label for="{{ form.codigo_guia.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.codigo_guia.label }}</label>
                            {{ form.codigo_guia }}
                            <p class="text-xs text-muted-foreground mt-1">Informe o identificador da guia associado a este lançamento (opcional).</p>
                            {% if form.codigo_guia.errors %}<div class="text-sm text-destructive mt-1">{{ form.codigo_guia.errors }}</div>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Grupo 2: Tipo de Crédito / Data / Detalhes / Observação -->
                <div class="bg-muted/20 border rounded-md p-4">
                    <h3 class="text-sm font-semibold mb-4 tracking-wide text-muted-foreground">Pedido e tipo de crédito</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="{{ form.metodo_escolhido.id_for_label }}" class="block text-sm font-medium mb-1">Tipo de Crédito</label>
                            {{ form.metodo_escolhido }}
                            {% if form.metodo_escolhido.errors %}<div class="text-sm text-destructive mt-1">{{ form.metodo_escolhido.errors }}</div>{% endif %}
                            <p class="text-xs text-muted-foreground mt-1">Selecione o tipo de crédito para exibir os campos específicos.</p>
                        </div>
                        <div>
                            <label for="{{ form.data_lancamento.id_for_label }}" class="block text-sm font-medium mb-1">{{ form.data_lancamento.label }}</label>
                            {{ form.data_lancamento }}
                            {% if form.data_lancamento.errors %}<div class="text-sm text-destructive mt-1">{{ form.data_lancamento.errors }}</div>{% endif %}
                            <p class="text-xs text-muted-foreground mt-1">{{ form.data_lancamento.help_text }}</p>
                        </div>
                        <div class="md:col-span-3">
                            <div class="border rounded-md p-4">
                                <h4 class="text-sm font-semibold mb-4 tracking-wide text-muted-foreground">Detalhes do tipo de crédito</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <!-- Declaração de Compensação -->
                                    <div id="lanc-group-total_debitos_documento" class="hidden md:col-span-3">
                                        <label for="{{ form.lanc_total_debitos_documento.id_for_label }}" class="block text-sm font-medium mb-1">Total dos Débitos deste Documento</label>
                                        {{ form.lanc_total_debitos_documento }}
                                        <p class="text-xs text-muted-foreground mt-1">Valor total dos débitos conforme declaração de compensação</p>
                                        {% if form.lanc_total_debitos_documento.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_total_debitos_documento.errors }}</div>{% endif %}
                                    </div>
                                    <div id="lanc-group-descricao_debitos" class="hidden md:col-span-3">
                                        <label for="{{ form.lanc_descricao_debitos.id_for_label }}" class="block text-sm font-medium mb-1">Descrição dos Débitos</label>
                                        {{ form.lanc_descricao_debitos }}
                                        <p class="text-xs text-muted-foreground mt-1">Detalhamento dos itens de débito da declaração</p>
                                        {% if form.lanc_descricao_debitos.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_descricao_debitos.errors }}</div>{% endif %}
                                    </div>
                                    <div id="lanc-group-total_credito_original_utilizado" class="hidden">
                                        <label for="{{ form.lanc_total_credito_original_utilizado.id_for_label }}" class="block text-sm font-medium mb-1">Total Crédito Original Utilizado</label>
                                        {{ form.lanc_total_credito_original_utilizado }}
                                        {% if form.lanc_total_credito_original_utilizado.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_total_credito_original_utilizado.errors }}</div>{% endif %}
                                    </div>
                                    <div id="lanc-group-periodo_apuracao" class="hidden">
                                        <label for="{{ form.lanc_periodo_apuracao.id_for_label }}" class="block text-sm font-medium mb-1">Período de Apuração</label>
                                        {{ form.lanc_periodo_apuracao }}
                                        {% if form.lanc_periodo_apuracao.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_periodo_apuracao.errors }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Crédito em Conta -->
                                    <div id="lanc-group-data_credito" class="hidden">
                                        <label for="{{ form.lanc_data_credito.id_for_label }}" class="block text-sm font-medium mb-1">Data do Crédito</label>
                                        {{ form.lanc_data_credito }}
                                        {% if form.lanc_data_credito.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_data_credito.errors }}</div>{% endif %}
                                    </div>
                                    <div id="lanc-group-valor_credito_em_conta" class="hidden">
                                        <label for="{{ form.lanc_valor_credito_em_conta.id_for_label }}" class="block text-sm font-medium mb-1">Valor creditado em conta</label>
                                        {{ form.lanc_valor_credito_em_conta }}
                                        {% if form.lanc_valor_credito_em_conta.errors %}<div class="text-sm text-destructive mt-1">{{ form.lanc_valor_credito_em_conta.errors }}</div>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-3">
                            <label for="{{ form.descricao.id_for_label }}" class="block text-sm font-medium mb-1">Observação</label>
                            {{ form.descricao }}
                            {% if form.descricao.errors %}<div class="text-sm text-destructive mt-1">{{ form.descricao.errors }}</div>{% endif %}
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Aprovado</label>
                            <select name="aprovado" class="input w-full">
                                <option value="False">Não</option>
                                <option value="True">Sim</option>
                            </select>
                            <p class="text-xs text-muted-foreground mt-1">Se "Sim" for selecionado, o saldo será atualizado no salvamento.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Data de Aprovação</label>
                            <input type="datetime-local" name="data_aprovacao" class="input w-full" />
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium mb-1">Observação da Aprovação</label>
                            <textarea name="observacao_aprovacao" rows="3" class="input w-full" placeholder="Observações sobre a aprovação (opcional)"></textarea>
                        </div>
                    </div>
                </div>
                    
                                       
                <!-- Grupo 3: Anexos -->
                <div class="bg-muted/20 border rounded-md p-4">
                    <h4 class="text-base font-semibold border-b pb-2 mb-4 flex items-center gap-2"><i class="bi bi-paperclip"></i> Anexos</h4>
                    <div id="dropzone-anexos" class="mb-4 border-2 border-dashed rounded-md p-6 text-center cursor-pointer transition-colors bg-muted/20 hover:bg-muted/30" style="cursor:pointer;">
                        <div class="flex flex-col items-center gap-2 text-sm text-muted-foreground">
                            <i class="bi bi-cloud-upload text-2xl"></i>
                            <span>Arraste arquivos aqui ou <span class="text-primary font-medium">clique para selecionar</span></span>
                            <span class="text-xs">Formatos aceitos: PDF, imagens, planilhas. Múltiplos arquivos suportados.</span>
                        </div>
                        <input id="hidden-multi-file" type="file" class="hidden" multiple>
                    </div>
                    
                    {{ anexos_formset.management_form }}
                    
                    <div id="anexos-container" class="space-y-4">
                        {% for anexo_form in anexos_formset.forms %}
                        {% if anexo_form.instance.pk or anexo_form.nome_anexo.value or anexo_form.arquivo.value %}
                        <div class="anexo-form {% if anexo_form.instance.pk and anexo_form.DELETE.value %}delete-form{% endif %} bg-muted/20 border rounded-md p-4"
                             data-initial-form="{{ forloop.first|yesno:'true,false' }}">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-medium text-sm">Anexo {% if forloop.counter > 1 %}#{{ forloop.counter }}{% endif %}</h5>
                                <button type="button" class="remove-anexo inline-flex items-center justify-center rounded-md border border-destructive bg-destructive/10 px-2 py-1 text-xs font-medium text-destructive hover:bg-destructive/20 transition-colors">
                                    <i class="bi bi-trash mr-1"></i>Remover
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {% if anexo_form.instance.pk %}
                                <div class="md:col-span-3 text-sm mb-2">
                                    <strong class="font-medium">Anexo atual:</strong>
                                    {% if anexo_form.instance.arquivo %}
                                        <a href="{{ anexo_form.instance.arquivo.url }}" target="_blank">{{ anexo_form.instance.nome_anexo }}</a>
                                    {% else %}
                                        {{ anexo_form.instance.nome_anexo }}
                                    {% endif %}
                                </div>
                                {% endif %}
                                {# Campos ocultos #}
                                {% for hidden in anexo_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                <div>
                                    <label for="{{ anexo_form.arquivo.id_for_label }}" class="block text-sm font-medium mb-1">Arquivo</label>
                                    <div class="file-field" data-file-wrapper>
                                        {{ anexo_form.arquivo }}
                                        <div class="file-visual">
                                            <span class="file-btn"><i class="bi bi-paperclip text-xs"></i> Selecionar</span>
                                            <span class="file-name" data-file-name>{% if anexo_form.instance.pk %}{{ anexo_form.instance.nome_anexo|default:'Arquivo existente' }}{% else %}Nenhum arquivo{% endif %}</span>
                                        </div>
                                    </div>
                                    {% if anexo_form.arquivo.errors %}<div class="text-sm text-destructive mt-1">{{ anexo_form.arquivo.errors }}</div>{% endif %}
                                </div>
                                <div>
                                    <label for="{{ anexo_form.nome_anexo.id_for_label }}" class="block text-sm font-medium mb-1">Nome</label>
                                    {{ anexo_form.nome_anexo }}
                                    {% if anexo_form.nome_anexo.errors %}<div class="text-sm text-destructive mt-1">{{ anexo_form.nome_anexo.errors }}</div>{% endif %}
                                </div>
                                <div>
                                    <label for="{{ anexo_form.descricao.id_for_label }}" class="block text-sm font-medium mb-1">Descrição</label>
                                    {{ anexo_form.descricao }}
                                    {% if anexo_form.descricao.errors %}<div class="text-sm text-destructive mt-1">{{ anexo_form.descricao.errors }}</div>{% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                        
                        <!-- Template form para clonagem via JavaScript (sempre oculto) -->
                        {% with anexos_formset.empty_form as template_form %}
                        <div class="anexo-form bg-muted/20 border rounded-md p-4 hidden" id="template-anexo-form" data-template-form="true">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-medium text-sm">Anexo</h5>
                                <button type="button" class="remove-anexo inline-flex items-center justify-center rounded-md border border-destructive bg-destructive/10 px-2 py-1 text-xs font-medium text-destructive hover:bg-destructive/20 transition-colors">
                                    <i class="bi bi-trash mr-1"></i>Remover
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {# Campos ocultos #}
                                {% for hidden in template_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                <div>
                                    <label for="{{ template_form.arquivo.id_for_label }}" class="block text-sm font-medium mb-1">Arquivo</label>
                                    <div class="file-field" data-file-wrapper>
                                        {{ template_form.arquivo }}
                                        <div class="file-visual">
                                            <span class="file-btn"><i class="bi bi-paperclip text-xs"></i> Selecionar</span>
                                            <span class="file-name" data-file-name>Nenhum arquivo</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="{{ template_form.nome_anexo.id_for_label }}" class="block text-sm font-medium mb-1">Nome</label>
                                    {{ template_form.nome_anexo }}
                                </div>
                                <div>
                                    <label for="{{ template_form.descricao.id_for_label }}" class="block text-sm font-medium mb-1">Descrição</label>
                                    {{ template_form.descricao }}
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                    </div>
                    
                    
                    
                    <div class="flex flex-col sm:flex-row flex-wrap items-stretch sm:items-center gap-3 pt-6 mt-6 border-t w-full">
                        <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground px-6 py-3 text-sm font-medium hover:bg-primary/90 transition-colors min-w-[140px]">
                            <i class="bi bi-check-lg mr-2"></i>Salvar
                        </button>
                        <a href="{% url 'lancamentos:list' %}" class="w-full sm:w-auto inline-flex items-center justify-center rounded-md border border-input bg-background px-6 py-3 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors min-w-[140px]">
                            <i class="bi bi-arrow-left mr-2"></i>Cancelar
                        </a>
                    </div>
            </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Detectar erros de formulário e mostrar modal
    document.addEventListener('DOMContentLoaded', function() {
    const hasFormErrors = JSON.parse('{% if form.errors or form.non_field_errors or anexos_formset.errors or anexos_formset.non_form_errors %}true{% else %}false{% endif %}');
        
        if (hasFormErrors) {
            // String única com separador para evitar conflitos de lint/JS
            const errorMessagesRaw = "{% for error in form.non_field_errors %}{{ error|escapejs }}||{% endfor %}{% for field in form %}{% for error in field.errors %}<strong>{{ field.label|escapejs }}</strong>: {{ error|escapejs }}||{% endfor %}{% endfor %}{% for error in anexos_formset.non_form_errors %}<strong>Anexos</strong>: {{ error|escapejs }}||{% endfor %}";
            const errorMessages = errorMessagesRaw.split('||').filter(Boolean);
            // Inserir erros no modal
            const errorContentEl = document.getElementById('modalErrorContent');
            if (errorContentEl) {
                const errorList = document.createElement('ul');
                errorList.className = 'space-y-2';
                
                errorMessages.forEach(msg => {
                    const li = document.createElement('li');
                    li.innerHTML = msg;
                    li.className = 'mb-2';
                    errorList.appendChild(li);
                });
                
                errorContentEl.innerHTML = '';
                errorContentEl.appendChild(errorList);
                
                // Mostrar o modal
                openErrorModal();
            }
        }
    });
    
    // AJAX submit para preservar arquivos selecionados em caso de erro
    (function(){
        const form = document.getElementById('lancamento-form');
        if(!form) return;
        const submitBtn = form.querySelector('button[type="submit"]');

        function clearErrors(){
            form.querySelectorAll('.ajax-error').forEach(e=>e.remove());
            form.querySelectorAll('.is-invalid').forEach(el=>el.classList.remove('is-invalid'));
        }
        function showError(el, msgs){
            if(!el){
                // tentar container declarado
                const fallback = form.querySelector(`[data-field-error-target="${(msgs && msgs.fieldName)||''}"]`) || form.querySelector(`[data-field-error-target]`);
                if(fallback){
                    fallback.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
                }
                return;
            }
            el.classList.add('is-invalid');
            const div = document.createElement('div');
            div.className = 'ajax-error text-xs text-destructive mt-1';
            div.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
            el.parentElement.appendChild(div);
        }
        function applyErrors(data){
            clearErrors();
            if(!data) return;
            if(data.form){
                Object.entries(data.form.fields||{}).forEach(([field,msgs])=>{
                    const el = form.querySelector(`[name="${field}"]`);
                    if(!el){
                        // procurar container dedicado
                        const container = form.querySelector(`[data-field-error-target="${field}"]`);
                        if(container){
                            container.innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
                        }
                    } else {
                        showError(el,msgs);
                    }
                });
                if(data.form.non_field && data.form.non_field.length){
                    const alert = document.createElement('div');
                    alert.className='ajax-error rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-sm p-3 mb-4';
                    alert.innerHTML=data.form.non_field.join('<br>');
                    form.prepend(alert);
                }
            }
            if(Array.isArray(data.anexos)){
                const forms = form.querySelectorAll('#anexos-container .anexo-form');
                data.anexos.forEach((fErr, idx)=>{
                    const frm = forms[idx];
                    if(!frm) return;
                    Object.entries(fErr.fields||{}).forEach(([field,msgs])=>{
                        const fieldEl = frm.querySelector(`[name$='-${field}']`);
                        showError(fieldEl, msgs);
                    });
                    if(fErr.non_field && fErr.non_field.length){
                        const nf = document.createElement('div');
                        nf.className='ajax-error rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-xs p-2 mb-2';
                        nf.innerHTML=fErr.non_field.join('<br>');
                        frm.prepend(nf);
                    }
                });
            }
            if(data.anexos_non_form && data.anexos_non_form.length){
                const alert2 = document.createElement('div');
                alert2.className='ajax-error rounded-md border border-destructive/50 bg-destructive/10 text-destructive text-sm p-3 mb-4';
                alert2.innerHTML=data.anexos_non_form.join('<br>');
                form.prepend(alert2);
            }
        }
    // Submissão tradicional restaurada: nenhum interceptador AJAX aqui.
    })();
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const metodoField = document.getElementById('{{ form.metodo_escolhido.id_for_label }}') || document.querySelector('select[name="metodo_escolhido"]');
        const mapGroups = {
            'declaração de compensação': ['lanc-group-total_debitos_documento','lanc-group-descricao_debitos','lanc-group-total_credito_original_utilizado','lanc-group-periodo_apuracao'],
            'credito em conta': ['lanc-group-data_credito','lanc-group-valor_credito_em_conta']
        };
        function norm(v){return (v||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();}
        function hideAll(){document.querySelectorAll('[id^="lanc-group-"]').forEach(el=>el.classList.add('hidden'));}
        function update(){hideAll(); const sel = norm(metodoField.value); const groups = mapGroups[sel]||[]; groups.forEach(id=>{const el=document.getElementById(id); if(el) el.classList.remove('hidden');});}
        if(metodoField){metodoField.addEventListener('change',update); update();}
        
        // Atualizar saldo quando adesão for selecionada
        const adesaoField = document.querySelector('select[name="id_adesao"]');
        const saldoField = document.querySelector('input[name="saldo_atual_adesao"]');
        const adesoesSaldos = JSON.parse('{{ adesoes_saldos|escapejs }}');
        
        function updateSaldo() {
            const adesaoId = adesaoField.value;
            if (adesaoId && adesoesSaldos[adesaoId] !== undefined) {
                const saldo = adesoesSaldos[adesaoId];
                saldoField.value = saldo.toFixed(2);
                saldoField.placeholder = `R$ ${saldo.toFixed(2)}`;
            } else {
                saldoField.value = '';
                saldoField.placeholder = 'Selecione uma adesão...';
            }
        }
        
        if (adesaoField && saldoField) {
            adesaoField.addEventListener('change', updateSaldo);
            // Executar na inicialização se já houver uma adesão selecionada
            updateSaldo();
        }
        // Garantir que o campo de data esteja preenchido corretamente
        const dataField = document.querySelector('input[name="data_lancamento"]');
        if (dataField && !dataField.value) {
            // Se estamos editando e por algum motivo o campo está vazio, preenchemos com a data atual
            const today = new Date().toISOString().split('T')[0];
            dataField.value = today;
        }
        
    // Função para gerenciar o formset de anexos
    const anexosContainer = document.getElementById('anexos-container');
    const addAnexoBtn = document.getElementById('add-anexo');
    const dropzone = document.getElementById('dropzone-anexos');
    const hiddenMultiFile = document.getElementById('hidden-multi-file');
        
        // Pegando o prefixo do formset
        const prefix = '{{ anexos_formset.prefix }}';
        
        // Atualizando os campos quando um novo anexo é adicionado
        const updateElementIndex = function(el, prefix, ndx) {
            const id_regex = new RegExp('(' + prefix + '-\\d+)', 'g');
            const replacement = prefix + '-' + ndx;
            
            // Atualizar todos os elementos input, select, textarea
            el.querySelectorAll('input, select, textarea').forEach((element) => {
                ['id', 'name'].forEach((attr) => {
                    if (element.getAttribute(attr)) {
                        element.setAttribute(attr, element.getAttribute(attr).replace(id_regex, replacement));
                    }
                });
            });
            
            // Atualizando os atributos for de todas as labels dentro deste elemento
            el.querySelectorAll('label').forEach((label) => {
                if (label.getAttribute('for')) {
                    label.setAttribute('for', 
                        label.getAttribute('for').replace(id_regex, replacement)
                    );
                }
            });
            
            // Atualizar qualquer outro atributo que contenha o padrão
            el.querySelectorAll('*').forEach((element) => {
                ['data-target', 'data-toggle', 'aria-describedby'].forEach((attr) => {
                    if (element.getAttribute(attr)) {
                        element.setAttribute(attr, 
                            element.getAttribute(attr).replace(id_regex, replacement)
                        );
                    }
                });
            });
        };
        
        // Função para adicionar um novo anexo
        if(addAnexoBtn){
            addAnexoBtn.addEventListener('click', function(e) {
                e.preventDefault();
                // Reutiliza a mesma lógica de clone do primeiro form
                const formTemplate = anexosContainer.querySelector('.anexo-form');
                if (!formTemplate) return;
                const totalForms = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
                const currentFormCount = parseInt(totalForms.value);
                const newForm = formTemplate.cloneNode(true);
                const anexoAtualDiv = newForm.querySelector('.md-col-span-3.mb-2');
                if (anexoAtualDiv) anexoAtualDiv.remove();
                newForm.querySelectorAll('input, select, textarea').forEach((input) => {
                    if (input.type === 'hidden') {
                        if (input.name && input.name.includes('-id')) input.value = '';
                    } else {
                        input.value = '';
                    }
                });
                newForm.classList.remove('delete-form');
                const headerDiv = newForm.querySelector('.flex.items-center.justify-between.mb-2');
                const titulo = headerDiv.querySelector('h5');
                if (titulo) titulo.textContent = `Anexo #${currentFormCount + 1}`;
                let removeButton = headerDiv.querySelector('.remove-anexo');
                if (!removeButton) {
                    removeButton = document.createElement('button');
                    removeButton.type = 'button';
                    removeButton.className = 'remove-anexo inline-flex items-center justify-center rounded-md border border-destructive bg-destructive/10 px-2 py-1 text-xs font-medium text-destructive hover:bg-destructive/20 transition-colors';
                    removeButton.innerHTML = '<i class="bi bi-trash mr-1"></i>Remover';
                    headerDiv.appendChild(removeButton);
                }
                updateElementIndex(newForm, prefix, currentFormCount);
                totalForms.value = currentFormCount + 1;
                anexosContainer.appendChild(newForm);
                updateAnexoNumbers();
                setupRemoveButtons();
            });
        }
        
        // Função para remover anexo
        function setupRemoveButtons() {
            document.querySelectorAll('.remove-anexo').forEach(button => {
                // Remover event listeners antigos para evitar duplicação
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                newButton.addEventListener('click', function() {
                    // Encontrar o form pai
                    const anexoForm = this.closest('.anexo-form');
                    
                    // Verificar se é um anexo existente com campo DELETE
                    const deleteField = anexoForm.querySelector('input[name$="-DELETE"]');
                    if (deleteField) {
                        // Marcar para exclusão e ocultar visualmente
                        deleteField.value = 'on';
                        anexoForm.classList.add('delete-form');
                        anexoForm.style.display = 'none';
                    } else {
                        // Se for um novo anexo, remover completamente do DOM
                        anexoForm.remove();
                        
                        // Atualizar os índices dos formsets
                        const forms = document.querySelectorAll('.anexo-form');
                        const totalForms = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
                        totalForms.value = forms.length;
                        
                        // Atualizar os índices de cada formset
                        forms.forEach((form, idx) => {
                            updateElementIndex(form, prefix, idx);
                        });
                        
                        // Atualizar a numeração dos anexos
                        updateAnexoNumbers();
                    }
                });
            });
        }
        
        // Função para atualizar a numeração dos anexos
        function updateAnexoNumbers() {
            const anexoForms = document.querySelectorAll('.anexo-form:not([data-template-form])');
            anexoForms.forEach((form, index) => {
                const heading = form.querySelector('h5');
                if (heading) {
                    heading.textContent = `Anexo #${index + 1}`;
                }
            });
        }
        
        // Configurar botões de remoção ao carregar a página
    setupRemoveButtons();

        // -------- Drag & Drop --------
        function highlight(on){
            if(!dropzone) return; dropzone.classList.toggle('ring-2', on); dropzone.classList.toggle('ring-primary/50', on);
        }

        function createFormForFile(file){
            // Usar o template dedicado
            const templateForm = document.getElementById('template-anexo-form');
            if(!templateForm) return;
            
            const totalForms = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
            const currentIndex = parseInt(totalForms.value);
            
            // Clonar o template
            const formEl = templateForm.cloneNode(true);
            formEl.classList.remove('hidden');
            formEl.removeAttribute('id');
            formEl.removeAttribute('data-template-form');
            
            // Atualizar índices
            updateElementIndex(formEl, prefix, currentIndex);
            totalForms.value = currentIndex + 1;
            
            // Anexar ao container
            anexosContainer.appendChild(formEl);
            
            // Configurar o arquivo no input
            const inputFile = formEl.querySelector('input[type="file"]');
            if(inputFile){
                // Criar um DataTransfer para setar o File (somente navegadores modernos)
                const dt = new DataTransfer();
                dt.items.add(file);
                inputFile.files = dt.files;
                // Disparar evento change para atualizar qualquer listener e UI
                try { inputFile.dispatchEvent(new Event('change', { bubbles: true })); } catch(_) {}
            }
            
            // Preencher nome do anexo automaticamente
            const nomeInput = formEl.querySelector('input[name$="-nome_anexo"]');
            if(nomeInput && !nomeInput.value){ 
                nomeInput.value = file.name; 
            }
            
            // Atualizar o wrapper do arquivo para mostrar o nome do arquivo
            const fileWrapper = formEl.querySelector('[data-file-wrapper]');
            if(fileWrapper) {
                updateSingleWrapper(fileWrapper);
                const nameSpan = fileWrapper.querySelector('[data-file-name]');
                if(nameSpan) { nameSpan.textContent = file.name; }
            }
            
            // Atualizar numeração e botões
            updateAnexoNumbers();
            setupRemoveButtons();
            
            // Re-bind file wrappers para o novo form
            bindFileWrappers(formEl);
        }
        function handleFiles(files){
            const added = [];
            const failed = [];
            [...files].forEach(f=>{
                try {
                    createFormForFile(f);
                    added.push(f.name);
                } catch(err){
                    failed.push(f.name);
                }
            });
            // contador removido
            showAnexoFeedback(added, failed);
        }
        if(dropzone){
            ['dragenter','dragover'].forEach(evt=>dropzone.addEventListener(evt, e=>{e.preventDefault(); e.stopPropagation(); highlight(true);}));
            ['dragleave','drop'].forEach(evt=>dropzone.addEventListener(evt, e=>{e.preventDefault(); e.stopPropagation(); if(evt==='dragleave') highlight(false);}));
            dropzone.addEventListener('drop', e=>{highlight(false); if(e.dataTransfer?.files){ handleFiles(e.dataTransfer.files); }});
            dropzone.addEventListener('click', ()=> hiddenMultiFile?.click());
        }
        if(hiddenMultiFile){
            hiddenMultiFile.addEventListener('change', e=>{ handleFiles(e.target.files); hiddenMultiFile.value=''; });
        }
        // Atualiza contador também após remoções
    // contador removido - sem observer

        // Modal de feedback de anexos
        function ensureAnexoModal(){
            let modal = document.getElementById('anexoFeedbackModal');
            if(modal) return modal;
            modal = document.createElement('div');
            modal.id='anexoFeedbackModal';
            modal.className='fixed inset-0 z-50 hidden';
            modal.innerHTML = `
                <div class="absolute inset-0 bg-black/60" data-overlay></div>
                <div class="relative z-10 max-w-md w-full mx-auto mt-24 bg-card border rounded-lg shadow-lg overflow-hidden">
                    <div class="flex items-center justify-between px-5 py-3 border-b">
                        <h3 class="text-sm font-semibold flex items-center gap-2"><i class="bi bi-files"></i> Anexos</h3>
                        <button type="button" data-close class="p-1 rounded hover:bg-muted">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div class="p-5 space-y-4 text-sm" id="anexoFeedbackBody"></div>
                    <div class="px-5 py-3 border-t flex justify-end">
                        <button type="button" data-close class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-xs font-medium hover:bg-accent hover:text-accent-foreground">Fechar</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.addEventListener('click', e=>{ if(e.target.dataset.overlay!==undefined || e.target.closest('[data-close]')) closeAnexoModal(); });
            document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAnexoModal(); });
            return modal;
        }
        function openAnexoModal(){ const m=ensureAnexoModal(); m.classList.remove('hidden'); document.body.style.overflow='hidden'; }
        function closeAnexoModal(){ const m=document.getElementById('anexoFeedbackModal'); if(m){ m.classList.add('hidden'); document.body.style.overflow=''; } }
        function showAnexoFeedback(added, failed){
            if(!added.length && !failed.length) return;
            const modal = ensureAnexoModal();
            const body = modal.querySelector('#anexoFeedbackBody');
            let html='';
            if(added.length){
                html += `<div class="rounded-md border border-emerald-500/40 bg-emerald-500/10 p-3"><div class="font-medium text-emerald-600 text-xs mb-1 flex items-center gap-1"><i class='bi bi-check2-circle'></i> Adicionados</div><ul class='text-emerald-700 list-disc ml-4 space-y-1'>${added.map(a=>`<li>${a}</li>`).join('')}</ul></div>`;
            }
            if(failed.length){
                html += `<div class="rounded-md border border-destructive/40 bg-destructive/10 p-3"><div class="font-medium text-destructive text-xs mb-1 flex items-center gap-1"><i class='bi bi-exclamation-triangle'></i> Falharam</div><ul class='text-destructive list-disc ml-4 space-y-1'>${failed.map(a=>`<li>${a}</li>`).join('')}</ul></div>`;
            }
            body.innerHTML = html;
            openAnexoModal();
        }

        // Atualiza nomes de arquivos exibidos nos wrappers custom
        function updateSingleWrapper(wrapper){
            const input = wrapper.querySelector('input[type=file]');
            const nameSpan = wrapper.querySelector('[data-file-name]');
            if(!input || !nameSpan) return;
            if(input.files && input.files.length){
                nameSpan.textContent = input.files.length === 1 ? input.files[0].name : input.files.length + ' arquivos selecionados';
            } else {
                nameSpan.textContent = 'Nenhum arquivo';
            }
        }
        function bindFileWrappers(scope=document){
            scope.querySelectorAll('[data-file-wrapper]').forEach(wrapper=>{
                const input = wrapper.querySelector('input[type=file]');
                if(!input || wrapper.dataset.bound) return;
                wrapper.dataset.bound = '1';
                input.addEventListener('change', ()=> updateSingleWrapper(wrapper));
                updateSingleWrapper(wrapper);
            });
        }
        bindFileWrappers();
        // Re-bind after dynamic add (MutationObserver)
        const mo = new MutationObserver(()=> bindFileWrappers());
        mo.observe(document.getElementById('anexos-container'), {childList:true, subtree:true});
    });

        // Tailwind Error Modal (light replacement for bootstrap)
        function openErrorModal(){
                let modal=document.getElementById('errorModalTW');
                if(!modal){
                        modal=document.createElement('div');
                        modal.id='errorModalTW';
                        modal.className='fixed inset-0 z-50 flex items-center justify-center p-4';
                        modal.innerHTML=`<div class="absolute inset-0 bg-black/60" data-overlay></div>
                                <div class="relative z-10 w-full max-w-lg bg-card border rounded-lg shadow-lg overflow-hidden">
                                    <div class="flex items-center justify-between px-6 py-4 border-b bg-destructive/10">
                                        <h3 class="text-lg font-semibold text-destructive flex items-center gap-2"><i class="bi bi-exclamation-triangle-fill"></i> Erro no Formulário</h3>
                                        <button type="button" class="rounded-md p-2 hover:bg-muted" data-close><i class="bi bi-x"></i></button>
                                    </div>
                                    <div class="p-6 max-h-[60vh] overflow-y-auto text-sm" id="modalErrorContent"></div>
                                    <div class="flex justify-end px-6 py-4 border-t">
                                        <button type="button" data-close class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground">Fechar</button>
                                    </div>
                                </div>`;
                        document.body.appendChild(modal);
                        modal.addEventListener('click',e=>{if(e.target.dataset.overlay!==undefined||e.target.closest('[data-close]')){closeErrorModal();}});
                        document.addEventListener('keydown', escHandler);
                }
                modal.classList.remove('hidden');
                document.body.style.overflow='hidden';
        }
        function closeErrorModal(){
                const modal=document.getElementById('errorModalTW');
                if(modal){modal.classList.add('hidden'); document.body.style.overflow='';}
        }
        function escHandler(e){ if(e.key==='Escape'){ closeErrorModal(); } }

// ====== DRAG AND DROP PARA DECLARAÇÃO DE COMPENSAÇÃO ======
document.addEventListener('DOMContentLoaded', () => {
    const dropzone = document.getElementById('import-declaracao-dropzone');
    const fileInput = document.getElementById('declaracao-file-input');
    const statusDiv = document.getElementById('import-declaracao-status');
    
    if (!dropzone || !fileInput) return;
    
    const uploadUrl = dropzone.getAttribute('data-url');
    
    function getCookie(name) {
        const cookies = document.cookie ? document.cookie.split('; ') : [];
        for (let i = 0; i < cookies.length; i++) {
            const parts = cookies[i].split('=');
            if (decodeURIComponent(parts[0]) === name) {
                parts.shift();
                return decodeURIComponent(parts.join('='));
            }
        }
        return null;
    }
    
    function showStatus(message, type = 'info') {
        statusDiv.classList.remove('hidden', 'border-blue-200', 'bg-blue-50', 'text-blue-700',
                                   'border-green-200', 'bg-green-50', 'text-green-700',
                                   'border-red-200', 'bg-red-50', 'text-red-700');
        
        if (type === 'success') {
            statusDiv.classList.add('border-green-200', 'bg-green-50', 'text-green-700');
        } else if (type === 'error') {
            statusDiv.classList.add('border-red-200', 'bg-red-50', 'text-red-700');
        } else {
            statusDiv.classList.add('border-blue-200', 'bg-blue-50', 'text-blue-700');
        }
        
        statusDiv.innerHTML = message;
    }
    
    async function uploadFile(file) {
        const csrfToken = getCookie('csrftoken');
        if (!csrfToken) {
            showStatus('Erro: Token CSRF não encontrado', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('pdf', file);
        
        showStatus('<i class="bi bi-hourglass-split mr-2"></i>Processando arquivo...', 'info');
        
        try {
            const response = await fetch(uploadUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData,
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.ok) {
                const errorMsg = data.error || `Erro ${response.status}`;
                showStatus(`<i class="bi bi-x-circle mr-2"></i>${errorMsg}`, 'error');
                return;
            }
            
            const numDebitos = data.num_debitos || 0;
            const totalDebitos = data.total_debitos || 0;
            const perdcomp = data.perdcomp_declaracao || '';
            
            showStatus(`
                <div class="flex items-start gap-2">
                    <i class="bi bi-check-circle-fill text-lg"></i>
                    <div>
                        <div class="font-medium mb-1">Declaração importada com sucesso!</div>
                        <div class="text-xs space-y-1">
                            <div>PER/DCOMP: <strong>${perdcomp}</strong></div>
                            <div>Total de débitos: <strong>R$ ${totalDebitos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></div>
                            <div>Quantidade de itens: <strong>${numDebitos}</strong></div>
                        </div>
                        <div class="mt-2">
                            <a href="${data.detail_url || ''}" class="text-xs underline">Ver detalhes da adesão</a>
                        </div>
                    </div>
                </div>
            `, 'success');
            
        } catch (error) {
            showStatus(`<i class="bi bi-x-circle mr-2"></i>Erro ao processar: ${error.message}`, 'error');
        }
    }
    
    // Click to browse
    dropzone.addEventListener('click', () => fileInput.click());
    
    // Drag events
    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('border-primary', 'bg-muted/40');
    });
    
    dropzone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropzone.classList.remove('border-primary', 'bg-muted/40');
    });
    
    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('border-primary', 'bg-muted/40');
        
        const files = e.dataTransfer?.files;
        if (files && files.length > 0) {
            const file = files[0];
            if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                uploadFile(file);
            } else {
                showStatus('<i class="bi bi-x-circle mr-2"></i>Apenas arquivos PDF são aceitos', 'error');
            }
        }
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) {
            const file = e.target.files[0];
            if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                uploadFile(file);
            } else {
                showStatus('<i class="bi bi-x-circle mr-2"></i>Apenas arquivos PDF são aceitos', 'error');
            }
            fileInput.value = '';
        }
    });
});
</script>
{% endblock %}
