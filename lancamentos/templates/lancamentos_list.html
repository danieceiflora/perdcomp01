{% extends 'base.html' %}
{% load static %}
{% load utils_filters %}

{% block title %}Lista de Lançamentos{% endblock %}

{% block content %}
<!-- Hidden CSRF token for JavaScript access -->
{% csrf_token %}

<div class="max-w-7xl mx-auto px-4 py-6">
    {% if user.is_staff or user.is_superuser %}
    <div class="bg-card border rounded-lg shadow-sm mb-6">
        <div class="p-6">
            <div class="flex flex-col gap-4">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-card-foreground">Importar Recibos de Envio</h2>
                        <p class="text-sm text-muted-foreground">Carregue recibos de envio em PDF para atualizar lançamentos com informações de protocolo e status.</p>
                    </div>
                    <button type="button" id="importReciboToggleButton" aria-controls="importReciboDropZoneContainer" aria-expanded="false"
                            class="inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-2 text-sm font-medium text-card-foreground transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                        <i class="bi bi-chevron-down mr-2" aria-hidden="true"></i>
                        Expandir área
                    </button>
                </div>
                <div id="importReciboDropZoneContainer" class="transition-all duration-200 hidden" aria-hidden="true">
                    <div class="flex flex-col gap-4">
                        <div id="importReciboDropZone" role="button" tabindex="0"
                             data-recibo-url="{% url 'lancamentos:importar_recibo' %}"
                             class="relative flex flex-col items-center justify-center gap-3 rounded-lg border-2 border-dashed border-border bg-muted/30 p-5 text-center transition-all duration-200 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                            <input type="file" id="importReciboFileInput" accept="application/pdf" class="hidden" multiple />
                            <i class="bi bi-file-earmark-check text-3xl text-muted-foreground"></i>
                            <div>
                                <p class="text-sm font-medium text-card-foreground">Arraste recibos de envio aqui</p>
                                <p class="text-xs text-muted-foreground mt-1">ou clique para selecionar arquivos PDF</p>
                            </div>
                            <button type="button" id="importReciboBrowseButton"
                                    class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium text-card-foreground transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                                Selecionar PDFs
                            </button>
                            <div id="importReciboStatus" class="hidden w-full mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="processing-overlay" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" role="dialog" aria-modal="true" aria-labelledby="processingOverlayTitle">
        <div class="flex w-full max-w-md flex-col rounded-lg border border-border bg-card text-card-foreground shadow-2xl p-6 sm:p-8" tabindex="-1">
            <div class="mb-6 text-center">
                <h3 id="processingOverlayTitle" class="text-xl font-semibold mb-2">Processando declarações</h3>
                <p class="text-sm text-muted-foreground">Aguarde enquanto processamos as declarações selecionadas.</p>
            </div>
            <div class="flex justify-center mb-6">
                <div class="relative">
                    <div class="h-16 w-16 rounded-full border-4 border-primary/20"></div>
                    <div class="absolute inset-0 h-16 w-16 rounded-full border-4 border-primary border-t-transparent animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-primary">
                        <i class="bi bi-file-earmark-pdf text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <div class="mb-2 flex items-center justify-between text-sm text-muted-foreground">
                    <span id="overlay-progress-text">0 de 0 processados</span>
                    <span id="overlay-progress-percentage">0%</span>
                </div>
                <div class="h-3 w-full rounded-full bg-muted/60">
                    <div id="overlay-progress-bar" class="relative h-3 w-0 rounded-full bg-primary transition-all duration-300"></div>
                </div>
            </div>
            <div class="mb-4 rounded-lg bg-muted/40 px-4 py-3 text-center">
                <p class="text-xs text-muted-foreground">Processando:</p>
                <p id="overlay-current-file" class="truncate text-sm font-medium">—</p>
            </div>
            <div id="overlay-success-message" class="hidden rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-700 dark:border-green-500/40 dark:bg-green-500/15 dark:text-green-300">
                <div class="overlay-success-content flex items-center justify-center gap-2">
                    <i class="overlay-success-icon bi bi-check-circle-fill"></i>
                    <span id="overlay-success-text" class="font-medium">Processamento concluído!</span>
                </div>
                <div class="overlay-success-content flex items-center justify-center gap-2 mt-3">
                    <a href="{% url 'adesao:importacao_logs_page' %}" target="_blank" class="inline-flex items-center gap-1 rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                        <i class="bi bi-clipboard-data"></i>
                        Ver logs de importação
                    </a>
                </div>
            </div>
            <button id="overlay-close-btn" type="button" class="mt-6 hidden inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <i class="bi bi-check-lg mr-2"></i>OK, Fechar
            </button>
        </div>
    </div>

    <div class="bg-card border rounded-lg shadow-sm mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 p-6 border-b">
            <h1 class="text-2xl font-semibold text-card-foreground">Lançamentos</h1>
            <div class="flex flex-col sm:flex-row gap-3 w-full sm:flex-1 items-stretch">
                <form method="get" class="flex flex-1 min-w-0">
                    <div class="flex flex-1 min-w-0 items-stretch rounded-md border border-input overflow-hidden focus-within:ring-2 focus-within:ring-ring">
                        <input type="text" name="perdcomp" placeholder="PERDCOMP" value="{{ request.GET.perdcomp|default:'' }}" class="w-full bg-background px-3 py-2 text-sm outline-none" />
                        <button type="submit" class="inline-flex items-center justify-center bg-muted px-3 text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors">
                            <i class="bi bi-search"></i>
                        </button>
                        {% if request.GET.perdcomp %}
                        <a href="{% url 'lancamentos:list' %}" class="inline-flex items-center justify-center bg-muted px-3 text-sm font-medium text-muted-foreground hover:bg-destructive hover:text-destructive-foreground transition-colors">
                            <i class="bi bi-x-lg"></i>
                        </a>
                        {% endif %}
                    </div>
                </form>
                <form method="get" class="flex shrink-0" id="statusFilterForm">
                    {% if request.GET.perdcomp %}<input type="hidden" name="perdcomp" value="{{ request.GET.perdcomp }}">{% endif %}
                    <select name="aprovado" class="input w-auto min-w-max whitespace-nowrap">
                        <option value="">Status (todos)</option>
                        <option value="1" {% if request.GET.aprovado == '1' %}selected{% endif %}>Aprovados</option>
                        <option value="0" {% if request.GET.aprovado == '0' %}selected{% endif %}>Não aprovados</option>
                    </select>
                </form>
                <form method="get" action="{% url 'lancamentos:exportar_xlsx' %}" class="flex shrink-0">
                    {% if request.GET.perdcomp %}<input type="hidden" name="perdcomp" value="{{ request.GET.perdcomp }}">{% endif %}
                    {% if request.GET.aprovado %}<input type="hidden" name="aprovado" value="{{ request.GET.aprovado }}">{% endif %}
                    <button type="submit" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors">
                        <i class="bi bi-file-earmark-excel mr-2"></i><span>Exportar</span>
                    </button>
                </form>
                {% if user.is_staff or user.is_superuser %}
                <a href="{% url 'lancamentos:create' %}" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground px-4 py-2 text-sm font-medium hover:bg-primary/90 transition-colors shrink-0">
                    <i class="bi bi-plus mr-2"></i><span>Adicionar</span>
                </a>
                {% endif %}
            </div>
        </div>
        <div class="p-6">
            {% if resumo %}
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-card border rounded-md p-4">
                    <div class="text-sm text-muted-foreground">Aprovados — Quantidade</div>
                    <div class="mt-1 text-2xl font-semibold">{{ resumo.aprovados.qtd }}</div>
                </div>
                <div class="bg-card border rounded-md p-4">
                    <div class="text-sm text-muted-foreground">Aprovados — Total</div>
                    <div class="mt-1 text-2xl font-semibold text-green-600 dark:text-green-400">{{ resumo.aprovados.total|br_currency }}</div>
                </div>
                <div class="bg-card border rounded-md p-4">
                    <div class="text-sm text-muted-foreground">Não Aprovados — Quantidade</div>
                    <div class="mt-1 text-2xl font-semibold">{{ resumo.nao_aprovados.qtd }}</div>
                </div>
                <div class="bg-card border rounded-md p-4">
                    <div class="text-sm text-muted-foreground">Não Aprovados — Total</div>
                    <div class="mt-1 text-2xl font-semibold text-destructive">{{ resumo.nao_aprovados.total|br_currency }}</div>
                </div>
            </div>
            {% endif %}
            <div class="flex items-start gap-3 p-4 mb-6 rounded-md border bg-muted/30 text-sm text-muted-foreground">
                <i class="bi bi-info-circle text-base"></i>
                <span>O saldo restante indica o saldo da adesão após cada lançamento confirmado.</span>
            </div>
            {% if lancamentos %}
            <!-- Desktop table -->
            <div class="hidden md:block">
                <div class="rounded-md border overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b bg-muted/50 text-muted-foreground">
                                <th class="h-10 px-4 text-left font-medium">PER/DCOMP Adesão</th>
                                <th class="h-10 px-4 text-left font-medium">Declaração PER/DCOMP</th>
                                <th class="h-10 px-4 text-left font-medium">Cliente</th>
                                <th class="h-10 px-4 text-left font-medium">Data de Criação</th>
                                <th class="h-10 px-4 text-left font-medium">Valor</th>
                                <th class="h-10 px-4 text-left font-medium">Saldo Restante</th>
                                <th class="h-10 px-4 text-left font-medium">Anexos</th>
                                <th class="h-10 px-4 text-left font-medium">Aprovação</th>
                                <th class="h-10 px-4 text-left font-medium">Status Protocolo</th>
                                <th class="h-10 px-4 text-left font-medium">Ações</th>
                                <th class="h-10 px-4 text-left font-medium">Histórico</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lancamento in lancamentos %}
                            <tr class="border-b last:border-0 hover:bg-muted/50 transition-colors">
                                <td class="px-4 py-3 font-medium">{{ lancamento.id_adesao.perdcomp }}</td>
                                <td class="px-4 py-3">{{ lancamento.perdcomp_declaracao|default:'--' }}</td>
                                <td class="px-4 py-3">{% if lancamento.id_adesao.cliente.id_company_vinculada %}{{ lancamento.id_adesao.cliente.id_company_vinculada.razao_social }}{% else %}{{ lancamento.id_adesao.cliente }}{% endif %}</td>
                                <td class="px-4 py-3">{{ lancamento.data_criacao }}</td>
                                <td class="px-4 py-3 font-semibold {% if lancamento.sinal == '+' %}text-green-600 dark:text-green-400{% else %}text-destructive{% endif %}">{{ lancamento.sinal }} {{ lancamento.valor|br_currency }}</td>
                                <td class="px-4 py-3 font-semibold">{{ lancamento.saldo_restante|br_currency }}</td>
                                <td class="px-4 py-3"><span class="inline-flex items-center rounded-md bg-blue-500/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-300">{{ lancamento.anexos.count }} anexo(s)</span></td>
                                <td class="px-4 py-3">
                                    {% if lancamento.aprovado %}
                                    <span class="inline-flex items-center rounded-md bg-green-500/10 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-300"><i class="bi bi-check2-circle mr-1"></i>Aprovado</span>
                                    {% else %}
                                    <span class="inline-flex items-center rounded-md bg-red-500/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-300"><i class="bi bi-x-circle mr-1"></i>Não Aprovado</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3">
                                    {% if lancamento.status == 'protocolado' %}
                                    <span class="inline-flex items-center rounded-md bg-blue-500/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-300"><i class="bi bi-check-circle-fill mr-1"></i>Protocolado</span>
                                    {% elif lancamento.status == 'solicitado' %}
                                    <span class="inline-flex items-center rounded-md bg-gray-500/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-300"><i class="bi bi-clock-history mr-1"></i>Solicitado</span>
                                    {% else %}
                                    <span class="text-muted-foreground text-xs">--</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3">
                                    <a href="{% url 'lancamentos:detail' lancamento.pk %}" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium hover:bg-accent hover:text-accent-foreground transition-colors"><i class="bi bi-eye mr-1"></i>Detalhes</a>
                                </td>
                                <td class="px-4 py-3">
                                    <button class="inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium hover:bg-accent hover:text-accent-foreground transition-colors btn-history-lanc" data-id="{{ lancamento.id }}" title="Histórico"><i class="bi bi-clock-history"></i></button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Mobile cards -->
            <div class="md:hidden space-y-4">
                {% for lancamento in lancamentos %}
                <div class="bg-card border rounded-lg shadow-sm transition hover:shadow-md">
                    <div class="p-4 border-b flex items-center justify-between">
                        <div>
                            <div class="font-semibold">PER/DCOMP Adesão: {{ lancamento.id_adesao.perdcomp }}</div>
                            <div class="text-xs text-muted-foreground">Declaração: {{ lancamento.perdcomp_declaracao|default:'--' }}</div>
                        </div>
                        {% if lancamento.aprovado %}
                        <span class="inline-flex items-center rounded-md bg-green-500/10 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-300"><i class="bi bi-check2-circle mr-1"></i>Aprovado</span>
                        {% else %}
                        <span class="inline-flex items-center rounded-md bg-red-500/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-300"><i class="bi bi-x-circle mr-1"></i>Não Aprovado pelo cliente</span>
                        {% endif %}
                    </div>
                    <div class="p-4 space-y-2 text-sm">
                        <div><span class="text-muted-foreground">Cliente:</span> {% if lancamento.id_adesao.cliente.id_company_vinculada %}{{ lancamento.id_adesao.cliente.id_company_vinculada.razao_social }}{% else %}{{ lancamento.id_adesao.cliente }}{% endif %}</div>
                        <div><span class="text-muted-foreground">Declaração PER/DCOMP:</span> {{ lancamento.perdcomp_declaracao|default:'--' }}</div>
                        <div><span class="text-muted-foreground">Data:</span> {{ lancamento.data_lancamento|date:"d/m/Y" }}</div>
                        <div><span class="text-muted-foreground">Valor:</span> <span class="font-semibold {% if lancamento.sinal == '+' %}text-green-600 dark:text-green-400{% else %}text-destructive{% endif %}">{{ lancamento.sinal }} {{ lancamento.valor|br_currency }}</span></div>
                        <div><span class="text-muted-foreground">Saldo Restante:</span> <span class="font-semibold {% if lancamento.saldo_restante > 0 %}text-green-600 dark:text-green-400{% elif lancamento.saldo_restante < 0 %}text-destructive{% endif %}">{% if lancamento.saldo_restante != None %}{{ lancamento.saldo_restante|br_currency }}{% else %}<span class="text-muted-foreground">--</span>{% endif %}</span></div>
                        <div><span class="text-muted-foreground">Anexos:</span> <span class="inline-flex items-center rounded-md bg-blue-500/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-300">{{ lancamento.anexos.count }} anexo(s)</span></div>
                        <div>
                            <span class="text-muted-foreground">Status Protocolo:</span> 
                            {% if lancamento.status == 'protocolado' %}
                            <span class="inline-flex items-center rounded-md bg-blue-500/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-300"><i class="bi bi-check-circle-fill mr-1"></i>Protocolado</span>
                            {% elif lancamento.status == 'solicitado' %}
                            <span class="inline-flex items-center rounded-md bg-gray-500/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-300"><i class="bi bi-clock-history mr-1"></i>Solicitado</span>
                            {% else %}
                            <span class="text-muted-foreground">--</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="p-4 bg-muted/30 border-t flex flex-col gap-2">
                        <a href="{% url 'lancamentos:detail' lancamento.pk %}" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors"><i class="bi bi-eye mr-2"></i>Detalhes</a>
                        <button class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors btn-history-lanc" data-id="{{ lancamento.id }}"><i class="bi bi-clock-history mr-2"></i>Histórico</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if is_paginated %}
            <nav class="mt-8 flex justify-center" aria-label="Paginação">
                <div class="flex items-center gap-2">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.perdcomp %}&perdcomp={{ request.GET.perdcomp }}{% endif %}{% if request.GET.aprovado %}&aprovado={{ request.GET.aprovado }}{% endif %}" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground">Anterior</a>
                    {% endif %}
                    <span class="px-4 py-2 text-sm text-muted-foreground">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.perdcomp %}&perdcomp={{ request.GET.perdcomp }}{% endif %}{% if request.GET.aprovado %}&aprovado={{ request.GET.aprovado }}{% endif %}" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground">Próximo</a>
                    {% endif %}
                </div>
            </nav>
            {% endif %}
            {% else %}
            <div class="flex items-center gap-3 p-4 rounded-md border bg-muted/30 text-sm text-muted-foreground dark:text-muted-foreground" aria-live="polite">
                <i class="bi bi-info-circle text-blue-600 dark:text-blue-400"></i>
                <span class="font-medium">Nenhum lançamento cadastrado.</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Histórico Lançamento -->
<div id="historyLancModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-50" role="dialog" aria-modal="true" aria-labelledby="historyLancTitle">
    <div class="bg-background rounded-lg shadow-xl w-full max-w-5xl border" style="height:80vh;display:flex;flex-direction:column;">
        <div class="flex items-center justify-between px-6 py-4 border-b" style="flex-shrink:0;">
            <h3 id="historyLancTitle" class="text-lg font-semibold">Histórico do Lançamento</h3>
            <button type="button" class="rounded-md p-2 hover:bg-accent transition-colors" data-close-history>
                <i class="bi bi-x text-xl"></i>
            </button>
        </div>
        <div class="px-6 py-4" style="flex:1;overflow-y:auto;min-height:0;">
            <div id="history-lanc-loading" class="text-center py-8 hidden">
                <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-muted-foreground">Carregando histórico...</p>
            </div>
            <div id="historyLancContent">
                <div class="overflow-x-auto rounded-md border" id="historyLancTableWrap">
                    <table class="w-full text-sm" id="history-lanc-body-table">
                        <thead>
                            <tr class="border-b bg-muted/50 text-muted-foreground">
                                <th class="h-10 px-4 text-left font-medium">Data</th>
                                <th class="h-10 px-4 text-left font-medium">Usuário</th>
                                <th class="h-10 px-4 text-left font-medium">Tipo</th>
                                <th class="h-10 px-4 text-left font-medium">Alterações</th>
                            </tr>
                        </thead>
                        <tbody id="history-lanc-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="flex justify-end px-6 py-4 border-t" style="flex-shrink:0;">
            <button type="button" data-close-history class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm transition-colors hover:bg-accent hover:text-accent-foreground">Fechar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ====== DRAG AND DROP IMPORT FUNCTIONALITY ======
function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split('; ') : [];
    for (let i = 0; i < cookies.length; i++) {
        const parts = cookies[i].split('=');
        const cookieName = decodeURIComponent(parts[0]);
        if (cookieName === name) {
            parts.shift();
            return decodeURIComponent(parts.join('='));
        }
    }
    return null;
}

function getCSRFToken() {
    let token = getCookie('csrftoken');
    if (!token && window.CSRF_TOKEN) {
        token = window.CSRF_TOKEN;
    }
    if (!token) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            token = csrfInput.value;
        }
    }
    return token;
}

document.addEventListener('DOMContentLoaded', () => {
    const overlayEls = {
        root: document.getElementById('processing-overlay'),
        progressBar: document.getElementById('overlay-progress-bar'),
        progressText: document.getElementById('overlay-progress-text'),
        progressPercentage: document.getElementById('overlay-progress-percentage'),
        currentFile: document.getElementById('overlay-current-file'),
        closeBtn: document.getElementById('overlay-close-btn'),
        successMessage: document.getElementById('overlay-success-message'),
        successText: document.getElementById('overlay-success-text'),
        title: document.getElementById('processingOverlayTitle'),
    };

    function resetProcessingOverlay() {
        if (overlayEls.progressBar) overlayEls.progressBar.style.width = '0%';
        if (overlayEls.progressText) overlayEls.progressText.textContent = '0 de 0 processados';
        if (overlayEls.progressPercentage) overlayEls.progressPercentage.textContent = '0%';
        if (overlayEls.currentFile) overlayEls.currentFile.textContent = '—';
        if (overlayEls.successMessage) overlayEls.successMessage.classList.add('hidden');
        if (overlayEls.closeBtn) overlayEls.closeBtn.classList.add('hidden');
    }

    function updateOverlayProgress(current, total, currentFileName) {
        const safeTotal = Math.max(total || 0, 0);
        const safeCurrent = Math.min(Math.max(current || 0, 0), safeTotal);
        const percentage = safeTotal > 0 ? Math.round((safeCurrent / safeTotal) * 100) : 0;
        if (overlayEls.progressBar) overlayEls.progressBar.style.width = `${percentage}%`;
        if (overlayEls.progressText) overlayEls.progressText.textContent = `${safeCurrent} de ${safeTotal} processados`;
        if (overlayEls.progressPercentage) overlayEls.progressPercentage.textContent = `${percentage}%`;
        if (overlayEls.currentFile) {
            if (currentFileName) {
                overlayEls.currentFile.textContent = currentFileName;
            } else if (safeTotal > 0 && safeCurrent === safeTotal) {
                overlayEls.currentFile.textContent = 'Concluído!';
            }
        }
    }

    function showProcessingOverlay(total) {
        if (!overlayEls.root) return;
        resetProcessingOverlay();
        overlayEls.root.classList.remove('hidden');
        overlayEls.root.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        updateOverlayProgress(0, total || 0);
    }

    function showOverlaySummary(results) {
        if (!overlayEls.root) return;
        const safeResults = Array.isArray(results) ? results : [];
        const totalItems = safeResults.length;
        const successCount = safeResults.filter((item) => item && item.ok).length;
        const errorCount = totalItems - successCount;

        if (overlayEls.successMessage) {
            if (errorCount > 0) {
                overlayEls.successMessage.classList.remove('border-green-200', 'bg-green-50', 'dark:border-green-500/40', 'dark:bg-green-500/15');
                overlayEls.successMessage.classList.add('border-red-200', 'bg-red-50', 'dark:border-red-500/40', 'dark:bg-red-500/15');
                const successContent = overlayEls.successMessage.querySelector('.overlay-success-content');
                if (successContent) {
                    successContent.classList.remove('text-green-700', 'dark:text-green-300');
                    successContent.classList.add('text-red-700', 'dark:text-red-300');
                }
                const successIcon = overlayEls.successMessage.querySelector('.overlay-success-icon');
                if (successIcon) {
                    successIcon.classList.remove('bi-check-circle-fill');
                    successIcon.classList.add('bi-x-circle-fill');
                }
            }

            if (overlayEls.successText) {
                let summaryText = `${totalItems} declaração${totalItems === 1 ? '' : 'ões'} recebida${totalItems === 1 ? '' : 's'}. `;
                summaryText += `${successCount} processada${successCount === 1 ? '' : 's'}.`;
                if (errorCount > 0) {
                    summaryText += ` ${errorCount} erro${errorCount === 1 ? '' : 's'}.`;
                }
                overlayEls.successText.textContent = summaryText.trim();
            }
            overlayEls.successMessage.classList.remove('hidden');
        }

        if (overlayEls.currentFile) overlayEls.currentFile.textContent = 'Concluído!';
        if (overlayEls.closeBtn) {
            overlayEls.closeBtn.classList.remove('hidden');
            overlayEls.closeBtn.focus();
        }
    }

    function closeProcessingOverlay() {
        if (overlayEls.root) {
            overlayEls.root.classList.add('hidden');
            overlayEls.root.setAttribute('aria-hidden', 'true');
        }
        document.body.style.overflow = '';
        location.reload();
    }

    if (overlayEls.closeBtn) {
        overlayEls.closeBtn.addEventListener('click', closeProcessingOverlay);
    }

    if (overlayEls.root) {
        overlayEls.root.addEventListener('click', (event) => {
            if (event.target === overlayEls.root && overlayEls.closeBtn && !overlayEls.closeBtn.classList.contains('hidden')) {
                closeProcessingOverlay();
            }
        });
    }

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && overlayEls.root && !overlayEls.root.classList.contains('hidden') && overlayEls.closeBtn && !overlayEls.closeBtn.classList.contains('hidden')) {
            closeProcessingOverlay();
        }
    });

    // Toggle expand/collapse
    const toggleButton = document.getElementById('importToggleButton');
    const container = document.getElementById('importDropZoneContainer');

    if (toggleButton && container) {
        toggleButton.addEventListener('click', () => {
            const isExpanded = !container.classList.contains('hidden');
            if (isExpanded) {
                container.classList.add('hidden');
                toggleButton.setAttribute('aria-expanded', 'false');
                container.setAttribute('aria-hidden', 'true');
                toggleButton.innerHTML = '<i class="bi bi-chevron-down mr-2" aria-hidden="true"></i>Expandir área';
            } else {
                container.classList.remove('hidden');
                toggleButton.setAttribute('aria-expanded', 'true');
                container.setAttribute('aria-hidden', 'false');
                toggleButton.innerHTML = '<i class="bi bi-chevron-up mr-2" aria-hidden="true"></i>Recolher área';
            }
        });
    }

    // Drag and drop logic
    const dropZone = document.getElementById('importDropZone');
    const fileInput = document.getElementById('importFileInput');
    const browseButton = document.getElementById('importBrowseButton');
    const zoneOverlay = document.getElementById('importDropZoneOverlay');

    if (!dropZone || !fileInput) return;

    const compensacaoUrl = dropZone.getAttribute('data-compensacao-url');

    const toggleUploading = (isUploading, message) => {
        if (isUploading) {
            if (container) container.classList.remove('hidden');
            dropZone.classList.add('border-primary', 'bg-muted/40');
            if (zoneOverlay) zoneOverlay.classList.remove('hidden');
            if (browseButton) browseButton.disabled = true;
            dropZone.setAttribute('aria-busy', 'true');
        } else {
            dropZone.classList.remove('border-primary', 'bg-muted/40');
            if (zoneOverlay) zoneOverlay.classList.add('hidden');
            if (browseButton) browseButton.disabled = false;
            dropZone.removeAttribute('aria-busy');
        }
    };

    const uploadFile = async (file, index, total) => {
        try {
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                return {
                    ok: false,
                    message: `${file.name}: Token de segurança não encontrado. Recarregue a página.`,
                    file: file.name,
                };
            }

            const formData = new FormData();
            formData.append('pdf', file, file.name);

            const response = await fetch(compensacaoUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData,
            });

            const data = await response.json().catch(() => null);

            if (!response.ok || !data) {
                let errorDetail = `Status ${response.status}`;
                if (response.status === 403) errorDetail = 'Acesso negado (403)';
                else if (response.status === 401) errorDetail = 'Sessão expirada (401)';
                else if (response.status === 404) errorDetail = 'Endpoint não encontrado (404)';
                
                return {
                    ok: false,
                    message: `${file.name}: ${errorDetail}`,
                    file: file.name,
                };
            }

            if (!data.ok) {
                return {
                    ok: false,
                    message: `${file.name}: ${data.error || 'Erro ao processar'}`,
                    file: file.name,
                };
            }

            const createdCount = data.created_count || 0;
            const skippedCount = data.skipped_count || 0;
            const errorCount = data.error_count || 0;

            let message = `${file.name}: `;
            if (createdCount > 0) {
                message += `${createdCount} débito${createdCount === 1 ? '' : 's'} criado${createdCount === 1 ? '' : 's'}`;
            }
            if (skippedCount > 0) {
                message += `${createdCount > 0 ? ', ' : ''}${skippedCount} já existente${skippedCount === 1 ? '' : 's'}`;
            }
            if (errorCount > 0) {
                message += `${createdCount > 0 || skippedCount > 0 ? ', ' : ''}${errorCount} erro${errorCount === 1 ? '' : 's'}`;
            }

            return {
                ok: true,
                message: message,
                file: file.name,
                data,
            };
        } catch (error) {
            return {
                ok: false,
                message: `${file.name}: ${error.message || 'Erro desconhecido'}`,
                file: file.name,
            };
        }
    };

    const handleFiles = async (fileList) => {
        if (!fileList || !fileList.length) return;

        const filesArray = Array.from(fileList);
        const pdfFiles = filesArray.filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));

        if (!pdfFiles.length) {
            alert('Nenhum arquivo PDF válido selecionado.');
            return;
        }

        const total = pdfFiles.length;
        showProcessingOverlay(total);
        updateOverlayProgress(0, total);

        const results = [];
        for (let i = 0; i < pdfFiles.length; i++) {
            const file = pdfFiles[i];
            toggleUploading(true, `Enviando ${file.name} (${i + 1} de ${total})...`);
            updateOverlayProgress(i, total, file.name);
            
            const result = await uploadFile(file, i + 1, total);
            results.push(result);
            
            updateOverlayProgress(i + 1, total, i + 1 === total ? 'Concluído!' : undefined);
        }

        toggleUploading(false);
        showOverlaySummary(results);
        fileInput.value = '';
    };

    // Click to browse
    dropZone.addEventListener('click', () => {
        if (!dropZone.hasAttribute('aria-busy')) {
            fileInput.click();
        }
    });

    // Drag events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-primary', 'bg-muted/40');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-primary', 'bg-muted/40');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-primary', 'bg-muted/40');
        if (dropZone.hasAttribute('aria-busy')) return;
        
        const files = e.dataTransfer && e.dataTransfer.files;
        if (files && files.length) {
            handleFiles(files);
        }
    });

    // Browse button
    if (browseButton) {
        browseButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!dropZone.hasAttribute('aria-busy')) {
                fileInput.click();
            }
        });
    }

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length) {
            handleFiles(e.target.files);
        }
    });
});

// ====== RECIBO IMPORT FUNCTIONALITY ======
document.addEventListener('DOMContentLoaded', () => {
    const reciboToggleButton = document.getElementById('importReciboToggleButton');
    const reciboContainer = document.getElementById('importReciboDropZoneContainer');
    const reciboDropZone = document.getElementById('importReciboDropZone');
    const reciboFileInput = document.getElementById('importReciboFileInput');
    const reciboBrowseButton = document.getElementById('importReciboBrowseButton');
    const reciboStatus = document.getElementById('importReciboStatus');

    if (!reciboDropZone || !reciboFileInput) return;

    const reciboUrl = reciboDropZone.getAttribute('data-recibo-url');

    // Toggle expand/collapse
    if (reciboToggleButton && reciboContainer) {
        reciboToggleButton.addEventListener('click', () => {
            const isExpanded = !reciboContainer.classList.contains('hidden');
            if (isExpanded) {
                reciboContainer.classList.add('hidden');
                reciboToggleButton.setAttribute('aria-expanded', 'false');
                reciboContainer.setAttribute('aria-hidden', 'true');
                reciboToggleButton.innerHTML = '<i class="bi bi-chevron-down mr-2" aria-hidden="true"></i>Expandir área';
            } else {
                reciboContainer.classList.remove('hidden');
                reciboToggleButton.setAttribute('aria-expanded', 'true');
                reciboContainer.setAttribute('aria-hidden', 'false');
                reciboToggleButton.innerHTML = '<i class="bi bi-chevron-up mr-2" aria-hidden="true"></i>Recolher área';
            }
        });
    }

    const showReciboStatus = (message, type) => {
        if (!reciboStatus) return;
        reciboStatus.classList.remove('hidden');
        reciboStatus.className = 'w-full mt-2 p-3 rounded-md text-sm';
        
        if (type === 'success') {
            reciboStatus.classList.add('bg-green-50', 'dark:bg-green-500/15', 'border', 'border-green-200', 'dark:border-green-500/40', 'text-green-700', 'dark:text-green-300');
            reciboStatus.innerHTML = `<div class="flex items-start gap-2"><i class="bi bi-check-circle-fill mt-0.5"></i><div>${message}</div></div>`;
        } else if (type === 'error') {
            reciboStatus.classList.add('bg-red-50', 'dark:bg-red-500/15', 'border', 'border-red-200', 'dark:border-red-500/40', 'text-red-700', 'dark:text-red-300');
            reciboStatus.innerHTML = `<div class="flex items-start gap-2"><i class="bi bi-x-circle-fill mt-0.5"></i><div>${message}</div></div>`;
        } else {
            reciboStatus.classList.add('bg-blue-50', 'dark:bg-blue-500/15', 'border', 'border-blue-200', 'dark:border-blue-500/40', 'text-blue-700', 'dark:text-blue-300');
            reciboStatus.innerHTML = `<div class="flex items-start gap-2"><i class="bi bi-info-circle-fill mt-0.5"></i><div>${message}</div></div>`;
        }
    };

    const uploadRecibo = async (file) => {
        try {
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                return { ok: false, file: file.name, error: 'Token de segurança não encontrado' };
            }

            const formData = new FormData();
            formData.append('pdf', file, file.name);

            const response = await fetch(reciboUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData,
            });

            const data = await response.json().catch(() => null);

            if (!response.ok || !data) {
                let errorDetail = data?.error || `Erro ${response.status}`;
                if (response.status === 403) errorDetail = 'Acesso negado';
                else if (response.status === 401) errorDetail = 'Sessão expirada';
                else if (response.status === 404) errorDetail = data?.error || 'Lançamento não encontrado';
                else if (response.status === 400) errorDetail = data?.error || 'Erro na validação';
                
                return { ok: false, file: file.name, error: errorDetail };
            }

            if (!data.ok) {
                return { ok: false, file: file.name, error: data.error || 'Erro ao processar' };
            }

            return { 
                ok: true, 
                file: file.name,
                data: data
            };

        } catch (error) {
            return { ok: false, file: file.name, error: error.message || 'Erro desconhecido' };
        }
    };

    const handleReciboFiles = async (files) => {
        if (!files || files.length === 0) return;

        const filesArray = Array.from(files);
        const pdfFiles = filesArray.filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));

        if (pdfFiles.length === 0) {
            showReciboStatus('Nenhum arquivo PDF válido selecionado.', 'error');
            return;
        }

        showReciboStatus(`Processando ${pdfFiles.length} arquivo(s)...`, 'info');

        const results = [];
        for (const file of pdfFiles) {
            const result = await uploadRecibo(file);
            results.push(result);
        }

        // Gerar resumo
        const success = results.filter(r => r.ok);
        const errors = results.filter(r => !r.ok);

        let summary = '';
        
        if (success.length > 0) {
            summary += `<div class="mb-3"><strong>${success.length} recibo(s) importado(s) com sucesso:</strong><ul class="mt-1 ml-4 list-disc text-xs">`;
            success.forEach(s => {
                const doc = s.data?.numero_documento || '--';
                const ctrl = s.data?.numero_controle || '--';
                summary += `<li><strong>${s.file}</strong><br/>PER/DCOMP: ${doc}, Controle: ${ctrl}</li>`;
            });
            summary += `</ul></div>`;
        }

        if (errors.length > 0) {
            summary += `<div class="p-2 bg-red-100 dark:bg-red-900/20 rounded border border-red-300 dark:border-red-700"><strong>${errors.length} erro(s):</strong><ul class="mt-1 ml-4 list-disc text-xs">`;
            errors.forEach(e => {
                summary += `<li><strong>${e.file}</strong>: ${e.error}</li>`;
            });
            summary += `</ul></div>`;
        }

        const type = errors.length === 0 ? 'success' : (success.length > 0 ? 'success' : 'error');
        showReciboStatus(summary, type);

        // Limpar input
        reciboFileInput.value = '';

        // Reload após sucesso
        if (success.length > 0) {
            setTimeout(() => location.reload(), 5000);
        }
    };

    // Click to browse
    reciboDropZone.addEventListener('click', () => {
        reciboFileInput.click();
    });

    // Drag events
    reciboDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        reciboDropZone.classList.add('border-primary', 'bg-muted/40');
    });

    reciboDropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        reciboDropZone.classList.remove('border-primary', 'bg-muted/40');
    });

    reciboDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        reciboDropZone.classList.remove('border-primary', 'bg-muted/40');
        
        const files = e.dataTransfer && e.dataTransfer.files;
        if (files && files.length > 0) {
            handleReciboFiles(files);
        }
    });

    // Browse button
    if (reciboBrowseButton) {
        reciboBrowseButton.addEventListener('click', (e) => {
            e.stopPropagation();
            reciboFileInput.click();
        });
    }

    // File input change
    reciboFileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) {
            handleReciboFiles(e.target.files);
        }
    });
});

// ====== STATUS FILTER AUTO-SUBMIT ======
document.addEventListener('DOMContentLoaded', function(){
    const form = document.getElementById('statusFilterForm');
    if(!form) return;
    const sel = form.querySelector('select[name="aprovado"]');
    if(!sel) return;
    sel.addEventListener('change', function(){
        form.submit();
    });
});

// ====== MODAL HISTÓRICO LANÇAMENTO ======
const historyLancModal = document.getElementById('historyLancModal');
const historyLancBody = document.getElementById('history-lanc-body');
const historyLancLoading = document.getElementById('history-lanc-loading');

function openHistoryLanc() {
    historyLancModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeHistoryLanc() {
    historyLancModal.classList.add('hidden');
    document.body.style.overflow = '';
}

historyLancModal.addEventListener('click', e => { 
    if (e.target === historyLancModal) closeHistoryLanc(); 
});

historyLancModal.querySelectorAll('[data-close-history]').forEach(btn => 
    btn.addEventListener('click', closeHistoryLanc)
);

document.addEventListener('keydown', e => { 
    if (e.key === 'Escape' && !historyLancModal.classList.contains('hidden')) closeHistoryLanc(); 
});

document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.btn-history-lanc');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    historyLancBody.innerHTML='';
    historyLancLoading.classList.remove('hidden');
    openHistoryLanc();
    try {
        const base = window.location.origin + window.location.pathname;
        const resp = await fetch(base + 'historico/' + id + '/');
        if(!resp.ok) throw new Error('Falha ao carregar histórico');
        const data = await resp.json();
        const hist = data.history || [];
        hist.forEach(entry => {
            const tr = document.createElement('tr');
            tr.className = 'border-b last:border-0 hover:bg-muted/50';
            const tipoMap = { '+':'Criação','~':'Atualização','-':'Exclusão' };
            const tipoClass = { 
                '+':'bg-green-500/10 text-green-700 dark:text-green-300',
                '~':'bg-blue-500/10 text-blue-700 dark:text-blue-300',
                '-':'bg-red-500/10 text-red-700 dark:text-red-300' 
            };
            const alterations = (entry.changes || []).map(c => {
                const oldVal = c.old === null ? '<em class="text-muted-foreground">(vazio)</em>' : c.old;
                const newVal = c.new === null ? '<em class="text-muted-foreground">(vazio)</em>' : c.new;
                return `<div class="mb-2"><span class="inline-flex items-center rounded-md bg-muted px-2 py-0.5 text-xs font-medium text-muted-foreground">${c.field}</span> <span class="font-medium">${oldVal}</span> → <span class="font-medium">${newVal}</span></div>`;
            }).join('');
            const note = entry.note ? `<div class="text-xs text-muted-foreground">${entry.note}</div>` : '';
            tr.innerHTML = `
                <td class='px-4 py-3 align-top'>${entry.history_date}</td>
                <td class='px-4 py-3 align-top'>${entry.history_user||'-'}</td>
                <td class='px-4 py-3 align-top'><span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium ${tipoClass[entry.history_type]||'bg-muted text-muted-foreground'}">${tipoMap[entry.history_type]||entry.history_type}</span></td>
                <td class='px-4 py-3'>${alterations || note || '<span class="text-muted-foreground">Nenhuma alteração</span>'}</td>`;
            historyLancBody.appendChild(tr);
        });
        if(hist.length===0){
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="4" class="px-4 py-8 text-center text-muted-foreground">Nenhum histórico encontrado</td>`;
            historyLancBody.appendChild(tr);
        }
    } catch(err){
        const tr=document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="px-4 py-4 text-center text-destructive">${err.message}</td>`;
        historyLancBody.appendChild(tr);
    } finally {
        historyLancLoading.classList.add('hidden');
    }
});
</script>
{% endblock %}
