{% extends 'base.html' %}
{% load static %}
{% load utils_filters %}

{% block title %}Lista de Lançamentos{% endblock %}

{% block content %}
<!-- Hidden CSRF token for JavaScript access -->
{% csrf_token %}

<div class="w-full px-2 py-6 sm:px-4">
    {% if user.is_staff or user.is_superuser %}
    <div class="bg-card border rounded-lg shadow-sm mb-6">
        <div class="p-6">
            <div class="flex flex-col gap-4">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-card-foreground">Importar Recibos de Envio</h2>
                        <p class="text-sm text-muted-foreground">Carregue recibos de envio em PDF para atualizar lançamentos com informações de protocolo e status.</p>
                    </div>
                    <button type="button" id="importReciboToggleButton" aria-controls="importReciboDropZoneContainer" aria-expanded="false"
                            class="inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-2 text-sm font-medium text-card-foreground transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                        <i class="bi bi-chevron-down mr-2" aria-hidden="true"></i>
                        Expandir área
                    </button>
                </div>
                <div id="importReciboDropZoneContainer" class="transition-all duration-200 hidden" aria-hidden="true">
                    <div class="flex flex-col gap-4">
                        <div id="importReciboDropZone" role="button" tabindex="0"
                             data-recibo-url="{% url 'lancamentos:importar_recibo' %}"
                             class="relative flex flex-col items-center justify-center gap-3 rounded-lg border-2 border-dashed border-border bg-muted/30 p-5 text-center transition-all duration-200 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                            <input type="file" id="importReciboFileInput" accept="application/pdf" class="hidden" multiple />
                            <i class="bi bi-file-earmark-check text-3xl text-muted-foreground"></i>
                            <div>
                                <p class="text-sm font-medium text-card-foreground">Arraste recibos de envio aqui</p>
                                <p class="text-xs text-muted-foreground mt-1">ou clique para selecionar arquivos PDF</p>
                            </div>
                            <button type="button" id="importReciboBrowseButton"
                                    class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium text-card-foreground transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                                Selecionar PDFs
                            </button>
                            <div id="importReciboStatus" class="hidden w-full mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Overlay de Progresso para Recibos -->
    <div id="recibo-processing-overlay" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" role="dialog" aria-modal="true">
        <div class="flex w-full max-w-md flex-col rounded-lg border border-border bg-card text-card-foreground shadow-2xl p-6 sm:p-8" tabindex="-1">
            <div class="mb-6 text-center">
                <h3 class="text-xl font-semibold mb-2">Processando recibos</h3>
                <p class="text-sm text-muted-foreground">Aguarde enquanto processamos os recibos de envio.</p>
            </div>
            <div class="flex justify-center mb-6">
                <div class="relative">
                    <div class="h-16 w-16 rounded-full border-4 border-primary/20"></div>
                    <div class="absolute inset-0 h-16 w-16 rounded-full border-4 border-primary border-t-transparent animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-primary">
                        <i class="bi bi-file-earmark-check text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <div class="mb-2 flex items-center justify-between text-sm text-muted-foreground">
                    <span id="recibo-overlay-progress-text">0 de 0 processados</span>
                    <span id="recibo-overlay-progress-percentage">0%</span>
                </div>
                <div class="h-3 w-full rounded-full bg-muted/60">
                    <div id="recibo-overlay-progress-bar" class="relative h-3 w-0 rounded-full bg-primary transition-all duration-300"></div>
                </div>
            </div>
            <div class="mb-4 rounded-lg bg-muted/40 px-4 py-3 text-center">
                <p class="text-xs text-muted-foreground">Processando:</p>
                <p id="recibo-overlay-current-file" class="truncate text-sm font-medium">—</p>
            </div>
            <div id="recibo-overlay-success-message" class="hidden rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-700 dark:border-green-500/40 dark:bg-green-500/15 dark:text-green-300">
                <div class="flex items-center justify-center gap-2">
                    <i class="bi bi-check-circle-fill"></i>
                    <span id="recibo-overlay-success-text" class="font-medium">Processamento concluído!</span>
                </div>

                <div class="flex items-center justify-center gap-2 mt-3">
                    <a href="{% url 'importacao_logs' %}" target="_blank" class="inline-flex items-center gap-1 rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                        <i class="bi bi-clipboard-data"></i>
                        Ver logs de importação
                    </a>
                </div>
            </div>
            <button id="recibo-overlay-close-btn" type="button" class="mt-6 hidden inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <i class="bi bi-check-lg mr-2"></i>OK, Fechar
            </button>
        </div>
    </div>

    <div class="bg-card border rounded-lg shadow-sm mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-6 border-b">
            <h1 class="text-2xl font-semibold text-card-foreground mb-4 sm:mb-0">Lista de Lançamentos</h1>
            {% if user.is_staff or user.is_superuser %}
            <a href="{% url 'lancamentos:create' %}" 
               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                <i class="bi bi-plus mr-2"></i>
                Novo Lançamento
            </a>
            {% endif %}
        </div>
        
        <div class="p-6">
            <!-- Filtros e Resumo -->
            <div class="mb-6 space-y-4">
                <!-- Filtros -->
                <form method="get" class="flex flex-col sm:flex-row gap-3 w-full">
                    <div class="flex items-stretch rounded-md border border-input overflow-hidden w-full sm:flex-1">
                        <input type="text" name="perdcomp" placeholder="Buscar PERDCOMP" value="{{ request.GET.perdcomp|default:'' }}" class="flex-1 bg-background px-3 py-2 text-sm outline-none min-w-0" />
                        <button type="submit" class="inline-flex items-center justify-center bg-muted px-3 text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors" title="Buscar">
                            <i class="bi bi-search"></i>
                        </button>
                        {% if request.GET.perdcomp or request.GET.aprovado %}
                        <a href="{% url 'lancamentos:list' %}" class="inline-flex items-center justify-center bg-muted px-3 text-sm font-medium text-muted-foreground hover:bg-destructive hover:text-destructive-foreground transition-colors" title="Limpar filtros">
                            <i class="bi bi-x-lg"></i>
                        </a>
                        {% endif %}
                    </div>
                    <div class="flex items-stretch rounded-md border border-input overflow-hidden w-full sm:w-auto">
                        <span class="inline-flex items-center px-3 text-sm text-muted-foreground bg-muted whitespace-nowrap">Status</span>
                        <select name="aprovado" class="bg-background px-3 py-2 text-sm outline-none" id="statusFilterForm">
                            <option value="">Todos</option>
                            <option value="1" {% if request.GET.aprovado == '1' %}selected{% endif %}>Aprovados</option>
                            <option value="0" {% if request.GET.aprovado == '0' %}selected{% endif %}>Não aprovados</option>
                        </select>
                    </div>
                    <button type="button" onclick="window.location.href='{% url 'lancamentos:exportar_xlsx' %}?{% if request.GET.perdcomp %}perdcomp={{ request.GET.perdcomp }}&{% endif %}{% if request.GET.aprovado %}aprovado={{ request.GET.aprovado }}{% endif %}'" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground transition-colors whitespace-nowrap">
                        <i class="bi bi-file-earmark-excel mr-2"></i>Exportar
                    </button>
                </form>
                <!-- Resumo Sintético -->
                {% if resumo %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                        <div class="p-4 flex items-center">
                            <div class="flex items-center justify-center w-12 h-12 bg-green-500/10 rounded-full mr-3">
                                <i class="bi bi-check-circle text-green-600 dark:text-green-500"></i>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Aprovados — Qtd</div>
                                <div class="text-2xl font-bold">{{ resumo.aprovados.qtd }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                        <div class="p-4 flex items-center">
                            <div class="flex items-center justify-center w-12 h-12 bg-green-500/10 rounded-full mr-3">
                                <i class="bi bi-wallet2 text-green-600 dark:text-green-500"></i>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Aprovados — Total</div>
                                <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ resumo.aprovados.total|br_currency }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                        <div class="p-4 flex items-center">
                            <div class="flex items-center justify-center w-12 h-12 bg-red-500/10 rounded-full mr-3">
                                <i class="bi bi-x-circle text-red-600 dark:text-red-500"></i>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Não Aprovados — Qtd</div>
                                <div class="text-2xl font-bold">{{ resumo.nao_aprovados.qtd }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                        <div class="p-4 flex items-center">
                            <div class="flex items-center justify-center w-12 h-12 bg-red-500/10 rounded-full mr-3">
                                <i class="bi bi-wallet text-red-600 dark:text-red-500"></i>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Não Aprovados — Total</div>
                                <div class="text-2xl font-bold text-destructive">{{ resumo.nao_aprovados.total|br_currency }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% if lancamentos %}
            <!-- Desktop Table View -->
            <div class="hidden md:block">
                <div class="rounded-md border overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b bg-muted/50 text-muted-foreground">
                                    <th class="h-12 px-4 text-left text-sm font-medium">PER/DCOMP Adesão</th>
                                    <th class="h-12 px-4 text-left text-sm font-medium">Declaração</th>
                                    <th class="h-12 px-4 text-left text-sm font-medium">Cliente</th>
                                    <th class="h-12 px-4 text-left text-sm font-medium">Data</th>
                                    <th class="h-12 px-4 text-left text-sm font-medium">Valor</th>
                                    <th class="h-12 px-4 text-left text-sm font-medium">Saldo Restante</th>
                                    <th class="h-12 px-4 text-left text-sm font-medium">Protocolo</th>
                                    <th class="h-12 px-4 text-left text-sm font-medium">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lancamento in lancamentos %}
                                <tr class="border-b transition-colors hover:bg-muted/50">
                                    <td class="p-4 align-middle font-medium">{{ lancamento.id_adesao.perdcomp }}</td>
                                    <td class="p-4 align-middle">{{ lancamento.perdcomp_declaracao|default:'—' }}</td>
                                    <td class="p-4 align-middle">{% if lancamento.id_adesao.cliente.id_company_vinculada %}{{ lancamento.id_adesao.cliente.id_company_vinculada.razao_social }}{% else %}{{ lancamento.id_adesao.cliente }}{% endif %}</td>
                                    <td class="p-4 align-middle">{{ lancamento.data_criacao|date:"d/m/Y" }}</td>
                                    <td class="p-4 align-middle font-semibold {% if lancamento.sinal == '+' %}text-green-600 dark:text-green-400{% else %}text-destructive{% endif %}">{{ lancamento.sinal }} {{ lancamento.valor|br_currency }}</td>
                                    <td class="p-4 align-middle font-semibold">{{ lancamento.saldo_restante|br_currency }}</td>
                                    <td class="p-4 align-middle">
                                        {% if lancamento.status == 'protocolado' %}
                                        <span class="inline-flex items-center rounded-md bg-blue-500/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-300">
                                            <i class="bi bi-check-circle-fill mr-1"></i>Protocolado
                                        </span>
                                        {% elif lancamento.status == 'retificado' %}
                                        <span class="inline-flex items-center rounded-md bg-amber-500/10 px-2 py-1 text-xs font-medium text-amber-700 dark:text-amber-300">
                                            <i class="bi bi-arrow-repeat mr-1"></i>Retificado
                                        </span>
                                        {% elif lancamento.status == 'estornado' %}
                                        <span class="inline-flex items-center rounded-md bg-purple-500/10 px-2 py-1 text-xs font-medium text-purple-700 dark:text-purple-300">
                                            <i class="bi bi-arrow-counterclockwise mr-1"></i>Estornado
                                        </span>
                                        {% elif lancamento.status == 'solicitado' %}
                                        <span class="inline-flex items-center rounded-md bg-gray-500/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-300">
                                            <i class="bi bi-clock-history mr-1"></i>Solicitado
                                        </span>
                                        {% else %}
                                        <span class="text-muted-foreground text-xs">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="p-4 align-middle">
                                        <div class="flex items-center gap-2">
                                            <a href="{% url 'lancamentos:detail' lancamento.pk %}" 
                                               class="inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium hover:bg-accent hover:text-accent-foreground transition-colors">
                                                <i class="bi bi-eye mr-1"></i>Ver
                                            </a>
                                            <button class="inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium hover:bg-accent hover:text-accent-foreground transition-colors btn-history-lanc" 
                                                    data-id="{{ lancamento.id }}" 
                                                    title="Histórico">
                                                <i class="bi bi-clock-history"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            
            <!-- Mobile Card View -->
            <div class="block md:hidden space-y-4">
                {% for lancamento in lancamentos %}
                <div class="bg-card border rounded-lg shadow-sm transition-all duration-200 hover:-translate-y-1 hover:shadow-md">
                    <div class="p-4 border-b">
                        <h3 class="font-semibold text-card-foreground">
                            <span class="text-muted-foreground">PERDCOMP Adesão:</span> {{ lancamento.id_adesao.perdcomp }}
                        </h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <div>
                            <span class="text-sm font-medium text-muted-foreground">Cliente:</span>
                            <div class="font-medium">{% if lancamento.id_adesao.cliente.id_company_vinculada %}{{ lancamento.id_adesao.cliente.id_company_vinculada.razao_social }}{% else %}{{ lancamento.id_adesao.cliente }}{% endif %}</div>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-muted-foreground">Declaração PER/DCOMP:</span>
                            <div class="font-medium">{{ lancamento.perdcomp_declaracao|default:'—' }}</div>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-muted-foreground">Data:</span>
                            <div class="font-medium">{{ lancamento.data_lancamento|date:"d/m/Y" }}</div>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-muted-foreground">Valor:</span>
                            <div class="font-semibold {% if lancamento.sinal == '+' %}text-green-600 dark:text-green-400{% else %}text-destructive{% endif %}">
                                {{ lancamento.sinal }} {{ lancamento.valor|br_currency }}
                            </div>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-muted-foreground">Saldo Restante:</span>
                            <div class="font-semibold">{{ lancamento.saldo_restante|br_currency }}</div>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-muted-foreground">Status Protocolo:</span> 
                            {% if lancamento.status == 'protocolado' %}
                            <span class="inline-flex items-center rounded-md bg-blue-500/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-300">
                                <i class="bi bi-check-circle-fill mr-1"></i>Protocolado
                            </span>
                            {% elif lancamento.status == 'retificado' %}
                            <span class="inline-flex items-center rounded-md bg-amber-500/10 px-2 py-1 text-xs font-medium text-amber-700 dark:text-amber-300">
                                <i class="bi bi-arrow-repeat mr-1"></i>Retificado
                            </span>
                            {% elif lancamento.status == 'estornado' %}
                            <span class="inline-flex items-center rounded-md bg-purple-500/10 px-2 py-1 text-xs font-medium text-purple-700 dark:text-purple-300">
                                <i class="bi bi-arrow-counterclockwise mr-1"></i>Estornado
                            </span>
                            {% elif lancamento.status == 'solicitado' %}
                            <span class="inline-flex items-center rounded-md bg-gray-500/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-300">
                                <i class="bi bi-clock-history mr-1"></i>Solicitado
                            </span>
                            {% else %}
                            <span class="text-muted-foreground">—</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="p-4 bg-muted/30 border-t flex flex-col gap-2">
                        <a href="{% url 'lancamentos:detail' lancamento.pk %}" 
                           class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 w-full">
                            <i class="bi bi-eye mr-2"></i>Ver Detalhes
                        </a>
                        <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 w-full btn-history-lanc" 
                                data-id="{{ lancamento.id }}">
                            <i class="bi bi-clock-history mr-2"></i>Histórico
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
            <nav class="flex items-center justify-center mt-8" aria-label="Navegação de páginas">
                <div class="flex items-center gap-2">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.perdcomp %}&perdcomp={{ request.GET.perdcomp }}{% endif %}{% if request.GET.aprovado %}&aprovado={{ request.GET.aprovado }}{% endif %}" 
                       class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                        <i class="bi bi-chevron-left mr-2"></i>Anterior
                    </a>
                    {% endif %}
                    
                    <span class="flex items-center px-4 py-2 text-sm text-muted-foreground">
                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                    </span>
                    
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.perdcomp %}&perdcomp={{ request.GET.perdcomp }}{% endif %}{% if request.GET.aprovado %}&aprovado={{ request.GET.aprovado }}{% endif %}" 
                       class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                        Próximo<i class="bi bi-chevron-right ml-2"></i>
                    </a>
                    {% endif %}
                </div>
            </nav>
            {% endif %}
            {% else %}
            <div class="flex items-center p-4 bg-blue-50 dark:bg-slate-800 border border-blue-200 dark:border-slate-600 rounded-lg">
                <i class="bi bi-info-circle text-blue-600 dark:text-blue-400 mr-3"></i>
                <span class="text-blue-800 dark:text-white">Nenhum lançamento cadastrado.</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Histórico Lançamento -->
<div id="historyLancModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-50" role="dialog" aria-modal="true" aria-labelledby="historyLancTitle">
    <div class="bg-background rounded-lg shadow-xl w-full max-w-lg sm:max-w-3xl md:max-w-5xl lg:max-w-6xl 2xl:max-w-[90rem] border border-border" style="height:80vh;display:flex;flex-direction:column;">
        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b" style="flex-shrink:0;">
            <h3 id="historyLancTitle" class="text-lg font-semibold">Histórico do Lançamento</h3>
            <button type="button" data-close-history class="rounded-md p-2 hover:bg-accent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" title="Fechar">
                <i class="bi bi-x text-xl"></i>
            </button>
        </div>
        <!-- Body -->
        <div class="px-6 py-4" style="flex:1;overflow-y:auto;min-height:0;">
            <div id="history-lanc-loading" class="text-center py-8 hidden">
                <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-muted-foreground">Carregando histórico...</p>
            </div>
            <div class="overflow-x-auto rounded-md border" id="historyLancTableWrap">
                <table class="w-full" id="history-lanc-body-table">
                    <thead class="border-b bg-muted/50">
                        <tr>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Data</th>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Usuário</th>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Tipo</th>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Alterações</th>
                        </tr>
                    </thead>
                    <tbody id="history-lanc-body"></tbody>
                </table>
            </div>
        </div>
        <!-- Footer -->
        <div class="flex justify-end px-6 py-4 border-t gap-2" style="flex-shrink:0;">
            <button type="button" data-close-history class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                Fechar
            </button>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
// ====== SHARED UTILITIES ======
function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split('; ') : [];
    for (let i = 0; i < cookies.length; i++) {
        const parts = cookies[i].split('=');
        const cookieName = decodeURIComponent(parts[0]);
        if (cookieName === name) {
            parts.shift();
            return decodeURIComponent(parts.join('='));
        }
    }
    return null;
}

function getCSRFToken() {
    let token = getCookie('csrftoken');
    if (!token && window.CSRF_TOKEN) {
        token = window.CSRF_TOKEN;
    }
    if (!token) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            token = csrfInput.value;
        }
    }
    return token;
}

// ====== RECIBO IMPORT FUNCTIONALITY ======

// ====== RECIBO IMPORT FUNCTIONALITY ======
document.addEventListener('DOMContentLoaded', () => {
    const reciboOverlay = document.getElementById('recibo-processing-overlay');
    const reciboProgressBar = document.getElementById('recibo-overlay-progress-bar');
    const reciboProgressText = document.getElementById('recibo-overlay-progress-text');
    const reciboProgressPercentage = document.getElementById('recibo-overlay-progress-percentage');
    const reciboCurrentFile = document.getElementById('recibo-overlay-current-file');
    const reciboCloseBtn = document.getElementById('recibo-overlay-close-btn');
    const reciboSuccessMessage = document.getElementById('recibo-overlay-success-message');
    const reciboSuccessText = document.getElementById('recibo-overlay-success-text');

    function resetReciboOverlay() {
        if (reciboProgressBar) reciboProgressBar.style.width = '0%';
        if (reciboProgressText) reciboProgressText.textContent = '0 de 0 processados';
        if (reciboProgressPercentage) reciboProgressPercentage.textContent = '0%';
        if (reciboCurrentFile) reciboCurrentFile.textContent = '—';
        if (reciboSuccessMessage) reciboSuccessMessage.classList.add('hidden');
        if (reciboCloseBtn) reciboCloseBtn.classList.add('hidden');
    }

    function updateReciboProgress(current, total, fileName) {
        const safeTotal = Math.max(total || 0, 0);
        const safeCurrent = Math.min(Math.max(current || 0, 0), safeTotal);
        const percentage = safeTotal > 0 ? Math.round((safeCurrent / safeTotal) * 100) : 0;
        
        if (reciboProgressBar) reciboProgressBar.style.width = `${percentage}%`;
        if (reciboProgressText) reciboProgressText.textContent = `${safeCurrent} de ${safeTotal} processados`;
        if (reciboProgressPercentage) reciboProgressPercentage.textContent = `${percentage}%`;
        if (reciboCurrentFile && fileName) reciboCurrentFile.textContent = fileName;
        if (reciboCurrentFile && !fileName && safeCurrent === safeTotal && safeTotal > 0) reciboCurrentFile.textContent = 'Concluído!';
    }

    function showReciboOverlay(total) {
        if (!reciboOverlay) return;
        resetReciboOverlay();
        reciboOverlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        updateReciboProgress(0, total || 0);
    }

    function showReciboSummary(results) {
        if (!reciboOverlay) return;
        const safeResults = Array.isArray(results) ? results : [];
        const total = safeResults.length;
        const success = safeResults.filter(r => r && r.ok).length;
        const errors = total - success;

        if (reciboSuccessMessage) {
            if (errors > 0) {
                reciboSuccessMessage.classList.remove('border-green-200', 'bg-green-50', 'dark:border-green-500/40', 'dark:bg-green-500/15', 'text-green-700', 'dark:text-green-300');
                reciboSuccessMessage.classList.add('border-red-200', 'bg-red-50', 'dark:border-red-500/40', 'dark:bg-red-500/15', 'text-red-700', 'dark:text-red-300');
                const icon = reciboSuccessMessage.querySelector('i');
                if (icon) {
                    icon.classList.remove('bi-check-circle-fill');
                    icon.classList.add('bi-x-circle-fill');
                }
            }
            if (reciboSuccessText) {
                let text = `${total} recibo${total === 1 ? '' : 's'} recebido${total === 1 ? '' : 's'}. ${success} processado${success === 1 ? '' : 's'}.`;
                if (errors > 0) text += ` ${errors} erro${errors === 1 ? '' : 's'}.`;
                reciboSuccessText.textContent = text;
            }
            reciboSuccessMessage.classList.remove('hidden');
        }

        if (reciboCurrentFile) reciboCurrentFile.textContent = 'Concluído!';
        if (reciboCloseBtn) {
            reciboCloseBtn.classList.remove('hidden');
            reciboCloseBtn.focus();
        }
    }

    function closeReciboOverlay() {
        if (reciboOverlay) {
            reciboOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        }
        location.reload();
    }

    if (reciboCloseBtn) reciboCloseBtn.addEventListener('click', closeReciboOverlay);
    if (reciboOverlay) {
        reciboOverlay.addEventListener('click', (e) => {
            if (e.target === reciboOverlay && reciboCloseBtn && !reciboCloseBtn.classList.contains('hidden')) {
                closeReciboOverlay();
            }
        });
    }

    // Toggle expand/collapse
    const reciboToggleButton = document.getElementById('importReciboToggleButton');
    const reciboContainer = document.getElementById('importReciboDropZoneContainer');

    if (reciboToggleButton && reciboContainer) {
        reciboToggleButton.addEventListener('click', () => {
            const isExpanded = !reciboContainer.classList.contains('hidden');
            if (isExpanded) {
                reciboContainer.classList.add('hidden');
                reciboToggleButton.setAttribute('aria-expanded', 'false');
                reciboContainer.setAttribute('aria-hidden', 'true');
                reciboToggleButton.innerHTML = '<i class="bi bi-chevron-down mr-2"></i>Expandir área';
            } else {
                reciboContainer.classList.remove('hidden');
                reciboToggleButton.setAttribute('aria-expanded', 'true');
                reciboContainer.setAttribute('aria-hidden', 'false');
                reciboToggleButton.innerHTML = '<i class="bi bi-chevron-up mr-2"></i>Recolher área';
            }
        });
    }

    // Drag and drop logic
    const reciboDropZone = document.getElementById('importReciboDropZone');
    const reciboFileInput = document.getElementById('importReciboFileInput');
    const reciboBrowseButton = document.getElementById('importReciboBrowseButton');

    if (!reciboDropZone || !reciboFileInput) return;

    const reciboUrl = reciboDropZone.getAttribute('data-recibo-url');

    const uploadRecibo = async (file, index, total) => {
        try {
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                return {
                    ok: false,
                    message: `${file.name}: Token de segurança não encontrado.`,
                    file: file.name,
                };
            }

            const formData = new FormData();
            formData.append('pdf', file, file.name);

            const response = await fetch(reciboUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData,
            });

            const data = await response.json().catch(() => null);

            if (!response.ok || !data) {
                let errorDetail = `Status ${response.status}`;
                if (response.status === 403) errorDetail = 'Acesso negado';
                else if (response.status === 401) errorDetail = 'Sessão expirada';
                else if (response.status === 404) errorDetail = data?.error || 'Lançamento não encontrado';
                else if (response.status === 400) errorDetail = data?.error || 'Erro na validação';
                
                return {
                    ok: false,
                    message: `${file.name}: ${errorDetail}`,
                    file: file.name,
                };
            }

            if (!data.ok) {
                return {
                    ok: false,
                    message: `${file.name}: ${data.error || 'Erro ao processar'}`,
                    file: file.name,
                };
            }

            return {
                ok: true,
                message: `${file.name}: Recibo importado (PER/DCOMP: ${data.numero_documento || '--'})`,
                file: file.name,
                data,
            };
        } catch (error) {
            return {
                ok: false,
                message: `${file.name}: ${error.message || 'Erro desconhecido'}`,
                file: file.name,
            };
        }
    };

    const handleReciboFiles = async (fileList) => {
        if (!fileList || !fileList.length) return;

        const filesArray = Array.from(fileList);
        const pdfFiles = filesArray.filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));

        if (!pdfFiles.length) {
            alert('Nenhum arquivo PDF válido selecionado.');
            return;
        }

        const total = pdfFiles.length;
        showReciboOverlay(total);
        updateReciboProgress(0, total);

        const results = [];
        for (let i = 0; i < pdfFiles.length; i++) {
            const file = pdfFiles[i];
            updateReciboProgress(i, total, file.name);
            
            const result = await uploadRecibo(file, i + 1, total);
            results.push(result);
            
            updateReciboProgress(i + 1, total, i + 1 === total ? 'Concluído!' : undefined);
        }

        showReciboSummary(results);
        reciboFileInput.value = '';
    };

    // Click to browse
    reciboDropZone.addEventListener('click', () => {
        reciboFileInput.click();
    });

    // Drag events
    reciboDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        reciboDropZone.classList.add('border-primary', 'bg-muted/40');
    });

    reciboDropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        reciboDropZone.classList.remove('border-primary', 'bg-muted/40');
    });

    reciboDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        reciboDropZone.classList.remove('border-primary', 'bg-muted/40');
        
        const files = e.dataTransfer && e.dataTransfer.files;
        if (files && files.length) {
            handleReciboFiles(files);
        }
    });

    // Browse button
    if (reciboBrowseButton) {
        reciboBrowseButton.addEventListener('click', (e) => {
            e.stopPropagation();
            reciboFileInput.click();
        });
    }

    // File input change
    reciboFileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length) {
            handleReciboFiles(e.target.files);
        }
    });
});

// ====== MODAL HISTÓRICO LANÇAMENTO ======
document.addEventListener('DOMContentLoaded', () => {
    const historyLancModal = document.getElementById('historyLancModal');
    const historyLancBody = document.getElementById('history-lanc-body');
    const historyLancLoading = document.getElementById('history-lanc-loading');

    if (!historyLancModal || !historyLancBody || !historyLancLoading) {
        return;
    }

    const historyCloseButtons = historyLancModal.querySelectorAll('[data-close-history]');

    const openHistoryLanc = () => {
        historyLancModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    const closeHistoryLanc = () => {
        historyLancModal.classList.add('hidden');
        document.body.style.overflow = '';
    };

    historyCloseButtons.forEach(btn => {
        btn.addEventListener('click', closeHistoryLanc);
    });

    historyLancModal.addEventListener('click', e => {
        if (e.target === historyLancModal) closeHistoryLanc();
    });

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && !historyLancModal.classList.contains('hidden')) {
            closeHistoryLanc();
        }
    });

    document.addEventListener('click', async e => {
        const btn = e.target.closest('.btn-history-lanc');
        if (!btn) return;

        const id = btn.getAttribute('data-id');
        historyLancBody.innerHTML = '';
        historyLancLoading.classList.remove('hidden');

        openHistoryLanc();

        try {
            const resp = await fetch(`${window.location.origin}${window.location.pathname}historico/${id}/`);
            if (!resp.ok) throw new Error('Falha ao carregar histórico');

            const data = await resp.json();
            const hist = data.history || [];

            hist.forEach(entry => {
                const tr = document.createElement('tr');
                tr.className = 'border-b transition-colors hover:bg-muted/50';

                const tipoMap = { '+': 'Criação', '~': 'Atualização', '-': 'Exclusão' };
                const tipoClass = {
                    '+': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                    '~': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                    '-': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                };

                const alteracoes = (entry.changes || []).map(c => {
                    const oldVal = c.old === null ? '<em class="text-muted-foreground">(vazio)</em>' : c.old;
                    const newVal = c.new === null ? '<em class="text-muted-foreground">(vazio)</em>' : c.new;
                    return `<div class="mb-2"><span class="inline-flex items-center rounded-md bg-muted px-2 py-1 text-xs font-medium text-muted-foreground">${c.field}</span> <span class="font-medium">${oldVal}</span> → <span class="font-medium">${newVal}</span></div>`;
                }).join('');

                const note = entry.note ? `<div class="text-sm text-muted-foreground">${entry.note}</div>` : '';

                tr.innerHTML = `
                    <td class="p-4 align-middle">${entry.history_date}</td>
                    <td class="p-4 align-middle">${entry.history_user || '-'}</td>
                    <td class="p-4 align-middle">
                        <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ${tipoClass[entry.history_type] || 'bg-muted text-muted-foreground'}">
                            ${tipoMap[entry.history_type] || entry.history_type}
                        </span>
                    </td>
                    <td class="p-4 align-middle">
                        ${alteracoes || note || '<span class="text-muted-foreground">Nenhuma alteração</span>'}
                    </td>
                `;
                historyLancBody.appendChild(tr);
            });

            if (hist.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="4" class="p-8 text-center text-muted-foreground">Nenhum histórico encontrado</td>`;
                historyLancBody.appendChild(tr);
            }
        } catch (err) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="4" class="p-4 text-center text-destructive">${err.message}</td>`;
            historyLancBody.appendChild(tr);
        } finally {
            historyLancLoading.classList.add('hidden');
        }
    });
});

// ====== STATUS FILTER AUTO-SUBMIT ======
document.addEventListener('DOMContentLoaded', function() {
    const sel = document.getElementById('statusFilterForm');
    if (!sel) return;
    sel.addEventListener('change', function() {
        const form = sel.closest('form');
        if (form) form.submit();
    });
});
</script>
{% endblock %}
