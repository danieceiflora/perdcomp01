{% extends 'accounts/dashboard_base.html' %}
{% load static %}{% load format_helpers %}

{% block dashboard_type %}{{ tipo_usuario }}{% endblock %}

{% block stat_cards %}
<div class="mb-6">
  <div class="flex items-center justify-end mb-4 gap-4">
    {% if empresas_info and empresas_info|length > 1 %}
    <div class="flex items-center gap-2">
      <label for="filtro-empresa" class="text-sm text-muted-foreground">Filtrar Empresa:</label>
      <select id="filtro-empresa" class="border rounded px-2 py-1 bg-background text-sm">
        <option value="">Todas</option>
        {% for item in empresas_info %}
        <option value="{{ item.empresa.id }}">{{ item.empresa.nome_fantasia|default:item.empresa.razao_social }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
  </div>
  <!-- Banner: Empresa selecionada -->
  <div id="empresa-selecionada-banner" class="hidden mb-4">
    <div class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-primary/10 px-3 py-1.5 text-sm font-medium text-primary">
      <i class="bi bi-building"></i>
      <span>Empresa selecionada:</span>
      <span id="empresa-selecionada-nome" class="font-semibold"></span>
    </div>
  </div>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {% if tipo_usuario == 'Administrador' %}
    <div class="stat-card rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-lg transition-all">
      <div class="p-6 flex items-center">
        <div class="flex items-center justify-center w-16 h-16 bg-orange-500/10 rounded-full mr-4">
          <i class="bi bi-diagram-3 text-2xl text-orange-600 dark:text-orange-500"></i>
        </div>
        <div>
          <h3 class="text-sm font-medium text-muted-foreground">Total de Parceiros</h3>
          <p class="text-3xl font-bold mt-1 text-foreground">{{ total_parceiros|default:0 }}</p>
          <p class="text-xs text-muted-foreground mt-1">Vínculos ativos</p>
        </div>
      </div>
    </div>
    <div class="stat-card rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-lg transition-all">
      <div class="p-6 flex items-center">
        <div class="flex items-center justify-center w-16 h-16 bg-cyan-500/10 rounded-full mr-4">
          <i class="bi bi-people text-2xl text-cyan-600 dark:text-cyan-500"></i>
        </div>
        <div>
          <h3 class="text-sm font-medium text-muted-foreground">Total de Clientes</h3>
          <p class="text-3xl font-bold mt-1 text-foreground">{{ total_clientes|default:0 }}</p>
          <p class="text-xs text-muted-foreground mt-1">Empresas clientes</p>
        </div>
      </div>
    </div>
    {% endif %}
        <div class="stat-card rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-lg transition-all">
            <div class="p-6 flex items-center">
                <div class="flex items-center justify-center w-16 h-16 bg-green-500/10 rounded-full mr-4">
                    <i class="bi bi-cash-stack text-2xl text-green-600 dark:text-green-500"></i>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-muted-foreground">Crédito Recuperado</h3>
                    <p id="metrica-credito-recuperado" class="text-3xl font-bold mt-1 text-foreground">R$ {{ credito_recuperado|brl }}</p>
                    <p class="text-xs text-muted-foreground mt-1">Total das adesões</p>
                </div>
            </div>
        </div>
        <div class="stat-card rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-lg transition-all">
            <div class="p-6 flex items-center">
                <div class="flex items-center justify-center w-16 h-16 bg-blue-500/10 rounded-full mr-4">
                    <i class="bi bi-credit-card text-2xl text-blue-600 dark:text-blue-500"></i>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-muted-foreground">Crédito Utilizado</h3>
                    <p id="metrica-credito-utilizado" class="text-3xl font-bold mt-1 text-foreground">R$ {{ credito_utilizado|brl }}</p>
                    <p class="text-xs text-muted-foreground mt-1">Total de lançamentos</p>
                </div>
            </div>
        </div>
        <div class="stat-card rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-lg transition-all">
            <div class="p-6 flex items-center">
                <div class="flex items-center justify-center w-16 h-16 bg-purple-500/10 rounded-full mr-4">
                    <i class="bi bi-wallet2 text-2xl text-purple-600 dark:text-purple-500"></i>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-muted-foreground">Saldo de Crédito</h3>
                    <p id="metrica-saldo-credito" class="text-3xl font-bold mt-1 text-foreground">R$ {{ saldo_credito|brl }}</p>
                    <p class="text-xs text-muted-foreground mt-1">Disponível atual</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_content %}
<div class="border rounded-lg bg-card p-4">
  <h2 class="text-sm font-semibold mb-3">Empresas Relacionadas ({{ empresas_total }})</h2>
  {% if empresas_info %}
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-muted-foreground border-b">
          <th class="py-2 pr-4">Nome</th>
          <th class="py-2 pr-4">CNPJ</th>
          <th class="py-2 pr-4">Origem</th>
        </tr>
      </thead>
      <tbody>
        {% for item in empresas_info %}
        <tr class="border-b last:border-0">
          <td class="py-2 pr-4">{{ item.empresa.nome_fantasia|default:item.empresa.razao_social }}</td>
          <td class="py-2 pr-4">{{ item.empresa.cnpj|format_cnpj }}</td>
          <td class="py-2 pr-4">
            {% if item.origem == 'parceiro-cliente' %}<span class="px-2 py-0.5 rounded bg-teal-100 text-teal-700 text-xs">Cliente do Parceiro</span>{% endif %}
            {% if item.origem == 'manual' %}<span class="px-2 py-0.5 rounded bg-gray-100 text-gray-700 text-xs">Manual</span>{% endif %}
            {% if item.origem == 'socio' %}<span class="px-2 py-0.5 rounded bg-purple-100 text-purple-700 text-xs">Sócio</span>{% endif %}
            {% if item.origem == 'superuser' %}<span class="px-2 py-0.5 rounded bg-red-100 text-red-700 text-xs">Superuser</span>{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="text-muted-foreground text-sm">Nenhuma empresa vinculada.</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
function formatBRL(valor){
  return 'R$ ' + (valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
}

document.addEventListener('DOMContentLoaded', function(){
  const select = document.getElementById('filtro-empresa');
  if(!select) return;
  const recEl = document.getElementById('metrica-credito-recuperado');
  const utiEl = document.getElementById('metrica-credito-utilizado');
  const salEl = document.getElementById('metrica-saldo-credito');
  const banner = document.getElementById('empresa-selecionada-banner');
  const bannerNome = document.getElementById('empresa-selecionada-nome');

  async function atualizar(){
    const emp = select.value;
    const url = new URL(window.location.origin + '/accounts/dashboard/metrics/');
    if(emp) url.searchParams.set('empresa', emp);
    try {
      const resp = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
      if(!resp.ok) throw new Error('Falha ao carregar métricas');
      const data = await resp.json();
      recEl.textContent = formatBRL(data.credito_recuperado);
      utiEl.textContent = formatBRL(data.credito_utilizado);
      salEl.textContent = formatBRL(data.saldo_credito);
    } catch(e){
      console.error(e);
    }

    // Atualiza banner da empresa selecionada
    const optionText = select.options[select.selectedIndex]?.text || '';
    if(emp){
      bannerNome.textContent = optionText;
      banner.classList.remove('hidden');
    } else {
      banner.classList.add('hidden');
      bannerNome.textContent = '';
    }
  }
  select.addEventListener('change', atualizar);
  // Inicializa estado do banner ao carregar
  atualizar();
});
</script>
{% endblock %}
