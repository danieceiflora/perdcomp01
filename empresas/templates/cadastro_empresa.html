{% extends "base.html" %}

{% block content %}
<div class="container">
  <h1 class="mb-4">Cadastro de Empresa</h1>
  
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <!-- Empresa Data -->
    <div class="card mb-4">
      <div class="card-header bg-light">
        <h5 class="mb-0">Dados da Empresa</h5>
      </div>
      <div class="card-body">
        {{ form.as_p }}
      </div>
    </div>
    
    <!-- Contacts Section -->
    <div class="card mb-4">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Contatos</h5>
        <button type="button" class="btn btn-sm btn-primary" id="addContactBtn">
          <i class="bi bi-plus-circle"></i> Adicionar Contato
        </button>
      </div>
      <div class="card-body" id="contactsContainer">
        <!-- Initial contact form -->
        <div class="contact-item border-bottom pb-3 mb-3">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Tipo de Contato</label>
              <select name="tipo_contato_1" class="form-select">
                {% for value, label in tipo_contato_options %}
                  <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Telefone</label>
              <input type="text" name="telefone_1" class="form-control">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Email</label>
              <input type="email" name="email_1" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Site</label>
              <input type="url" name="site_1" class="form-control">
            </div>
          </div>
          <button type="button" class="btn btn-sm btn-danger remove-contact">
            <i class="bi bi-trash"></i> Remover
          </button>
        </div>
      </div>
    </div>
    
    <input type="hidden" name="contact_count" id="contactCount" value="1">
    
    <div class="d-flex justify-content-between">
      <a href="{% url 'empresas:lista_empresas' %}" class="btn btn-secondary">Cancelar</a>
      <button type="submit" class="btn btn-primary">Salvar</button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add new contact button
    document.getElementById('addContactBtn').addEventListener('click', function() {
      const contactsContainer = document.getElementById('contactsContainer');
      const contactCount = document.getElementById('contactCount');
      const newIndex = parseInt(contactCount.value) + 1;
      
      // Create new contact form
      const newContactHTML = `
        <div class="contact-item border-bottom pb-3 mb-3">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Tipo de Contato</label>
              <select name="tipo_contato_${newIndex}" class="form-select">
                {% for value, label in tipo_contato_options %}
                  <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Telefone</label>
              <input type="text" name="telefone_${newIndex}" class="form-control">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Email</label>
              <input type="email" name="email_${newIndex}" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Site</label>
              <input type="url" name="site_${newIndex}" class="form-control">
            </div>
          </div>
          <button type="button" class="btn btn-sm btn-danger remove-contact">
            <i class="bi bi-trash"></i> Remover
          </button>
        </div>
      `;
      
      // Add to DOM
      contactsContainer.insertAdjacentHTML('beforeend', newContactHTML);
      contactCount.value = newIndex;
      
      // Add event listener to the new remove button
      setupRemoveButtons();
    });
    
    // Setup remove contact buttons
    function setupRemoveButtons() {
      document.querySelectorAll('.remove-contact').forEach(button => {
        button.addEventListener('click', function() {
          // Only remove if there's more than one contact
          if (document.querySelectorAll('.contact-item').length > 1) {
            this.closest('.contact-item').remove();
            updateContactCount();
          } else {
            alert('É necessário pelo menos um contato.');
          }
        });
      });
    }
    
    // Update contact count
    function updateContactCount() {
      const count = document.querySelectorAll('.contact-item').length;
      document.getElementById('contactCount').value = count;
    }
    
    // Initialize remove buttons
    setupRemoveButtons();
  });
</script>
{% endblock %}