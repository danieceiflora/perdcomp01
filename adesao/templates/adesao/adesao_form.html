{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if object %}Editar Adesão{% else %}Nova Adesão{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 col-lg-10 col-xl-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">{% if object %}Editar Adesão{% else %}Nova Adesão{% endif %}</h3>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger" role="alert">{{ form.non_field_errors }}</div>
                        {% endif %}

                        {% if form.data_inicio %}{{ form.data_inicio.as_hidden }}{% endif %}

                        <!-- Seção 1: Dados básicos -->
                        <fieldset class="mb-3">
                            <legend class="h6">Dados básicos</legend>
                            <div class="row g-3">
                                <div class="col-12 col-md-6">
                                    <label for="{{ form.perdcomp.id_for_label }}" class="form-label">{{ form.perdcomp.label }}</label>
                                    {{ form.perdcomp }}
                                    {% if form.perdcomp.errors %}
                                        <div class="invalid-feedback d-block">{{ form.perdcomp.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="{{ form.cliente.id_for_label }}" class="form-label">{{ form.cliente.label }}</label>
                                    {{ form.cliente }}
                                    {% if form.cliente.errors %}
                                        <div class="invalid-feedback d-block">{{ form.cliente.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="{{ form.tese_credito_id.id_for_label }}" class="form-label">{{ form.tese_credito_id.label }}</label>
                                    {{ form.tese_credito_id }}
                                    {% if form.tese_credito_id.errors %}
                                        <div class="invalid-feedback d-block">{{ form.tese_credito_id.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="{{ form.metodo_credito.id_for_label }}" class="form-label">{{ form.metodo_credito.label }}</label>
                                    {{ form.metodo_credito }}
                                    {% if form.metodo_credito.errors %}
                                        <div class="invalid-feedback d-block">{{ form.metodo_credito.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </fieldset>

                        <!-- Seção 2: Campos condicionais -->
                        <div id="sec-condicional" class="mt-3" aria-live="polite">
                            <!-- Ressarcimento (tratado como 'Pedido de compensação' no banco) -->
                            <fieldset id="sec-ressarcimento" class="d-none">
                                <legend class="h6">Pedido de ressarcimento</legend>
                                <div class="row g-3">
                                    <div class="col-12 col-md-6">
                                        <label for="{{ form.ano_trimestre.id_for_label }}" class="form-label">{{ form.ano_trimestre.label }}</label>
                                        {{ form.ano_trimestre }}
                                        {% if form.ano_trimestre.errors %}
                                            <div class="invalid-feedback d-block">{{ form.ano_trimestre.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label for="{{ form.saldo.id_for_label }}" class="form-label">{{ form.saldo.label }}</label>
                                        {{ form.saldo }}
                                        {% if form.saldo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.saldo.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </fieldset>

                            <!-- Restituição -->
                            <fieldset id="sec-restituicao" class="d-none">
                                <legend class="h6">Pedido de restituição</legend>
                                <div class="row g-3">
                                    <div class="col-12 col-md-6">
                                        <label for="{{ form.periodo_apuracao.id_for_label }}" class="form-label">{{ form.periodo_apuracao.label }}</label>
                                        {{ form.periodo_apuracao }}
                                        {% if form.periodo_apuracao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.periodo_apuracao.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label for="{{ form.codigo_receita.id_for_label }}" class="form-label">{{ form.codigo_receita.label }}</label>
                                        {{ form.codigo_receita }}
                                        {% if form.codigo_receita.errors %}
                                            <div class="invalid-feedback d-block">{{ form.codigo_receita.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12">
                                        <label for="{{ form.saldo.id_for_label }}" class="form-label">{{ form.saldo.label }}</label>
                                        {{ form.saldo }}
                                        {% if form.saldo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.saldo.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </fieldset>

                            <!-- Declaração de compensação -->
                            <fieldset id="sec-declaracao" class="d-none">
                                <legend class="h6">Declaração de compensação</legend>
                                <div class="row g-3">
                                    <div class="col-12 col-md-6">
                                        <label for="{{ form.credito_original_utilizado.id_for_label }}" class="form-label">{{ form.credito_original_utilizado.label }}</label>
                                        {{ form.credito_original_utilizado }}
                                        {% if form.credito_original_utilizado.errors %}
                                            <div class="invalid-feedback d-block">{{ form.credito_original_utilizado.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </fieldset>

                            <!-- Declaração de compensação (pagamento indevido) -->
                            <fieldset id="sec-declaracao-indevido" class="d-none">
                                <legend class="h6">Declaração de compensação (pagamento indevido)</legend>
                                <div class="row g-3">
                                    <div class="col-12 col-md-6">
                                        <label for="{{ form.periodo_apuracao.id_for_label }}" class="form-label">{{ form.periodo_apuracao.label }}</label>
                                        {{ form.periodo_apuracao }}
                                        {% if form.periodo_apuracao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.periodo_apuracao.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label for="{{ form.periodo_apuracao_um.id_for_label }}" class="form-label">{{ form.periodo_apuracao_um.label }}</label>
                                        {{ form.periodo_apuracao_um }}
                                        {% if form.periodo_apuracao_um.errors %}
                                            <div class="invalid-feedback d-block">{{ form.periodo_apuracao_um.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label for="{{ form.codigo_receita.id_for_label }}" class="form-label">{{ form.codigo_receita.label }}</label>
                                        {{ form.codigo_receita }}
                                        {% if form.codigo_receita.errors %}
                                            <div class="invalid-feedback d-block">{{ form.codigo_receita.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label for="{{ form.codigo_receita_denominacao.id_for_label }}" class="form-label">{{ form.codigo_receita_denominacao.label }}</label>
                                        {{ form.codigo_receita_denominacao }}
                                        {% if form.codigo_receita_denominacao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.codigo_receita_denominacao.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12">
                                        <label for="{{ form.saldo.id_for_label }}" class="form-label">{{ form.saldo.label }}</label>
                                        {{ form.saldo }}
                                        {% if form.saldo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.saldo.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </fieldset>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{% url 'adesao:list' %}" class="btn btn-outline-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const metodoField = document.getElementById('{{ form.metodo_credito.id_for_label }}') || document.querySelector('[name="{{ form.metodo_credito.html_name }}"]');
        const secRessarc = document.getElementById('sec-ressarcimento');
        const secRestit = document.getElementById('sec-restituicao');
        const secDeclar  = document.getElementById('sec-declaracao');
        const secDeclarInd = document.getElementById('sec-declaracao-indevido');

        const fldAnoTrim = document.getElementById('{{ form.ano_trimestre.id_for_label }}');
        const fldPeriodo = document.getElementById('{{ form.periodo_apuracao.id_for_label }}');
        const fldPeriodoUm = document.getElementById('{{ form.periodo_apuracao_um.id_for_label }}');
        const fldCodRec  = document.getElementById('{{ form.codigo_receita.id_for_label }}');
        const fldCodRecDen  = document.getElementById('{{ form.codigo_receita_denominacao.id_for_label }}');
        const fldSaldo   = document.getElementById('{{ form.saldo.id_for_label }}');
        const fldCredOri = document.getElementById('{{ form.credito_original_utilizado.id_for_label }}');

        function setRequired(el, required) {
            if (!el) return;
            if (required) {
                el.setAttribute('required', 'required');
                el.closest('.col-12, .col-md-6')?.querySelector('label')?.classList.add('required');
            } else {
                el.removeAttribute('required');
                el.closest('.col-12, .col-md-6')?.querySelector('label')?.classList.remove('required');
            }
        }

        function toggleSections() {
            const val = metodoField ? metodoField.value : '';
            // Oculta todas
            secRessarc.classList.add('d-none');
            secRestit.classList.add('d-none');
            secDeclar.classList.add('d-none');
            secDeclarInd.classList.add('d-none');

            // Limpa required
            setRequired(fldAnoTrim, false);
            setRequired(fldPeriodo, false);
            setRequired(fldPeriodoUm, false);
            setRequired(fldCodRec, false);
            setRequired(fldCodRecDen, false);
            setRequired(fldSaldo, false);
            setRequired(fldCredOri, false);

            if (val === 'Pedido de compensação') {
                // Ressarcimento
                secRessarc.classList.remove('d-none');
                setRequired(fldAnoTrim, true);
                setRequired(fldSaldo, true);
            } else if (val === 'Pedido de restituição') {
                // Restituição
                secRestit.classList.remove('d-none');
                setRequired(fldPeriodo, true);
                setRequired(fldCodRec, true);
                setRequired(fldSaldo, true);
            } else if (val === 'Declaração de compensação') {
                // Declaração de compensação
                secDeclar.classList.remove('d-none');
                setRequired(fldCredOri, true);
            } else if (val === 'Declaração de compensação pagamento indevido') {
                // Declaração de compensação (pagamento indevido)
                secDeclarInd.classList.remove('d-none');
                setRequired(fldPeriodo, true);
                setRequired(fldPeriodoUm, true);
                setRequired(fldCodRec, true);
                setRequired(fldCodRecDen, true);
                setRequired(fldSaldo, true);
            }
        }

        toggleSections();
        metodoField && metodoField.addEventListener('change', toggleSections);

        const form = document.querySelector('form');
        form.addEventListener('submit', function() {
            form.classList.add('was-validated');
        });
    });
</script>
{% endblock %}
