{% extends 'base.html' %}
{% load static %}
{% load utils_filters %}

{% block title %}Lista de Adesões{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header Card -->
    <div class="bg-card border rounded-lg shadow-sm mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-6 border-b">
            <h1 class="text-2xl font-semibold text-card-foreground mb-4 sm:mb-0">Lista de Adesões</h1>
            {% if user.is_staff or user.is_superuser %}
            <a href="{% url 'adesao:create' %}" 
               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                <i class="bi bi-plus mr-2"></i>
                Novo Crédito
            </a>
            {% endif %}
        </div>
        
        <div class="p-6">
            <!-- Filtros e Resumo -->
            <div class="mb-6 space-y-4">
                <!-- Filtros -->
                <form method="get" class="flex flex-col sm:flex-row gap-3 w-full">
                    <div class="flex items-stretch rounded-md border border-input overflow-hidden w-full sm:w-72">
                        <span class="inline-flex items-center px-3 text-sm text-muted-foreground bg-muted">Empresa</span>
                        <select name="empresa" class="bg-background px-3 py-2 text-sm outline-none flex-1">
                            <option value="">Todas</option>
                            {% for emp in empresas_opcoes %}
                            <option value="{{ emp.id }}" {% if request.GET.empresa == emp.id|stringformat:'s' %}selected{% endif %}>{{ emp.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex items-stretch rounded-md border border-input overflow-hidden w-full sm:flex-1">
                        <input type="text" name="perdcomp" placeholder="Buscar PERDCOMP" value="{{ request.GET.perdcomp|default:'' }}" class="flex-1 bg-background px-3 py-2 text-sm outline-none min-w-[18rem]" />
                        <button type="submit" class="inline-flex items-center justify-center bg-muted px-3 text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors" title="Buscar">
                            <i class="bi bi-search"></i>
                        </button>
                        {% if request.GET.perdcomp or request.GET.empresa %}
                        <a href="{{ request.path }}" class="inline-flex items-center justify-center bg-muted px-3 text-sm font-medium text-muted-foreground hover:bg-destructive hover:text-destructive-foreground transition-colors" title="Limpar filtros">
                            <i class="bi bi-x-lg"></i>
                        </a>
                        {% endif %}
                    </div>
                </form>
                <!-- Resumo Sintético -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                        <div class="p-4 flex items-center">
                            <div class="flex items-center justify-center w-12 h-12 bg-blue-500/10 rounded-full mr-3">
                                <i class="bi bi-collection text-blue-600 dark:text-blue-500"></i>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Total de Adesões</div>
                                <div id="metric-total-adesoes" class="text-2xl font-bold">
                                    {% if is_paginated %}{{ page_obj.paginator.count }}{% else %}{{ adesoes|length }}{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                        <div class="p-4 flex items-center">
                            <div class="flex items-center justify-center w-12 h-12 bg-green-500/10 rounded-full mr-3">
                                <i class="bi bi-wallet2 text-green-600 dark:text-green-500"></i>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Saldo Restante (Total)</div>
                                <div id="metric-saldo-restante-total" class="text-2xl font-bold" data-server="1">{{ saldo_restante_total|br_currency }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if adesoes %}
                <!-- Desktop Table View -->
                <div class="hidden md:block">
                    <div class="rounded-md border">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b bg-muted/50">
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Perdcomp</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Cliente</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Método de Crédito</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Data de Início</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Saldo Inicial</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Saldo Restante</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Ações</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Histórico</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for adesao in adesoes %}
                                <tr class="border-b transition-colors hover:bg-muted/50">
                                    <td class="p-4 align-middle font-medium">{{ adesao.perdcomp }}</td>
                                    <td class="p-4 align-middle">{{ adesao.cliente.id_company_vinculada.nome_fantasia|default:adesao.cliente.id_company_vinculada.razao_social }}</td>
                                    <td class="p-4 align-middle">{{ adesao.metodo_credito|default:"—" }}</td>
                                    <td class="p-4 align-middle">{{ adesao.data_inicio|date:"d/m/Y" }}</td>
                                    <td class="p-4 align-middle font-semibold {% if adesao.saldo > 0 %}text-muted-foreground{% elif adesao.saldo < 0 %}text-destructive{% endif %}">
                                        {{ adesao.saldo|br_currency }}
                                    </td>
                                    <td class="p-4 align-middle font-semibold {% if adesao.saldo_atual > 0 %}text-green-600 dark:text-green-400{% elif adesao.saldo_atual < 0 %}text-destructive{% endif %} saldo-restante-cell" data-saldo="{{ adesao.saldo_atual|default:0 }}">
                                        {{ adesao.saldo_atual|br_currency }}
                                    </td>
                                    <td class="p-4 align-middle">
                                        <div class="flex items-center gap-2">
                                            <a href="{% url 'adesao:detail' adesao.pk %}" 
                                               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 w-9"
                                               title="Visualizar">
                                                <i class="bi bi-eye text-sm"></i>
                                            </a>
                                            <a href="{% url 'lancamentos:list' %}?perdcomp={{ adesao.perdcomp }}" 
                                               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 w-9"
                                               title="Lançamentos">
                                                <i class="bi bi-card-list text-sm"></i>
                                            </a>
                                        </div>
                                    </td>
                                    <td class="p-4 align-middle">
                                        <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 w-9 btn-history-adesao" 
                                                data-id="{{ adesao.id }}" 
                                                title="Histórico">
                                            <i class="bi bi-clock-history text-sm"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Mobile Card View -->
                <div class="block md:hidden space-y-4">
                    {% for adesao in adesoes %}
                    <div class="bg-card border rounded-lg shadow-sm transition-all duration-200 hover:-translate-y-1 hover:shadow-md">
                        <div class="p-4 border-b">
                            <h3 class="font-semibold text-card-foreground">
                                <span class="text-muted-foreground">Perdcomp:</span> {{ adesao.perdcomp }}
                            </h3>
                        </div>
                        <div class="p-4 space-y-3">
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Cliente:</span>
                                <div class="font-medium">{{ adesao.cliente.id_company_vinculada.nome_fantasia|default:adesao.cliente.id_company_vinculada.razao_social }}</div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Método de Crédito:</span>
                                <div class="font-medium">{{ adesao.metodo_credito|default:"—" }}</div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Data de Início:</span>
                                <div class="font-medium">{{ adesao.data_inicio|date:"d/m/Y" }}</div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Saldo Inicial:</span>
                                <div class="font-semibold {% if adesao.saldo > 0 %}text-muted-foreground{% elif adesao.saldo < 0 %}text-destructive{% endif %}">
                                    {{ adesao.saldo|br_currency }}
                                </div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Saldo Restante:</span>
                                <div class="font-semibold {% if adesao.saldo_atual > 0 %}text-green-600 dark:text-green-400{% elif adesao.saldo_atual < 0 %}text-destructive{% endif %} saldo-restante-cell" data-saldo="{{ adesao.saldo_atual|default:0 }}">
                                    {{ adesao.saldo_atual|br_currency }}
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-muted/30 border-t flex flex-col gap-2">
                            <a href="{% url 'adesao:detail' adesao.pk %}" 
                               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 w-full">
                                <i class="bi bi-eye mr-2"></i>
                                Detalhes
                            </a>
                            <a href="{% url 'lancamentos:list' %}?perdcomp={{ adesao.perdcomp }}" 
                               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full">
                                <i class="bi bi-card-list mr-2"></i>
                                Lançamentos
                            </a>
                            <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 w-full btn-history-adesao" 
                                    data-id="{{ adesao.id }}">
                                <i class="bi bi-clock-history mr-2"></i>
                                Histórico
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if is_paginated %}
                <nav class="flex items-center justify-center mt-8" aria-label="Navegação de páginas">
                    <div class="flex items-center gap-2">
                        {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.empresa %}&empresa={{ request.GET.empresa }}{% endif %}{% if request.GET.perdcomp %}&perdcomp={{ request.GET.perdcomp }}{% endif %}" 
                           class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                            Anterior
                        </a>
                        {% endif %}
                        
                        <span class="flex items-center px-4 py-2 text-sm text-muted-foreground">
                            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>
                        
                        {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.empresa %}&empresa={{ request.GET.empresa }}{% endif %}{% if request.GET.perdcomp %}&perdcomp={{ request.GET.perdcomp }}{% endif %}" 
                           class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                            Próximo
                        </a>
                        {% endif %}
                    </div>
                </nav>
                {% endif %}
            {% else %}
                <div class="flex items-center p-4 bg-blue-50 dark:bg-slate-800 border border-blue-200 dark:border-slate-600 rounded-lg">
                    <i class="bi bi-info-circle text-blue-600 dark:text-blue-400 mr-3"></i>
                    <span class="text-blue-800 dark:text-white">Nenhuma adesão cadastrada.</span>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<!-- Modal para Histórico da Adesão -->
<div id="historyAdesaoModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-50" role="dialog" aria-modal="true" aria-labelledby="historyAdesaoTitle">
    <div class="bg-background rounded-lg shadow-xl w-full max-w-lg sm:max-w-3xl md:max-w-5xl lg:max-w-6xl 2xl:max-w-[90rem] border border-border" style="height:80vh;display:flex;flex-direction:column;">
        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b" style="flex-shrink:0;">
            <h3 id="historyAdesaoTitle" class="text-lg font-semibold">Histórico da Adesão</h3>
            <button type="button" id="closeModalBtn" class="rounded-md p-2 hover:bg-accent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" title="Fechar">
                <i class="bi bi-x text-xl"></i>
            </button>
        </div>
        <!-- Body -->
        <div class="px-6 py-4" style="flex:1;overflow-y:auto;min-height:0;">
            <!-- Loading -->
            <div id="history-adesao-loading" class="text-center py-8 hidden">
                <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-muted-foreground">Carregando histórico...</p>
            </div>
            <div class="overflow-x-auto rounded-md border" id="historyAdesaoTableWrap">
                <table class="w-full" id="history-adesao-table">
                    <thead class="border-b bg-muted/50">
                        <tr>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Data</th>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Usuário</th>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Tipo</th>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Alterações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <!-- Footer -->
        <div class="flex justify-end px-6 py-4 border-t gap-2" style="flex-shrink:0;">
            <button type="button" id="closeModalFooterBtn" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                Fechar
            </button>
        </div>
    </div>
</div>

<script>
// Modal functionality
const modal = document.getElementById('historyAdesaoModal');
const closeButtons = document.querySelectorAll('#closeModalBtn, #closeModalFooterBtn');

function openModal() {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
}

// Close modal event listeners
closeButtons.forEach(btn => {
    btn.addEventListener('click', closeModal);
});

// Close modal when clicking backdrop (outside panel)
modal.addEventListener('click', (e) => {
    if (e.target === modal) {
        closeModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
    }
});

// Compute and display total saldo restante
function formatBRL(value){
    try { return (new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })).format(value || 0); } catch { return 'R$ ' + (value||0).toFixed(2); }
}

document.addEventListener('DOMContentLoaded', () => {
    const metric = document.getElementById('metric-saldo-restante-total');
    if(metric && metric.getAttribute('data-server') === '1') return; // keep server-rendered formatting
    const cells = document.querySelectorAll('.saldo-restante-cell');
    let total = 0;
    cells.forEach(c => {
        const raw = parseFloat(c.getAttribute('data-saldo'));
        if(!isNaN(raw)) total += raw;
    });
    if(metric) metric.textContent = formatBRL(total);
});

// History button functionality
document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-history-adesao');
    if (!btn) return;
    
    const id = btn.getAttribute('data-id');
    const tbody = document.querySelector('#history-adesao-table tbody');
    const loadingEl = document.getElementById('history-adesao-loading');
    
    // Clear previous content and show loading
    tbody.innerHTML = '';
    loadingEl.classList.remove('hidden');
    
    // Open modal
    openModal();
    
    try {
        const resp = await fetch(`${window.location.origin}${window.location.pathname}historico/${id}/`);
        if (!resp.ok) throw new Error('Falha ao carregar histórico');
        
        const data = await resp.json();
        const hist = data.history || [];
        
        hist.forEach(entry => {
            const tr = document.createElement('tr');
            tr.className = 'border-b transition-colors hover:bg-muted/50';
            
            const tipoMap = { '+': 'Criação', '~': 'Atualização', '-': 'Exclusão' };
            const tipoClass = { '+': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200', '~': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200', '-': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' };
            
            const alteracoes = entry.changes.map(c => 
                `<div class="mb-2"><span class="inline-flex items-center rounded-md bg-muted px-2 py-1 text-xs font-medium text-muted-foreground">${c.field}</span> <span class="font-medium">${c.old === null ? '<em class="text-muted-foreground">(vazio)</em>' : c.old}</span> → <span class="font-medium">${c.new === null ? '<em class="text-muted-foreground">(vazio)</em>' : c.new}</span></div>`
            ).join('');
            
            const note = entry.note ? `<div class="text-sm text-muted-foreground">${entry.note}</div>` : '';
            
            tr.innerHTML = `
                <td class="p-4 align-middle">${entry.history_date}</td>
                <td class="p-4 align-middle">${entry.history_user || '-'}</td>
                <td class="p-4 align-middle">
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ${tipoClass[entry.history_type] || 'bg-muted text-muted-foreground'}">
                        ${tipoMap[entry.history_type] || entry.history_type}
                    </span>
                </td>
                <td class="p-4 align-middle">
                    ${alteracoes || note || '<span class="text-muted-foreground">Nenhuma alteração</span>'}
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        if (hist.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="4" class="p-8 text-center text-muted-foreground">Nenhum histórico encontrado</td>`;
            tbody.appendChild(tr);
        }
    } catch (err) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="p-4 text-center text-destructive">${err.message}</td>`;
        tbody.appendChild(tr);
    } finally {
        loadingEl.classList.add('hidden');
    }
});
</script>
{% endblock %}
