{% extends 'base.html' %}
{% load static %}
{% load utils_filters %}

{% block title %}Lista de Adesões{% endblock %}

{% block content %}
<!-- Hidden CSRF token for JavaScript access -->
{% csrf_token %}

<div class="container mx-auto px-4 py-6">
    {% if user.is_staff or user.is_superuser %}
    <div class="bg-card border rounded-lg shadow-sm mb-6">
        <div class="p-6">
            <div class="flex flex-col gap-4">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-card-foreground">Importar documentos PERDCOMP</h2>
                        <p class="text-sm text-muted-foreground">Carregue recibos de protocolo, notificações de crédito em conta ou declarações de compensação vinculadas a PERDCOMPs já cadastrados.</p>
                    </div>
                    <button type="button" id="importToggleButton" aria-controls="importDropZoneContainer" aria-expanded="false"
                            class="inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-2 text-sm font-medium text-card-foreground transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                        <i class="bi bi-chevron-down mr-2" aria-hidden="true"></i>
                        Expandir área
                    </button>
                </div>
                <div id="importDropZoneContainer" class="transition-all duration-200 hidden" aria-hidden="true">
                    <div class="flex flex-col gap-4">
                        <div class="rounded-lg border border-dashed border-primary/30 bg-primary/5 p-4 text-sm text-left text-muted-foreground">
                            <p class="font-medium text-primary-700 dark:text-primary-300">Detecção automática de tipo</p>
                            <p class="mt-2">Carregue recibos de protocolo, notificações de crédito em conta ou declarações de compensação em PDF. Identificaremos o tipo automaticamente antes de enviar.</p>
                            <ul class="mt-3 list-disc list-inside space-y-1">
                                <li><span class="font-medium text-card-foreground">Recibo:</span> reconhecido quando o PDF contém a expressão "Recibo d entrega" ou "Recibo de entrega".</li>
                                <li><span class="font-medium text-card-foreground">Notificação de crédito:</span> reconhecida quando o PDF contém "Aviso de Pagamento de Ressarcimento".</li>
                                <li><span class="font-medium text-card-foreground">Declaração de compensação:</span> identificada quando o PDF contém "Declaração de Compensação" ou o campo "PER/DCOMP inicial".</li>
                            </ul>
                            <p class="mt-2 text-xs text-muted-foreground">Não se preocupe se o texto não estiver exatamente igual: tentaremos ambos os formatos automaticamente caso a detecção inicial não seja conclusiva.</p>
                        </div>
                        <div id="importDropZone" role="button" tabindex="0"
                             data-recibo-url="{% url 'adesao:importar_recibo' %}"
                             data-credito-url="{% url 'adesao:importar_credito_conta' %}"
                             data-compensacao-url="{% url 'adesao:importar_declaracao_compensacao' %}"
                             class="relative flex flex-col items-center justify-center gap-3 rounded-lg border-2 border-dashed border-border bg-muted/30 p-5 text-center transition-all duration-200 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                            <input type="file" id="importFileInput" accept="application/pdf" class="hidden" multiple />
                            <i class="bi bi-cloud-arrow-up text-3xl text-muted-foreground"></i>
                            <p id="importDropZoneText" class="text-sm text-muted-foreground max-w-lg">
                                Arraste PDFs de recibos, notificações ou declarações de compensação aqui ou utilize o botão abaixo. Detectaremos automaticamente o tipo de cada arquivo.
                            </p>
                            <button type="button" id="importBrowseButton"
                                    class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium text-card-foreground transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                                Selecionar PDFs
                            </button>
                            <span id="importDropZoneHint" class="text-xs text-muted-foreground text-center">Aceitamos vários PDFs por vez. Cada arquivo será identificado automaticamente como recibo, notificação ou declaração de compensação.</span>
                            <div id="importDropZoneOverlay" class="pointer-events-none absolute inset-0 hidden items-center justify-center rounded-lg bg-background/80 backdrop-blur-sm">
                                <div class="flex items-center gap-2 text-sm text-muted-foreground">
                                    <span class="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"></span>
                                    <span id="importDropZoneOverlayText">Processando arquivos...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="processing-overlay" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" role="dialog" aria-modal="true" aria-labelledby="processingOverlayTitle">
        <div class="flex w-full max-w-md flex-col rounded-lg border border-border bg-card text-card-foreground shadow-2xl p-6 sm:p-8" tabindex="-1">
            <div class="mb-6 text-center">
                    <h3 id="processingOverlayTitle" class="text-xl font-semibold mb-2">Processando arquivos</h3>
                <p class="text-sm text-muted-foreground">Aguarde enquanto processamos os arquivos selecionados.</p>
            </div>
            <div class="flex justify-center mb-6">
                <div class="relative">
                    <div class="h-16 w-16 rounded-full border-4 border-primary/20"></div>
                    <div class="absolute inset-0 h-16 w-16 rounded-full border-4 border-primary border-t-transparent animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-primary">
                        <i class="bi bi-file-earmark-pdf text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <div class="mb-2 flex items-center justify-between text-sm text-muted-foreground">
                    <span id="overlay-progress-text">0 de 0 processados</span>
                    <span id="overlay-progress-percentage">0%</span>
                </div>
                <div class="h-3 w-full rounded-full bg-muted/60">
                    <div id="overlay-progress-bar" class="relative h-3 w-0 rounded-full bg-primary transition-all duration-300"></div>
                </div>
            </div>
            <div class="mb-4 rounded-lg bg-muted/40 px-4 py-3 text-center">
                <p class="text-xs text-muted-foreground">Processando:</p>
                <p id="overlay-current-file" class="truncate text-sm font-medium">—</p>
            </div>
            <div id="overlay-success-message" class="hidden rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-700 dark:border-green-500/40 dark:bg-green-500/15 dark:text-green-300">
                <div class="overlay-success-content flex items-center justify-center gap-2">
                    <i class="overlay-success-icon bi bi-check-circle-fill"></i>
                    <span id="overlay-success-text" class="font-medium">Processamento concluído!</span>
                </div>
            </div>
            <button id="overlay-close-btn" type="button" class="mt-6 hidden inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <i class="bi bi-check-lg mr-2"></i>OK, Fechar
            </button>
        </div>
    </div>

    <!-- Header Card -->
    <div class="bg-card border rounded-lg shadow-sm mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-6 border-b">
            <h1 class="text-2xl font-semibold text-card-foreground mb-4 sm:mb-0">Lista de Adesões</h1>
            {% if user.is_staff or user.is_superuser %}
            <a href="{% url 'adesao:create' %}" 
               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                <i class="bi bi-plus mr-2"></i>
                Novo Crédito
            </a>
            {% endif %}
        </div>
        
        <div class="p-6">
            <!-- Filtros e Resumo -->
            <div class="mb-6 space-y-4">
                <!-- Filtros -->
                <form method="get" class="flex flex-col sm:flex-row gap-3 w-full">
                    <div class="flex items-stretch rounded-md border border-input overflow-hidden w-full sm:w-72">
                        <span class="inline-flex items-center px-3 text-sm text-muted-foreground bg-muted">Empresa</span>
                        <select name="empresa" class="bg-background px-3 py-2 text-sm outline-none flex-1">
                            <option value="">Todas</option>
                            {% for emp in empresas_opcoes %}
                            <option value="{{ emp.id }}" {% if request.GET.empresa == emp.id|stringformat:'s' %}selected{% endif %}>{{ emp.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex items-stretch rounded-md border border-input overflow-hidden w-full sm:flex-1">
                        <input type="text" name="perdcomp" placeholder="Buscar PERDCOMP" value="{{ request.GET.perdcomp|default:'' }}" class="flex-1 bg-background px-3 py-2 text-sm outline-none min-w-[18rem]" />
                        <button type="submit" class="inline-flex items-center justify-center bg-muted px-3 text-sm font-medium text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors" title="Buscar">
                            <i class="bi bi-search"></i>
                        </button>
                        {% if request.GET.perdcomp or request.GET.empresa %}
                        <a href="{{ request.path }}" class="inline-flex items-center justify-center bg-muted px-3 text-sm font-medium text-muted-foreground hover:bg-destructive hover:text-destructive-foreground transition-colors" title="Limpar filtros">
                            <i class="bi bi-x-lg"></i>
                        </a>
                        {% endif %}
                    </div>
                </form>
                <!-- Resumo Sintético -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                        <div class="p-4 flex items-center">
                            <div class="flex items-center justify-center w-12 h-12 bg-blue-500/10 rounded-full mr-3">
                                <i class="bi bi-collection text-blue-600 dark:text-blue-500"></i>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Total de Adesões</div>
                                <div id="metric-total-adesoes" class="text-2xl font-bold">
                                    {% if is_paginated %}{{ page_obj.paginator.count }}{% else %}{{ adesoes|length }}{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                        <div class="p-4 flex items-center">
                            <div class="flex items-center justify-center w-12 h-12 bg-green-500/10 rounded-full mr-3">
                                <i class="bi bi-wallet2 text-green-600 dark:text-green-500"></i>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Saldo Restante (Total)</div>
                                <div id="metric-saldo-restante-total" class="text-2xl font-bold" data-server="1">{{ saldo_restante_total|br_currency }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if adesoes %}
                <!-- Desktop Table View -->
                <div class="hidden md:block">
                    <div class="rounded-md border">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b bg-muted/50">
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Perdcomp</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Cliente</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Tipo de Crédito</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Número Controle</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Status</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground hidden xl:table-cell">Chave SERPRO</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Data de Início</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Saldo Inicial</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Saldo Restante</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Ações</th>
                                    <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Histórico</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for adesao in adesoes %}
                                <tr class="border-b transition-colors hover:bg-muted/50">
                                    <td class="p-4 align-middle font-medium">{{ adesao.perdcomp }}</td>
                                    <td class="p-4 align-middle">{{ adesao.cliente.id_company_vinculada.nome_fantasia|default:adesao.cliente.id_company_vinculada.razao_social }}</td>
                                    <td class="p-4 align-middle">{{ adesao.metodo_credito|default:"—" }}</td>
                                    <td class="p-4 align-middle">{{ adesao.numero_controle|default:"—" }}</td>
                                    <td class="p-4 align-middle">
                                        {% if adesao.status %}
                                            <span class="inline-flex items-center rounded-full bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 px-2.5 py-0.5 text-xs font-medium">
                                                {{ adesao.get_status_display }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted-foreground">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="p-4 align-middle hidden xl:table-cell">
                                        {% if adesao.chave_seguranca_serpro %}
                                            <span class="font-mono text-sm break-all" title="{{ adesao.chave_seguranca_serpro }}">{{ adesao.chave_seguranca_serpro|truncatechars:28 }}</span>
                                        {% else %}
                                            <span class="text-muted-foreground">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="p-4 align-middle">{{ adesao.data_inicio|date:"d/m/Y" }}</td>
                                    <td class="p-4 align-middle font-semibold {% if adesao.saldo > 0 %}text-muted-foreground{% elif adesao.saldo < 0 %}text-destructive{% endif %}">
                                        {{ adesao.saldo|br_currency }}
                                    </td>
                                    <td class="p-4 align-middle font-semibold {% if adesao.saldo_atual > 0 %}text-green-600 dark:text-green-400{% elif adesao.saldo_atual < 0 %}text-destructive{% endif %} saldo-restante-cell" data-saldo="{{ adesao.saldo_atual|default:0 }}">
                                        {{ adesao.saldo_atual|br_currency }}
                                    </td>
                                    <td class="p-4 align-middle">
                                        <div class="flex items-center gap-2">
                                            <a href="{% url 'adesao:detail' adesao.pk %}" 
                                               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 w-9"
                                               title="Visualizar">
                                                <i class="bi bi-eye text-sm"></i>
                                            </a>
                                            <a href="{% url 'lancamentos:list' %}?perdcomp={{ adesao.perdcomp }}" 
                                               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 w-9"
                                               title="Lançamentos">
                                                <i class="bi bi-card-list text-sm"></i>
                                            </a>
                                        </div>
                                    </td>
                                    <td class="p-4 align-middle">
                                        <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 w-9 btn-history-adesao" 
                                                data-id="{{ adesao.id }}" 
                                                title="Histórico">
                                            <i class="bi bi-clock-history text-sm"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Mobile Card View -->
                <div class="block md:hidden space-y-4">
                    {% for adesao in adesoes %}
                    <div class="bg-card border rounded-lg shadow-sm transition-all duration-200 hover:-translate-y-1 hover:shadow-md">
                        <div class="p-4 border-b">
                            <h3 class="font-semibold text-card-foreground">
                                <span class="text-muted-foreground">Perdcomp:</span> {{ adesao.perdcomp }}
                            </h3>
                        </div>
                        <div class="p-4 space-y-3">
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Cliente:</span>
                                <div class="font-medium">{{ adesao.cliente.id_company_vinculada.nome_fantasia|default:adesao.cliente.id_company_vinculada.razao_social }}</div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Tipo de Crédito:</span>
                                <div class="font-medium">{{ adesao.metodo_credito|default:"—" }}</div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Número Controle:</span>
                                <div class="font-medium">{{ adesao.numero_controle|default:"—" }}</div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Status:</span>
                                {% if adesao.status %}
                                    <span class="inline-flex items-center rounded-full bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 px-2 py-0.5 text-xs font-medium">{{ adesao.get_status_display }}</span>
                                {% else %}
                                    <div class="font-medium text-muted-foreground">—</div>
                                {% endif %}
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Chave SERPRO:</span>
                                <div class="font-medium break-all text-xs">{{ adesao.chave_seguranca_serpro|default:"—" }}</div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Data de Início:</span>
                                <div class="font-medium">{{ adesao.data_inicio|date:"d/m/Y" }}</div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Saldo Inicial:</span>
                                <div class="font-semibold {% if adesao.saldo > 0 %}text-muted-foreground{% elif adesao.saldo < 0 %}text-destructive{% endif %}">
                                    {{ adesao.saldo|br_currency }}
                                </div>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-muted-foreground">Saldo Restante:</span>
                                <div class="font-semibold {% if adesao.saldo_atual > 0 %}text-green-600 dark:text-green-400{% elif adesao.saldo_atual < 0 %}text-destructive{% endif %} saldo-restante-cell" data-saldo="{{ adesao.saldo_atual|default:0 }}">
                                    {{ adesao.saldo_atual|br_currency }}
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-muted/30 border-t flex flex-col gap-2">
                            <a href="{% url 'adesao:detail' adesao.pk %}" 
                               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 w-full">
                                <i class="bi bi-eye mr-2"></i>
                                Detalhes
                            </a>
                            <a href="{% url 'lancamentos:list' %}?perdcomp={{ adesao.perdcomp }}" 
                               class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full">
                                <i class="bi bi-card-list mr-2"></i>
                                Lançamentos
                            </a>
                            <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 w-full btn-history-adesao" 
                                    data-id="{{ adesao.id }}">
                                <i class="bi bi-clock-history mr-2"></i>
                                Histórico
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if is_paginated %}
                <nav class="flex items-center justify-center mt-8" aria-label="Navegação de páginas">
                    <div class="flex items-center gap-2">
                        {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.empresa %}&empresa={{ request.GET.empresa }}{% endif %}{% if request.GET.perdcomp %}&perdcomp={{ request.GET.perdcomp }}{% endif %}" 
                           class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                            Anterior
                        </a>
                        {% endif %}
                        
                        <span class="flex items-center px-4 py-2 text-sm text-muted-foreground">
                            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>
                        
                        {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.empresa %}&empresa={{ request.GET.empresa }}{% endif %}{% if request.GET.perdcomp %}&perdcomp={{ request.GET.perdcomp }}{% endif %}" 
                           class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                            Próximo
                        </a>
                        {% endif %}
                    </div>
                </nav>
                {% endif %}
            {% else %}
                <div class="flex items-center p-4 bg-blue-50 dark:bg-slate-800 border border-blue-200 dark:border-slate-600 rounded-lg">
                    <i class="bi bi-info-circle text-blue-600 dark:text-blue-400 mr-3"></i>
                    <span class="text-blue-800 dark:text-white">Nenhuma adesão cadastrada.</span>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<!-- Modal para Histórico da Adesão -->
<div id="historyAdesaoModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-50" role="dialog" aria-modal="true" aria-labelledby="historyAdesaoTitle">
    <div class="bg-background rounded-lg shadow-xl w-full max-w-lg sm:max-w-3xl md:max-w-5xl lg:max-w-6xl 2xl:max-w-[90rem] border border-border" style="height:80vh;display:flex;flex-direction:column;">
        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b" style="flex-shrink:0;">
            <h3 id="historyAdesaoTitle" class="text-lg font-semibold">Histórico da Adesão</h3>
            <button type="button" id="closeModalBtn" class="rounded-md p-2 hover:bg-accent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" title="Fechar">
                <i class="bi bi-x text-xl"></i>
            </button>
        </div>
        <!-- Body -->
        <div class="px-6 py-4" style="flex:1;overflow-y:auto;min-height:0;">
            <!-- Loading -->
            <div id="history-adesao-loading" class="text-center py-8 hidden">
                <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-muted-foreground">Carregando histórico...</p>
            </div>
            <div class="overflow-x-auto rounded-md border" id="historyAdesaoTableWrap">
                <table class="w-full" id="history-adesao-table">
                    <thead class="border-b bg-muted/50">
                        <tr>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Data</th>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Usuário</th>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Tipo</th>
                            <th class="h-12 px-4 text-left text-sm font-medium text-muted-foreground">Alterações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <!-- Footer -->
        <div class="flex justify-end px-6 py-4 border-t gap-2" style="flex-shrink:0;">
            <button type="button" id="closeModalFooterBtn" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                Fechar
            </button>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split('; ') : [];
    for (let i = 0; i < cookies.length; i++) {
        const parts = cookies[i].split('=');
        const cookieName = decodeURIComponent(parts[0]);
        if (cookieName === name) {
            parts.shift();
            return decodeURIComponent(parts.join('='));
        }
    }
    return null;
}

function getCSRFToken() {
    // Try to get from cookie first
    let token = getCookie('csrftoken');
    
    // If not in cookie, try global variable
    if (!token && window.CSRF_TOKEN) {
        token = window.CSRF_TOKEN;
        console.log('[DEBUG] CSRF token obtido da variável global');
    }
    
    // If still no token, try hidden input (Django {% csrf_token %})
    if (!token) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            token = csrfInput.value;
            console.log('[DEBUG] CSRF token obtido do input hidden');
        }
    }
    
    return token;
}

document.addEventListener('DOMContentLoaded', () => {
    const overlayEls = {
        root: document.getElementById('processing-overlay'),
        progressBar: document.getElementById('overlay-progress-bar'),
        progressText: document.getElementById('overlay-progress-text'),
        progressPercentage: document.getElementById('overlay-progress-percentage'),
        currentFile: document.getElementById('overlay-current-file'),
        closeBtn: document.getElementById('overlay-close-btn'),
        successMessage: document.getElementById('overlay-success-message'),
        successText: document.getElementById('overlay-success-text'),
        title: document.getElementById('processingOverlayTitle'),
    };

    const overlayState = { activeConfig: null };

    const defaultSummaryFormatter = ({ total, success, errors, config }) => {
        const singular = config.labelSingular || 'arquivo';
        const plural = config.labelPlural || 'arquivos';
        const successSingular = config.successLabelSingular || 'processado';
        const successPlural = config.successLabelPlural || 'processados';
        const totalLabel = total === 1 ? singular : plural;
        const successLabel = success === 1 ? successSingular : successPlural;
        let text = `${total} ${totalLabel} recebido${total === 1 ? '' : 's'}. ${success} ${successLabel}.`;
        if (errors > 0) {
            text += ` ${errors} erro${errors === 1 ? '' : 's'}.`;
        }
        return text.trim();
    };

    function resetOverlaySuccessStyles() {
        if (!overlayEls.successMessage) return;
        overlayEls.successMessage.classList.remove('border-red-200', 'bg-red-50', 'dark:border-red-500/40', 'dark:bg-red-500/15');
        overlayEls.successMessage.classList.add('border-green-200', 'bg-green-50', 'dark:border-green-500/40', 'dark:bg-green-500/15');
        const successContent = overlayEls.successMessage.querySelector('.overlay-success-content');
        if (successContent) {
            successContent.classList.remove('text-red-700', 'dark:text-red-300');
            successContent.classList.add('text-green-700', 'dark:text-green-300');
        }
        const successIcon = overlayEls.successMessage.querySelector('.overlay-success-icon');
        if (successIcon) {
            successIcon.classList.remove('bi-x-circle-fill');
            successIcon.classList.add('bi-check-circle-fill');
        }
    }

    function resetProcessingOverlay() {
        if (overlayEls.progressBar) overlayEls.progressBar.style.width = '0%';
        if (overlayEls.progressText) overlayEls.progressText.textContent = '0 de 0 processados';
        if (overlayEls.progressPercentage) overlayEls.progressPercentage.textContent = '0%';
        if (overlayEls.currentFile) overlayEls.currentFile.textContent = '—';
        if (overlayEls.successMessage) overlayEls.successMessage.classList.add('hidden');
        if (overlayEls.closeBtn) overlayEls.closeBtn.classList.add('hidden');
        resetOverlaySuccessStyles();
    }

    function updateOverlayProgress(current, total, currentFileName) {
        const safeTotal = Math.max(total || 0, 0);
        const safeCurrent = Math.min(Math.max(current || 0, 0), safeTotal);
        const percentage = safeTotal > 0 ? Math.round((safeCurrent / safeTotal) * 100) : 0;
        if (overlayEls.progressBar) overlayEls.progressBar.style.width = `${percentage}%`;
        if (overlayEls.progressText) overlayEls.progressText.textContent = `${safeCurrent} de ${safeTotal} processados`;
        if (overlayEls.progressPercentage) overlayEls.progressPercentage.textContent = `${percentage}%`;
        if (overlayEls.currentFile) {
            if (currentFileName) {
                overlayEls.currentFile.textContent = currentFileName;
            } else if (safeTotal > 0 && safeCurrent === safeTotal) {
                overlayEls.currentFile.textContent = 'Concluído!';
            }
        }
    }

    function setProcessingOverlayTitle(title) {
        if (overlayEls.title) {
            overlayEls.title.textContent = title || 'Processando arquivos';
        }
    }

    function showProcessingOverlay(total, config) {
        if (!overlayEls.root) return;
        overlayState.activeConfig = config;
        setProcessingOverlayTitle((config && config.overlayTitle) || 'Processando arquivos');
        resetProcessingOverlay();
        overlayEls.root.classList.remove('hidden');
        overlayEls.root.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        updateOverlayProgress(0, total || 0);
    }

    function showOverlaySummary(items, config, options = {}) {
        if (!overlayEls.root) return;
        const safeItems = Array.isArray(items) ? items : [];
        const totalItems = safeItems.length;
        const successCount = safeItems.filter((item) => item && item.ok).length;
        const errorCount = totalItems - successCount;
        const customMessage = options.customMessage;

        if (overlayEls.successMessage) {
            resetOverlaySuccessStyles();
            if (errorCount > 0 || customMessage) {
                overlayEls.successMessage.classList.remove('border-green-200', 'bg-green-50', 'dark:border-green-500/40', 'dark:bg-green-500/15');
                overlayEls.successMessage.classList.add('border-red-200', 'bg-red-50', 'dark:border-red-500/40', 'dark:bg-red-500/15');
                const successContent = overlayEls.successMessage.querySelector('.overlay-success-content');
                if (successContent) {
                    successContent.classList.remove('text-green-700', 'dark:text-green-300');
                    successContent.classList.add('text-red-700', 'dark:text-red-300');
                }
                const successIcon = overlayEls.successMessage.querySelector('.overlay-success-icon');
                if (successIcon) {
                    successIcon.classList.remove('bi-check-circle-fill');
                    successIcon.classList.add('bi-x-circle-fill');
                }
            }
            if (overlayEls.successText) {
                const formatter = (config && config.summaryFormatter) || defaultSummaryFormatter;
                const summaryText = customMessage || formatter({ total: totalItems, success: successCount, errors: errorCount, config, items: safeItems });
                overlayEls.successText.textContent = summaryText;
            }
            overlayEls.successMessage.classList.remove('hidden');
        }

        if (overlayEls.currentFile) overlayEls.currentFile.textContent = 'Concluído!';
        if (overlayEls.closeBtn) {
            overlayEls.closeBtn.classList.remove('hidden');
            overlayEls.closeBtn.focus();
        }
    }

    function closeProcessingOverlay() {
        if (overlayEls.root) {
            overlayEls.root.classList.add('hidden');
            overlayEls.root.setAttribute('aria-hidden', 'true');
        }
        document.body.style.overflow = '';
        const activeConfig = overlayState.activeConfig;
        overlayState.activeConfig = null;
        if (!activeConfig || activeConfig.reloadOnClose !== false) {
            location.reload();
        }
    }

    if (overlayEls.closeBtn) {
        overlayEls.closeBtn.addEventListener('click', closeProcessingOverlay);
    }
    if (overlayEls.root) {
        overlayEls.root.addEventListener('click', (event) => {
            if (event.target === overlayEls.root && overlayEls.closeBtn && !overlayEls.closeBtn.classList.contains('hidden')) {
                closeProcessingOverlay();
            }
        });
    }
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && overlayEls.root && !overlayEls.root.classList.contains('hidden') && overlayEls.closeBtn && !overlayEls.closeBtn.classList.contains('hidden')) {
            closeProcessingOverlay();
        }
    });

    const importConfig = {
        rootId: 'importDropZone',
        containerId: 'importDropZoneContainer',
        toggleId: 'importToggleButton',
        fileInputId: 'importFileInput',
        browseButtonId: 'importBrowseButton',
        dropZoneTextId: 'importDropZoneText',
        dropZoneHintId: 'importDropZoneHint',
        overlayId: 'importDropZoneOverlay',
        overlayTextId: 'importDropZoneOverlayText',
        importTypes: {
            recibo: {
                uploadUrlAttr: 'data-recibo-url',
                overlayTitle: 'Processando recibos',
                labelSingular: 'recibo',
                labelPlural: 'recibos',
                successLabelSingular: 'importado',
                successLabelPlural: 'importados',
                processingMessageBuilder: ({ index, total }) => `Processando recibo ${index} de ${total}...`,
                successMessageBuilder: ({ data, file }) => {
                    const label = data && (data.numero_documento || data.perdcomp)
                        ? (data.numero_documento || data.perdcomp)
                        : file.name;
                    return `Recibo do PERDCOMP ${label} importado com sucesso.`;
                },
                description: 'Importe o recibo de pedido de crédito recebido ao protocolar o PERDCOMP. O arquivo atualizará número de controle, chave SERPRO e status.',
                hint: 'Você pode importar vários recibos; cada arquivo deve corresponder a um PERDCOMP existente.',
            },
            credito: {
                uploadUrlAttr: 'data-credito-url',
                overlayTitle: 'Processando notificações',
                labelSingular: 'notificação',
                labelPlural: 'notificações',
                successLabelSingular: 'importada',
                successLabelPlural: 'importadas',
                processingMessageBuilder: ({ index, total }) => `Processando notificação ${index} de ${total}...`,
                successMessageBuilder: ({ data, file }) => {
                    const label = data && data.perdcomp ? data.perdcomp : file.name;
                    return `Notificação de crédito do PERDCOMP ${label} importada com sucesso.`;
                },
                description: 'Importe a notificação de crédito em conta emitida pela Receita Federal para registrar automaticamente o lançamento aprovado.',
                hint: 'Cada notificação deve corresponder a um PERDCOMP já cadastrado e resultará em um crédito aprovado.',
            },
            compensacao: {
                uploadUrlAttr: 'data-compensacao-url',
                overlayTitle: 'Processando declarações de compensação',
                labelSingular: 'declaração',
                labelPlural: 'declarações',
                successLabelSingular: 'processada',
                successLabelPlural: 'processadas',
                processingMessageBuilder: ({ index, total }) => `Processando declaração ${index} de ${total}...`,
                successMessageBuilder: ({ data, file }) => {
                    const referencia = data && (data.perdcomp_declaracao || data.perdcomp_inicial) ? (data.perdcomp_declaracao || data.perdcomp_inicial) : file.name;
                    const createdCount = data && typeof data.created_count === 'number' ? data.created_count : null;
                    const skippedCount = data && typeof data.skipped_count === 'number' ? data.skipped_count : 0;
                    const errorCount = data && typeof data.error_count === 'number' ? data.error_count : 0;
                    const notes = [];
                    if (skippedCount > 0) {
                        notes.push(`${skippedCount} já existente${skippedCount === 1 ? '' : 's'}`);
                    }
                    if (errorCount > 0) {
                        notes.push(`${errorCount} inválido${errorCount === 1 ? '' : 's'}`);
                    }
                    const suffix = notes.length ? ` (${notes.join(', ')})` : '';
                    if (createdCount && createdCount > 0) {
                        return `Declaração ${referencia} importada com ${createdCount} débito${createdCount === 1 ? '' : 's'}${suffix}.`;
                    }
                    if (notes.length) {
                        return `Declaração ${referencia} analisada${suffix}.`;
                    }
                    return `Declaração ${referencia} analisada, nenhum débito novo encontrado.`;
                },
                description: 'Importe declarações de compensação para registrar automaticamente débitos e atualizar o saldo do PER/DCOMP inicial informado.',
                hint: 'Cada declaração deve conter o campo "PER/DCOMP inicial" já cadastrado no sistema.',
            },
        },
        summaryConfig: {
            overlayTitle: 'Processando PDFs detectados automaticamente',
        },
    };

    initDynamicDropZone(importConfig);

    function initDynamicDropZone(config) {
        const dropZone = document.getElementById(config.rootId);
        if (!dropZone) return;

        const container = config.containerId ? document.getElementById(config.containerId) : null;
        const toggleButton = config.toggleId ? document.getElementById(config.toggleId) : null;
        const fileInput = config.fileInputId ? document.getElementById(config.fileInputId) : dropZone.querySelector('input[type="file"]');
        const browseButton = config.browseButtonId ? document.getElementById(config.browseButtonId) : null;
        const dropZoneText = config.dropZoneTextId ? document.getElementById(config.dropZoneTextId) : null;
        const dropZoneHint = config.dropZoneHintId ? document.getElementById(config.dropZoneHintId) : null;
        const zoneOverlay = config.overlayId ? document.getElementById(config.overlayId) : null;
        const zoneOverlayText = config.overlayTextId ? document.getElementById(config.overlayTextId) : null;

        const defaultText = dropZoneText ? dropZoneText.textContent.trim() : '';
        const defaultHint = dropZoneHint ? dropZoneHint.textContent.trim() : '';
        const overlayDefaultText = zoneOverlayText ? zoneOverlayText.textContent.trim() : '';

        const humanTypeLabels = {
            recibo: 'recibo de protocolo',
            credito: 'notificação de crédito em conta',
            compensacao: 'declaração de compensação',
        };
        const typePluralLabels = {
            recibo: 'recibos de protocolo',
            credito: 'notificações de crédito em conta',
            compensacao: 'declarações de compensação',
        };
        const baseSummaryDefaults = {
            overlayTitle: 'Processando arquivos',
            labelSingular: 'arquivo',
            labelPlural: 'arquivos',
            successLabelSingular: 'processado',
            successLabelPlural: 'processados',
        };
        const summaryConfig = { ...baseSummaryDefaults, ...(config.summaryConfig || {}) };
        if (!summaryConfig.summaryFormatter) {
            summaryConfig.summaryFormatter = ({ total, success, errors, items }) => {
                const parts = [];
                parts.push(`${total} arquivo${total === 1 ? '' : 's'} recebido${total === 1 ? '' : 's'}.`);
                if (success > 0) {
                    const successBreakdown = (items || []).filter((item) => item && item.ok && item.typeKey)
                        .reduce((acc, item) => {
                            acc[item.typeKey] = (acc[item.typeKey] || 0) + 1;
                            return acc;
                        }, {});
                    const detailParts = Object.entries(successBreakdown).map(([key, count]) => {
                        const label = count === 1 ? (humanTypeLabels[key] || key) : (typePluralLabels[key] || `${key}s`);
                        return `${count} ${label}`;
                    });
                    const detailSuffix = detailParts.length ? ` (${detailParts.join(', ')})` : '';
                    parts.push(`${success} concluído${success === 1 ? '' : 's'}${detailSuffix}.`);
                }
                if (errors > 0) {
                    parts.push(`${errors} erro${errors === 1 ? '' : 's'}.`);
                }
                return parts.join(' ').trim();
            };
        }

        const fatalStatusCodes = new Set([401, 403, 404, 500, 502, 503, 504]);

        const setDropZoneExpanded = (expanded) => {
            if (!container || !toggleButton) return;
            if (expanded) {
                container.classList.remove('hidden');
                toggleButton.setAttribute('aria-expanded', 'true');
                container.setAttribute('aria-hidden', 'false');
                toggleButton.innerHTML = '<i class="bi bi-chevron-up mr-2" aria-hidden="true"></i>Recolher área';
            } else {
                container.classList.add('hidden');
                toggleButton.setAttribute('aria-expanded', 'false');
                container.setAttribute('aria-hidden', 'true');
                toggleButton.innerHTML = '<i class="bi bi-chevron-down mr-2" aria-hidden="true"></i>Expandir área';
            }
        };

        const ensureDropZoneVisible = () => {
            if (container && container.classList.contains('hidden')) {
                setDropZoneExpanded(true);
            }
        };

        if (toggleButton) {
            toggleButton.addEventListener('click', () => {
                if (!container) return;
                const isExpanded = !container.classList.contains('hidden');
                setDropZoneExpanded(!isExpanded);
            });
        }

        const toggleUploading = (isUploading, message) => {
            if (isUploading) {
                ensureDropZoneVisible();
                dropZone.classList.add('border-primary', 'bg-muted/40');
                if (zoneOverlay) zoneOverlay.classList.remove('hidden');
                if (zoneOverlayText) zoneOverlayText.textContent = message || overlayDefaultText;
                if (dropZoneText && message) dropZoneText.textContent = message;
                if (dropZoneHint) dropZoneHint.textContent = 'Processando arquivo...';
                if (browseButton) browseButton.disabled = true;
                dropZone.setAttribute('aria-busy', 'true');
            } else {
                dropZone.classList.remove('border-primary', 'bg-muted/40');
                if (zoneOverlay) zoneOverlay.classList.add('hidden');
                if (zoneOverlayText) zoneOverlayText.textContent = overlayDefaultText;
                if (dropZoneText) dropZoneText.textContent = defaultText;
                if (dropZoneHint) dropZoneHint.textContent = defaultHint;
                if (browseButton) browseButton.disabled = false;
                dropZone.removeAttribute('aria-busy');
            }
        };

        const getTypeConfig = (typeKey) => {
            const typeConfig = config.importTypes && config.importTypes[typeKey];
            if (!typeConfig) return null;
            const uploadUrlAttr = typeConfig.uploadUrlAttr;
            const uploadUrl = uploadUrlAttr ? dropZone.getAttribute(uploadUrlAttr) : null;
            if (!uploadUrl) return null;
            return { ...typeConfig, uploadUrl, typeKey };
        };

        const normalizeText = (value) => {
            if (!value) return '';
            let normalized = value;
            if (typeof normalized.normalize === 'function') {
                normalized = normalized.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }
            return normalized.toLowerCase();
        };

        const detectPdfType = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const buffer = reader.result;
                    let rawText = '';
                    if (buffer instanceof ArrayBuffer) {
                        if (typeof TextDecoder !== 'undefined') {
                            const decoder = new TextDecoder('latin1', { fatal: false });
                            rawText = decoder.decode(buffer);
                        } else {
                            rawText = Array.from(new Uint8Array(buffer)).map((byte) => String.fromCharCode(byte)).join('');
                        }
                    } else if (typeof buffer === 'string') {
                        rawText = buffer;
                    }
                    const normalized = normalizeText(rawText);
                    if (normalized.includes('recibo d entrega') || normalized.includes('recibo de entrega')) {
                        resolve('recibo');
                        return;
                    }
                    if (normalized.includes('aviso de pagamento de ressarcimento')) {
                        resolve('credito');
                        return;
                    }
                    if (normalized.includes('declaracao de compensacao') || normalized.includes('per/dcomp inicial')) {
                        resolve('compensacao');
                        return;
                    }
                } catch (error) {
                    console.warn('Falha ao analisar PDF para detecção automática:', error);
                }
                resolve(null);
            };
            reader.onerror = () => {
                console.warn('Falha ao ler PDF para detecção automática.');
                resolve(null);
            };
            reader.readAsArrayBuffer(file);
        });

        const uploadToEndpoint = async (file, typeKey, typeConfig) => {
            try {
                const csrfToken = getCSRFToken();
                console.log(`[DEBUG] (${typeKey}) CSRF Token:`, csrfToken ? 'Encontrado' : 'NÃO ENCONTRADO');
                console.log('[DEBUG] Cookies disponíveis:', document.cookie);
                console.log('[DEBUG] window.CSRF_TOKEN:', window.CSRF_TOKEN ? 'Definido' : 'Não definido');
                if (!csrfToken) {
                    return {
                        ok: false,
                        message: `${file.name}: Token de segurança não encontrado. Recarregue a página e tente novamente.`,
                        typeKey,
                        fatal: true,
                        status: 0,
                        file: file.name,
                    };
                }

                const formData = new FormData();
                formData.append('pdf', file, file.name);

                console.log(`[DEBUG] (${typeKey}) Fazendo upload para:`, typeConfig.uploadUrl);
                const response = await fetch(typeConfig.uploadUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    body: formData,
                });
                console.log(`[DEBUG] (${typeKey}) Status da resposta:`, response.status);
                const data = await response.json().catch(() => null);

                if (!response.ok || !data) {
                    let errorDetail = `Status ${response.status}`;
                    if (response.status === 403) {
                        errorDetail = 'Acesso negado (403). Verifique suas permissões ou recarregue a página.';
                    } else if (response.status === 401) {
                        errorDetail = 'Sessão expirada (401). Faça login novamente.';
                    } else if (response.status === 404) {
                        errorDetail = 'Endpoint não encontrado (404).';
                    }
                    return {
                        ok: false,
                        message: `${file.name}: ${errorDetail}`,
                        typeKey,
                        status: response.status,
                        fatal: fatalStatusCodes.has(response.status),
                        file: file.name,
                    };
                }

                if (!data.ok) {
                    const errorMsg = data.error || 'Não foi possível concluir a importação.';
                    return {
                        ok: false,
                        message: `${file.name}: ${errorMsg}`,
                        typeKey,
                        status: response.status,
                        fatal: fatalStatusCodes.has(response.status),
                        data,
                        file: file.name,
                    };
                }

                const successBuilder = typeConfig.successMessageBuilder;
                const message = successBuilder ? successBuilder({ data, file }) : `Arquivo ${file.name} importado com sucesso.`;

                return {
                    ok: true,
                    message,
                    typeKey,
                    typeLabel: humanTypeLabels[typeKey] || typeKey,
                    status: response.status,
                    data,
                    created: Boolean(data.created),
                    detail_url: data.detail_url,
                    fields: data.fields,
                    file: file.name,
                    fatal: false,
                };
            } catch (error) {
                return {
                    ok: false,
                    message: `${file.name}: ${error && error.message ? error.message : 'Erro desconhecido.'}`,
                    typeKey,
                    fatal: true,
                    status: 0,
                    file: file.name,
                };
            }
        };

        const autoDetectAndUpload = async (file, context = {}) => {
            const detectedType = await detectPdfType(file);
            console.log(`[DEBUG] Detecção automática (${file.name}):`, detectedType || 'indefinida');

            const baseOrder = ['recibo', 'credito', 'compensacao'];
            const order = (detectedType && baseOrder.includes(detectedType))
                ? [detectedType, ...baseOrder.filter((type) => type !== detectedType)]
                : baseOrder;

            let lastResult = {
                ok: false,
                message: `${file.name}: Não foi possível processar o arquivo.`,
                typeKey: null,
                file: file.name,
                detectedFromText: detectedType,
            };

            for (const typeKey of order) {
                const typeConfig = getTypeConfig(typeKey);
                if (!typeConfig) {
                    console.warn(`Configuração de upload ausente para o tipo ${typeKey}.`);
                    continue;
                }

                const humanIndex = context.index ?? null;
                const total = context.total ?? null;
                const label = humanTypeLabels[typeKey] || typeKey;
                const statusMessage = humanIndex && total
                    ? `Enviando ${file.name} como ${label} (${humanIndex} de ${total})...`
                    : `Enviando ${file.name} como ${label}...`;
                toggleUploading(true, statusMessage);

                const result = await uploadToEndpoint(file, typeKey, typeConfig);
                result.detectedFromText = detectedType;
                result.file = file.name;
                result.typeKey = typeKey;
                result.typeLabel = result.typeLabel || humanTypeLabels[typeKey] || typeKey;
                result.autoDetected = detectedType === typeKey;

                if (result.ok) {
                    return result;
                }

                lastResult = result;

                if (result.fatal) {
                    return result;
                }
            }

            return lastResult;
        };

        const handleFiles = async (fileList) => {
            if (!fileList || !fileList.length) {
                return;
            }

            ensureDropZoneVisible();

            const filesArray = Array.from(fileList);
            const pdfFiles = [];
            const results = [];

            filesArray.forEach((file) => {
                const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                if (isPdf) {
                    pdfFiles.push(file);
                } else {
                    results.push({
                        ok: false,
                        message: `${file.name} não é um arquivo PDF.`,
                        typeKey: null,
                        file: file.name,
                        fatal: false,
                    });
                }
            });

            if (!pdfFiles.length) {
                const message = results.length ? results[0].message : 'Nenhum arquivo PDF válido selecionado.';
                showProcessingOverlay(results.length || 0, summaryConfig);
                if (overlayEls.currentFile) overlayEls.currentFile.textContent = message;
                updateOverlayProgress(0, results.length || 0);
                showOverlaySummary(results, summaryConfig, { customMessage: message });
                if (fileInput) fileInput.value = '';
                return;
            }

            const total = pdfFiles.length;
            showProcessingOverlay(total, summaryConfig);
            updateOverlayProgress(0, total);

            let index = 0;
            try {
                for (const file of pdfFiles) {
                    index += 1;
                    toggleUploading(true, `Analisando ${file.name} (${index} de ${total})...`);
                    updateOverlayProgress(index - 1, total, file.name);
                    const result = await autoDetectAndUpload(file, { index, total });
                    results.push(result);
                    updateOverlayProgress(index, total, index === total ? 'Concluído!' : undefined);
                }
            } finally {
                toggleUploading(false);
            }

            showOverlaySummary(results, summaryConfig);
            if (fileInput) fileInput.value = '';
        };

        dropZone.addEventListener('click', () => {
            if (fileInput && !dropZone.hasAttribute('aria-busy')) {
                fileInput.click();
            }
        });

        dropZone.addEventListener('keydown', (event) => {
            if ((event.key === 'Enter' || event.key === ' ') && fileInput && !dropZone.hasAttribute('aria-busy')) {
                event.preventDefault();
                fileInput.click();
            }
        });

        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropZone.classList.add('border-primary', 'bg-muted/40');
            if (!dropZone.hasAttribute('aria-busy')) {
                if (dropZoneText) dropZoneText.textContent = 'Solte os arquivos para importar.';
                if (dropZoneHint) dropZoneHint.textContent = 'Vamos identificar automaticamente cada PDF.';
            }
        });

        dropZone.addEventListener('dragleave', (event) => {
            event.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-muted/40');
            if (!dropZone.hasAttribute('aria-busy')) {
                if (dropZoneText) dropZoneText.textContent = defaultText;
                if (dropZoneHint) dropZoneHint.textContent = defaultHint;
            }
        });

        dropZone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-muted/40');
            if (dropZone.hasAttribute('aria-busy')) {
                return;
            }
            const files = event.dataTransfer && event.dataTransfer.files;
            if (files && files.length) {
                handleFiles(files);
            } else {
                if (dropZoneText) dropZoneText.textContent = defaultText;
                if (dropZoneHint) dropZoneHint.textContent = defaultHint;
            }
        });

        if (browseButton) {
            browseButton.addEventListener('click', (event) => {
                event.stopPropagation();
                if (fileInput && !dropZone.hasAttribute('aria-busy')) {
                    fileInput.click();
                }
            });
        }

        if (fileInput) {
            fileInput.addEventListener('change', (event) => {
                const target = event.target;
                if (target && target.files && target.files.length) {
                    handleFiles(target.files);
                }
            });
        }
    }
});

// Modal functionality
const modal = document.getElementById('historyAdesaoModal');
const closeButtons = document.querySelectorAll('#closeModalBtn, #closeModalFooterBtn');

function openModal() {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
}

// Close modal event listeners
closeButtons.forEach(btn => {
    btn.addEventListener('click', closeModal);
});

// Close modal when clicking backdrop (outside panel)
modal.addEventListener('click', (e) => {
    if (e.target === modal) {
        closeModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
    }
});

// Compute and display total saldo restante
function formatBRL(value){
    try { return (new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })).format(value || 0); } catch { return 'R$ ' + (value||0).toFixed(2); }
}

document.addEventListener('DOMContentLoaded', () => {
    const metric = document.getElementById('metric-saldo-restante-total');
    if(metric && metric.getAttribute('data-server') === '1') return; // keep server-rendered formatting
    const cells = document.querySelectorAll('.saldo-restante-cell');
    let total = 0;
    cells.forEach(c => {
        const raw = parseFloat(c.getAttribute('data-saldo'));
        if(!isNaN(raw)) total += raw;
    });
    if(metric) metric.textContent = formatBRL(total);
});

// History button functionality
document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-history-adesao');
    if (!btn) return;
    
    const id = btn.getAttribute('data-id');
    const tbody = document.querySelector('#history-adesao-table tbody');
    const loadingEl = document.getElementById('history-adesao-loading');
    
    // Clear previous content and show loading
    tbody.innerHTML = '';
    loadingEl.classList.remove('hidden');
    
    // Open modal
    openModal();
    
    try {
        const resp = await fetch(`${window.location.origin}${window.location.pathname}historico/${id}/`);
        if (!resp.ok) throw new Error('Falha ao carregar histórico');
        
        const data = await resp.json();
        const hist = data.history || [];
        
        hist.forEach(entry => {
            const tr = document.createElement('tr');
            tr.className = 'border-b transition-colors hover:bg-muted/50';
            
            const tipoMap = { '+': 'Criação', '~': 'Atualização', '-': 'Exclusão' };
            const tipoClass = { '+': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200', '~': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200', '-': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' };
            
            const alteracoes = entry.changes.map(c => 
                `<div class="mb-2"><span class="inline-flex items-center rounded-md bg-muted px-2 py-1 text-xs font-medium text-muted-foreground">${c.field}</span> <span class="font-medium">${c.old === null ? '<em class="text-muted-foreground">(vazio)</em>' : c.old}</span> → <span class="font-medium">${c.new === null ? '<em class="text-muted-foreground">(vazio)</em>' : c.new}</span></div>`
            ).join('');
            
            const note = entry.note ? `<div class="text-sm text-muted-foreground">${entry.note}</div>` : '';
            
            tr.innerHTML = `
                <td class="p-4 align-middle">${entry.history_date}</td>
                <td class="p-4 align-middle">${entry.history_user || '-'}</td>
                <td class="p-4 align-middle">
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ${tipoClass[entry.history_type] || 'bg-muted text-muted-foreground'}">
                        ${tipoMap[entry.history_type] || entry.history_type}
                    </span>
                </td>
                <td class="p-4 align-middle">
                    ${alteracoes || note || '<span class="text-muted-foreground">Nenhuma alteração</span>'}
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        if (hist.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="4" class="p-8 text-center text-muted-foreground">Nenhum histórico encontrado</td>`;
            tbody.appendChild(tr);
        }
    } catch (err) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="p-4 text-center text-destructive">${err.message}</td>`;
        tbody.appendChild(tr);
    } finally {
        loadingEl.classList.add('hidden');
    }
});
</script>
{% endblock %}
