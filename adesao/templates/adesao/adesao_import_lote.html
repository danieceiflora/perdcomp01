{% extends 'base.html' %}
{% load static %}

{% block title %}Importação de PDFs{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <div class="max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-semibold"><i class="bi bi-files mr-2"></i>Importação de PDFs</h1>
      <a href="{% url 'adesao:list' %}" class="inline-flex items-center justify-center rounded-md text-sm font-medium border h-10 px-4 py-2">
        <i class="bi bi-arrow-left mr-2"></i>Voltar
      </a>
    </div>

    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
      <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div class="space-y-2 md:col-span-2">
          <label class="text-sm font-medium leading-none">Selecionar PDFs (um ou mais):</label>
          <input id="pdf-files-batch" type="file" accept="application/pdf" multiple class="block w-full text-sm border rounded-lg" />
          <div class="flex items-center gap-2 mt-2">
            <input id="toggle-criar" type="checkbox" class="h-4 w-4" checked />
            <label for="toggle-criar" class="text-sm">Criar adesões automaticamente</label>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="btn-import-pdf-batch" type="button" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
            <i class="bi bi-upload mr-2"></i>Processar lote
          </button>
          <div id="pdf-loading-batch" class="hidden items-center text-sm text-muted-foreground"><span class="animate-pulse">Processando lote...</span></div>
        </div>
      </div>
      <div id="pdf-feedback-batch" class="px-6 pb-4 text-sm"></div>
      <div id="pdf-results-batch" class="px-6 pb-6 space-y-2"></div>
    </div>

    <div class="mt-6">
      <a href="{% url 'adesao:importacao_logs_page' %}" class="text-sm text-blue-700 underline">Ver histórico de importações</a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const inputFilesBatch = document.getElementById('pdf-files-batch');
    const btnBatch = document.getElementById('btn-import-pdf-batch');
    const toggleCriar = document.getElementById('toggle-criar');
    const feedback = document.getElementById('pdf-feedback-batch');
    const loading = document.getElementById('pdf-loading-batch');
    const results = document.getElementById('pdf-results-batch');

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    function setFeedback(msg, ok=true) {
      if (!feedback) return; feedback.className = 'px-6 pb-4 text-sm ' + (ok ? 'text-green-700' : 'text-red-700');
      feedback.textContent = msg || '';
    }
    function renderResults(list) {
      if (!results) return; results.innerHTML = '';
      (list || []).forEach(item => {
        const div = document.createElement('div');
        div.className = 'rounded border p-3 text-sm ' + (item.ok ? 'border-green-300' : 'border-red-300');
        const name = document.createElement('div'); name.className = 'font-medium'; name.textContent = item.file || '(arquivo)'; div.appendChild(name);
        const msg = document.createElement('div');
        if (item.ok) {
          msg.textContent = item.created ? 'Criado com sucesso.' : 'Extraído com sucesso.';
          if (item.detail_url) {
            const a = document.createElement('a'); a.href = item.detail_url; a.textContent = 'Ver detalhes'; a.className = 'text-blue-700 underline ml-2';
            msg.appendChild(a);
          }
          // Quando não criar automaticamente, exibir campos extraídos
          if (!item.created && item.fields) {
            const f = item.fields || {};
            const fmt = (v) => (v === null || v === undefined || v === '' ? '—' : String(v));
            const details = document.createElement('div');
            details.className = 'mt-2 grid grid-cols-1 md:grid-cols-2 gap-2';
            const pairs = [
              ['Cliente', f.cliente_label || f.cliente],
              ['PERDCOMP', f.perdcomp],
              ['Método', f.metodo_credito],
              ['Data de Criação', f.data_inicio],
              ['Data de Arrecadação', f.data_arrecadacao],
              ['Saldo (Valor do Pedido)', f.saldo],
              ['Ano', f.ano],
              ['Trimestre', f.trimestre],
              ['Tipo de Crédito', f.tipo_credito],
              ['Período Apuração (Crédito)', f.periodo_apuracao_credito],
              ['Código da Receita', f.codigo_receita],
            ];
            pairs.forEach(([label, value]) => {
              const row = document.createElement('div');
              row.className = 'flex items-center justify-between border-b border-slate-100 py-1';
              const l = document.createElement('span'); l.className = 'text-slate-500'; l.textContent = label;
              const v = document.createElement('span'); v.className = 'font-medium'; v.textContent = fmt(value);
              row.appendChild(l); row.appendChild(v); details.appendChild(row);
            });
            div.appendChild(details);
          }
        } else { msg.textContent = item.error || 'Erro'; }
        div.appendChild(msg);
        results.appendChild(div);
      });
    }

    async function processarLote() {
      if (!inputFilesBatch || !inputFilesBatch.files || inputFilesBatch.files.length === 0) {
        setFeedback('Selecione um ou mais arquivos PDF.', false); return;
      }
      const formData = new FormData();
      Array.from(inputFilesBatch.files).forEach(f => formData.append('pdfs', f));
      formData.append('criar', toggleCriar && toggleCriar.checked ? '1' : '0');
      setFeedback(''); renderResults([]);
      loading && loading.classList.remove('hidden'); btnBatch && (btnBatch.disabled = true);
      try {
  const resp = await fetch("{% url 'adesao:importar_pdf_lote' %}", {
          method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') || '' }, body: formData
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) { setFeedback(data.error || 'Falha ao importar em lote.', false); return; }
        setFeedback('Lote processado.', true); renderResults(data.results || []);
      } catch (e) { setFeedback('Erro inesperado ao importar em lote.', false); }
      finally { loading && loading.classList.add('hidden'); btnBatch && (btnBatch.disabled = false); }
    }

    if (btnBatch) btnBatch.addEventListener('click', processarLote);
  });
</script>
{% endblock %}
