{% extends 'base.html' %}
{% load static %}
{% load form_tags %}

{% block title %}Cadastrar Novo Cliente{% endblock %}

{% block extra_css %}
<style>
    .required-field::after {
        content: " *";
        color: hsl(var(--destructive));
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-foreground flex items-center gap-2">
            <i class="bi bi-person-plus"></i>
            {% if object %}Editar Cliente{% else %}Cadastrar Novo Cliente{% endif %}
        </h1>
        <p class="text-muted-foreground mt-1">
            {% if object %}Atualize os dados do cliente{% else %}Preencha os dados para cadastrar um novo cliente e estabelecer o vínculo com o parceiro{% endif %}
        </p>
    </div>

    <form method="post" id="clienteForm" class="space-y-6" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Partner Selection Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="bi bi-handshake"></i>
                    1. {% if object %}Parceiro Vinculado{% else %}Seleção do Parceiro{% endif %}
                </h3>
            </div>
            <div class="card-content">
                <div>
                    <label for="{{ form.parceiro.id_for_label }}" class="block text-sm font-medium text-foreground mb-2 required-field">
                        {{ form.parceiro.label }}
                    </label>
                    {{ form.parceiro|add_class:"input" }}
                    {% if form.parceiro.help_text %}
                        <p class="text-sm text-muted-foreground mt-1">{{ form.parceiro.help_text }}</p>
                    {% endif %}
                    {% if form.parceiro.errors %}
                        <p class="text-sm text-destructive mt-1">{{ form.parceiro.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Company Data Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="bi bi-building"></i>
                    2. {% if object %}Dados da Empresa{% else %}Cadastro de Nova Empresa{% endif %}
                </h3>
            </div>
            <div class="card-content">
                {% if empresa_form.non_field_errors %}
                    <div class="rounded-md border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800 dark:border-red-800 dark:bg-red-950 dark:text-red-200 mb-4">
                        {{ empresa_form.non_field_errors }}
                    </div>
                {% endif %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for field in empresa_form %}
                        <div class="{% if field.name == 'razao_social' or field.name == 'nome_fantasia' %}md:col-span-2{% endif %}">
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-foreground mb-2">
                                {{ field.label }}
                            </label>
                            {% if field.name == 'logomarca' %}
                                <input type="{{ field.field.widget.input_type }}" 
                                       name="{{ field.name }}" 
                                       id="{{ field.id_for_label }}"
                                       class="block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-primary file:text-primary-foreground hover:file:bg-primary/90 border border-input rounded-md">
                            {% else %}
                                {{ field|add_class:"input" }}
                            {% endif %}
                            {% if field.help_text %}
                                <p class="text-sm text-muted-foreground mt-1">{{ field.help_text }}</p>
                            {% endif %}
                            {% if field.errors %}
                                <p class="text-sm text-destructive mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sócios Section -->
        <div class="card">
            <div class="card-header flex items-center justify-between">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="bi bi-people"></i>
                    3. Sócios da Empresa
                    <!-- Debug Info -->
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2">
                        Debug: {{ socios_existentes|length }} sócios | {{ socios_entries|length }} entries | {{ participacoes_total|default:"?" }} participações
                    </span>
                </h3>
                <button type="button" id="addSocioBtn" class="btn-primary text-sm"><i class="bi bi-plus-lg mr-2"></i>Adicionar Sócio</button>
            </div>
                        <div class="card-content" id="sociosContainer">
                            {% for entry in socios_entries %}
                            <div class="socio-item border border-border rounded-md p-4 space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-2">Sócio Existente</label>
                                        <select name="existing_socio_{{ entry.index }}" class="input">
                                            <option value="">-- Selecionar --</option>
                                            {% for s in socios_existentes %}
                                                <option value="{{ s.id }}" {% if entry.existing|default:'' == s.id|stringformat:'s' %}selected{% endif %}>{{ s.nome }} ({{ s.cpf }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-foreground mb-2">Nome Novo</label>
                                        <input type="text" name="nome_novo_{{ entry.index }}" value="{{ entry.nome }}" placeholder="Cadastrar novo" class="input" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-2">CPF Novo</label>
                                        <input type="text" name="cpf_novo_{{ entry.index }}" value="{{ entry.cpf }}" placeholder="Somente dígitos" class="input" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-2">Percentual (%)</label>
                                        <input type="text" name="percentual_{{ entry.index }}" value="{{ entry.percentual }}" placeholder="Opcional" class="input" />
                                    </div>
                                </div>
                                <div>
                                    <button type="button" class="btn-remove-socio inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-2 text-xs font-medium text-foreground transition-colors hover:bg-destructive hover:text-destructive-foreground"><i class="bi bi-trash mr-1"></i>Remover</button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="socio_count" id="socioCount" value="{{ socios_entries|length }}" />
        </div>

        <!-- Reference and Contact Data Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="bi bi-person"></i>
                    4. Dados de Referência e Contato
                </h3>
            </div>
            <div class="card-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="{{ form.nome_referencia.id_for_label }}" class="block text-sm font-medium text-foreground mb-2 required-field">
                            {{ form.nome_referencia.label }}
                        </label>
                        {{ form.nome_referencia|add_class:"input" }}
                        {% if form.nome_referencia.help_text %}
                            <p class="text-sm text-muted-foreground mt-1">{{ form.nome_referencia.help_text }}</p>
                        {% endif %}
                        {% if form.nome_referencia.errors %}
                            <p class="text-sm text-destructive mt-1">{{ form.nome_referencia.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.cargo_referencia.id_for_label }}" class="block text-sm font-medium text-foreground mb-2">
                            {{ form.cargo_referencia.label }}
                        </label>
                        {{ form.cargo_referencia|add_class:"input" }}
                        {% if form.cargo_referencia.help_text %}
                            <p class="text-sm text-muted-foreground mt-1">{{ form.cargo_referencia.help_text }}</p>
                        {% endif %}
                        {% if form.cargo_referencia.errors %}
                            <p class="text-sm text-destructive mt-1">{{ form.cargo_referencia.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Contact Data -->
                <div class="border-t pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-medium text-foreground flex items-center gap-2">
                            <i class="bi bi-telephone"></i>
                            Dados de Contato
                        </h4>
                        <button type="button" class="btn-primary text-sm" onclick="addContactForm()">
                            <i class="bi bi-plus-lg mr-2"></i>Adicionar Contato
                        </button>
                    </div>
                    
                    <div id="contato-forms" class="space-y-4">
                        {{ contato_formset.management_form }}
                        {% for form_contato in contato_formset %}
                            <div class="card contact-form bg-muted/50" data-form-index="{{ forloop.counter0 }}">
                                <div class="card-content">
                                    {% if not forloop.first %}
                                        <button type="button" class="float-right inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-2 text-xs font-medium text-foreground transition-colors hover:bg-destructive hover:text-destructive-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring btn-remove-contact" onclick="removeContactForm(this)">
                                            <i class="bi bi-x mr-1"></i>Remover
                                        </button>
                                    {% endif %}
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-foreground mb-2">Tipo de Contato</label>
                                            {{ form_contato.tipo_contato|add_class:"input" }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-foreground mb-2">Telefone</label>
                                            {{ form_contato.telefone|add_class:"input" }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-foreground mb-2">E-mail</label>
                                            {{ form_contato.email|add_class:"input" }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-foreground mb-2">Site</label>
                                            {{ form_contato.site|add_class:"input" }}
                                        </div>
                                    </div>
                                    {% if form_contato.non_field_errors %}
                                        <p class="text-sm text-destructive mt-2">{{ form_contato.non_field_errors }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% if contato_formset.non_form_errors %}
                        <p class="text-sm text-destructive mt-2">{{ contato_formset.non_form_errors }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Form Errors -->
        {% if form.non_field_errors %}
            <div class="rounded-md border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800 dark:border-red-800 dark:bg-red-950 dark:text-red-200">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="flex justify-between items-center">
            <a href="{% url 'lista_clientes' %}" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium text-foreground shadow-sm transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                <i class="bi bi-arrow-left mr-2"></i>Voltar
            </a>
            <button type="submit" class="btn-primary text-base px-8 py-3">
                <i class="bi bi-check-lg mr-2"></i>Salvar
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/imask"></script>
<script>
// Add class helper for Django forms with Tailwind
document.addEventListener('DOMContentLoaded', function() {
    // Add Tailwind classes to form fields
    const inputs = document.querySelectorAll('input:not([type="hidden"]):not([type="file"]), select, textarea');
    inputs.forEach(input => {
        if (!input.classList.contains('input')) {
            input.classList.add('input');
        }
    });

    // Apply masks
    applyMasks(document);
    // Sócios dynamic setup
    const sociosContainer = document.getElementById('sociosContainer');
    const socioCountInput = document.getElementById('socioCount');
    const addSocioBtn = document.getElementById('addSocioBtn');
    function bindRemoveSocios(){
        document.querySelectorAll('.btn-remove-socio').forEach(btn => {
            btn.onclick = function(){
                const items = document.querySelectorAll('.socio-item');
                if(items.length > 1){
                    this.closest('.socio-item').remove();
                    socioCountInput.value = document.querySelectorAll('.socio-item').length;
                } else {
                    alert('Mantenha pelo menos um bloco (pode ficar em branco).');
                }
            }
        });
    }
    bindRemoveSocios();
    if(addSocioBtn){
        addSocioBtn.addEventListener('click', function(){
            let current = parseInt(socioCountInput.value || '0');
            const newIndex = current + 1;
            const socioHTML = `
            <div class=\"socio-item border border-border rounded-md p-4 space-y-4\">
                <div class=\"grid grid-cols-1 md:grid-cols-5 gap-4\">
                    <div>
                        <label class=\"block text-sm font-medium text-foreground mb-2\">Sócio Existente</label>
                        <select name=\"existing_socio_${newIndex}\" class=\"input\">
                            <option value=\"\">-- Selecionar --</option>
                            {% for s in socios_existentes %}
                                <option value=\"{{ s.id }}\">{{ s.nome }} ({{ s.cpf }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class=\"md:col-span-2\">
                        <label class=\"block text-sm font-medium text-foreground mb-2\">Nome Novo</label>
                        <input type=\"text\" name=\"nome_novo_${newIndex}\" placeholder=\"Cadastrar novo\" class=\"input\" />
                    </div>
                    <div>
                        <label class=\"block text-sm font-medium text-foreground mb-2\">CPF Novo</label>
                        <input type=\"text\" name=\"cpf_novo_${newIndex}\" placeholder=\"Somente dígitos\" class=\"input\" />
                    </div>
                    <div>
                        <label class=\"block text-sm font-medium text-foreground mb-2\">Percentual (%)</label>
                        <input type=\"text\" name=\"percentual_${newIndex}\" placeholder=\"Opcional\" class=\"input\" />
                    </div>
                </div>
                <div>
                    <button type=\"button\" class=\"btn-remove-socio inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-2 text-xs font-medium text-foreground transition-colors hover:bg-destructive hover:text-destructive-foreground\"><i class=\"bi bi-trash mr-1\"></i>Remover</button>
                </div>
            </div>`;
            sociosContainer.insertAdjacentHTML('beforeend', socioHTML);
            socioCountInput.value = newIndex;
            bindRemoveSocios();
        });
    }
});

function applyMasks(container) {
    // CNPJ Mask
    const cnpjField = container.querySelector('input[data-mask="cnpj"]');
    if (cnpjField) {
        IMask(cnpjField, {
            mask: '00.000.000/0000-00'
        });
    }

    // Phone masks
    const phoneFields = container.querySelectorAll('input[name$="telefone"]');
    phoneFields.forEach(field => {
        IMask(field, {
            mask: [
                { mask: '(00) 0000-0000' },
                { mask: '(00) 00000-0000' }
            ]
        });
    });
}

// Initialize contact form index from management form
let contactFormIndex = parseInt('{{ contato_formset.total_form_count|default:0 }}', 10);

function addContactForm() {
    const contactForms = document.getElementById('contato-forms');
    const managementForm = contactForms.querySelector('input[name$="TOTAL_FORMS"]');
    
    // Clone the first contact form
    const firstForm = contactForms.querySelector('.contact-form');
    if(!firstForm){
        console.error('No base contact form found.');
        return;
    }
    const newForm = firstForm.cloneNode(true);
    
    // Clear field values
    const inputs = newForm.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.type !== 'hidden') {
            input.value = '';
        }
        // Update name and id with new index
        if (input.name) {
            input.name = input.name.replace(/form-\d+/, `form-${contactFormIndex}`);
        }
        if (input.id) {
            input.id = input.id.replace(/form-\d+/, `form-${contactFormIndex}`);
        }
    });
    
    // Update data-form-index
    newForm.setAttribute('data-form-index', contactFormIndex);
    
    // Add remove button if it doesn't exist
    if (!newForm.querySelector('.btn-remove-contact')) {
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'float-right inline-flex items-center justify-center rounded-md border border-input bg-background px-3 py-2 text-xs font-medium text-foreground transition-colors hover:bg-destructive hover:text-destructive-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring btn-remove-contact';
        removeBtn.onclick = function() { removeContactForm(this); };
        removeBtn.innerHTML = '<i class="bi bi-x mr-1"></i>Remover';
        newForm.querySelector('.card-content').appendChild(removeBtn);
    }
    
    // Add new form
    contactForms.appendChild(newForm);

    // Apply mask to the new phone field
    applyMasks(newForm);
    
    // Increment counters
    contactFormIndex++;
    managementForm.value = parseInt(managementForm.value) + 1;
}

function removeContactForm(button) {
// ... (o resto da função continua igual)
    const contactForm = button.closest('.contact-form');
    const contactForms = document.getElementById('contato-forms');
    const managementForm = contactForms.querySelector('input[name$="TOTAL_FORMS"]');
    
    // Don't allow removing if it's the only form
    if (contactForms.querySelectorAll('.contact-form').length <= 1) {
        alert('Pelo menos um contato é obrigatório.');
        return;
    }
    
    contactForm.remove();
    
    // Update counter
    managementForm.value = parseInt(managementForm.value) - 1;
    
    // Renumber remaining forms
    renumberContactForms();
}

function renumberContactForms() {
// ... (o resto da função continua igual)
    const contactForms = document.querySelectorAll('.contact-form');
    contactForms.forEach((form, index) => {
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.name) {
                input.name = input.name.replace(/form-\d+/, `form-${index}`);
            }
            if (input.id) {
                input.id = input.id.replace(/form-\d+/, `form-${index}`);
            }
        });
        form.setAttribute('data-form-index', index);
    });
}

// Form validation
document.getElementById('clienteForm').addEventListener('submit', function(e) {
// ... (o resto da função continua igual)
    const parceiro = document.getElementById('id_parceiro').value;
    if (!parceiro) {
        e.preventDefault();
        alert('Selecione o parceiro.');
        return false;
    }
    
    // Validate at least one contact is filled
    const contactForms = document.querySelectorAll('.contact-form');
    let hasValidContact = false;
    
    contactForms.forEach(form => {
        const telefone = form.querySelector('input[name$="telefone"]').value;
        const email = form.querySelector('input[name$="email"]').value;
        
        if (telefone.trim() || email.trim()) {
            hasValidContact = true;
        }
    });
    
    if (!hasValidContact) {
        e.preventDefault();
        alert('Por favor, preencha pelo menos um telefone ou e-mail de contato.');
        return false;
    }
});
</script>
{% endblock %}
